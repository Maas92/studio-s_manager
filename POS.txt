================================================================================
FILE: ./frontend/src/modules/POS\api.ts
================================================================================

import { createResourceClient } from "../../services/resourceFactory";
import api from "../../services/api";
import { z } from "zod";
import {
  AppointmentSchema,
  CreateAppointmentSchema,
  ProductSchema,
  TreatmentSchema,
  StaffSchema,
  CartItemSchema,
  ClientSchema,
  CreateClientSchema,
  CreateTransactionSchema,
  DraftSaleSchema,
  TransactionSchema,
  type StaffConflict,
  type Client,
  type Appointment,
  type CreateAppointmentInput,
  type CreateClientInput,
  type CreateTransactionInput,
  type CartItem,
  type CartValidation,
  type Discount,
  type DiscountValidation,
  type DraftSale,
  type PaymentBreakdown,
  type PaymentValidation,
  type Product,
  type Staff,
  type Transaction,
  type Treatment,
} from "./POSSchema";

// ============================================================================
// RESOURCE CLIENTS
// ============================================================================

export const appointmentsApi = createResourceClient<
  Appointment,
  CreateAppointmentInput
>({
  basePath: "/appointments",
  schema: AppointmentSchema,
  createSchema: CreateAppointmentSchema,
});

export const clientsApi = createResourceClient<Client, CreateClientInput>({
  basePath: "/clients",
  schema: ClientSchema,
  createSchema: CreateClientSchema,
});

export const productsApi = createResourceClient<Product, Partial<Product>>({
  basePath: "/products",
  schema: ProductSchema,
});

export const treatmentsApi = createResourceClient<
  Treatment,
  Partial<Treatment>
>({
  basePath: "/treatments",
  schema: TreatmentSchema,
});

export const staffApi = createResourceClient<Staff, Partial<Staff>>({
  basePath: "/staff",
  schema: StaffSchema,
});

export const transactionsApi = createResourceClient<
  Transaction,
  CreateTransactionInput
>({
  basePath: "/transactions",
  schema: TransactionSchema,
  createSchema: CreateTransactionSchema,
});

// ============================================================================
// APPOINTMENT FUNCTIONS
// ============================================================================

/**
 * Get today's appointments for POS check-in
 */
export async function getTodaysAppointments(): Promise<Appointment[]> {
  try {
    const today = new Date().toISOString().split("T")[0];
    const { data } = await api.get(
      `/appointments?date=${today}&status=confirmed`
    );
    const appointments = Array.isArray(data) ? data : [data];
    return appointments.map((apt) => AppointmentSchema.parse(apt));
  } catch (error) {
    console.error("Failed to fetch today's appointments:", error);
    throw new Error("Unable to load appointments. Please try again.");
  }
}

/**
 * Mark appointment as completed
 */
export async function completeAppointment(
  appointmentId: string
): Promise<void> {
  try {
    await appointmentsApi.update(appointmentId, {
      status: "completed",
      completedAt: new Date().toISOString(),
    } as any);
  } catch (error) {
    console.error("Failed to mark appointment as completed:", error);
    throw new Error("Unable to complete appointment.");
  }
}

// ============================================================================
// PRODUCT & INVENTORY FUNCTIONS
// ============================================================================

/**
 * Get retail products available for sale
 */
export async function getRetailProducts(): Promise<Product[]> {
  try {
    const { data } = await api.get("/products?retail=true");
    const products = Array.isArray(data) ? data : [data];
    return products.map((product) => ProductSchema.parse(product));
  } catch (error) {
    console.error("Failed to fetch retail products:", error);
    throw new Error("Unable to load products. Please try again.");
  }
}

/**
 * Check product stock availability
 */
export async function checkProductStock(productId: string): Promise<number> {
  try {
    const { data } = await api.get(`/products/${productId}/stock`);
    return data.available || 0;
  } catch (error) {
    console.error("Failed to check stock:", error);
    return 0;
  }
}

/**
 * Update stock after a sale
 */
export async function updateStockAfterSale(items: CartItem[]): Promise<void> {
  try {
    const productItems = items.filter((item) => item.type === "product");

    for (const item of productItems) {
      await api.patch(`/products/${item.productId}/stock`, {
        quantity: -item.quantity,
        location: "retail",
        reason: "sale",
      });
    }
  } catch (error) {
    console.error("Failed to update stock:", error);
    throw new Error("Stock update failed. Please check inventory manually.");
  }
}

// ============================================================================
// TREATMENT FUNCTIONS
// ============================================================================

/**
 * Get available treatments
 */
export async function getAvailableTreatments(): Promise<Treatment[]> {
  try {
    const { data } = await api.get("/treatments?isActive=true");
    const treatments = Array.isArray(data) ? data : [data];
    return treatments.map((treatment) => TreatmentSchema.parse(treatment));
  } catch (error) {
    console.error("Failed to fetch treatments:", error);
    throw new Error("Unable to load treatments. Please try again.");
  }
}

// ============================================================================
// STAFF FUNCTIONS
// ============================================================================

/**
 * Get available staff members with optional date filtering
 */
export async function getAvailableStaff(date?: string): Promise<Staff[]> {
  try {
    const params = date ? `?date=${date}` : "";
    const { data } = await api.get(`/staff${params}`);
    const staff = Array.isArray(data) ? data : [data];
    return staff.map((member) => StaffSchema.parse(member));
  } catch (error) {
    console.error("Failed to fetch staff:", error);
    throw new Error("Unable to load staff members. Please try again.");
  }
}

/**
 * Check for staff conflicts/availability
 */
export async function checkStaffConflicts(
  staffId: string,
  startTime: string,
  duration: number
): Promise<boolean> {
  try {
    const { data } = await api.get(
      `/staff/${staffId}/availability?start=${startTime}&duration=${duration}`
    );
    return data.available || false;
  } catch (error) {
    console.error("Failed to check staff availability:", error);
    return false;
  }
}

/**
 * Detect staff conflicts in cart
 */
export function detectStaffConflicts(cart: CartItem[]): StaffConflict[] {
  const conflicts: StaffConflict[] = [];
  const staffMap = new Map<string, CartItem[]>();

  // Group treatments by staff
  cart
    .filter(
      (item) =>
        (item.type === "treatment" || item.type === "appointment") &&
        item.staffId
    )
    .forEach((item) => {
      if (!staffMap.has(item.staffId!)) {
        staffMap.set(item.staffId!, []);
      }
      staffMap.get(item.staffId!)!.push(item);
    });

  // Check if same staff assigned multiple times
  staffMap.forEach((items, staffId) => {
    if (items.length > 1) {
      const staffName = items[0].staffName || "Unknown";
      conflicts.push({
        staffId,
        staffName,
        conflictingItems: items.map((i) => i.name),
        overlappingTime: true,
      });
    }
  });

  return conflicts;
}

// ============================================================================
// CLIENT FUNCTIONS
// ============================================================================

/**
 * Verify client by phone or email
 */
export async function verifyClient(
  identifier: string,
  type: "phone" | "email"
): Promise<Client> {
  try {
    const { data } = await api.get(`/clients/verify?${type}=${identifier}`);
    return ClientSchema.parse(data);
  } catch (error) {
    console.error("Failed to verify client:", error);
    throw new Error("Unable to verify client. Please try again.");
  }
}

// ============================================================================
// CALCULATION FUNCTIONS
// ============================================================================

/**
 * Calculate loyalty points earned from a purchase
 * Rule: $1 = 10 points
 */
export function calculateLoyaltyPoints(total: number): number {
  return Math.floor(total * 10);
}

/**
 * Calculate monetary value of loyalty points
 * Rule: 100 points = $1
 */
export function calculateLoyaltyValue(points: number): number {
  return points / 100;
}

// ============================================================================
// VALIDATION FUNCTIONS
// ============================================================================

/**
 * Validate discount application
 */
export function validateDiscount(
  discount: Discount,
  subtotal: number,
  maxDiscountPercent: number = 100
): DiscountValidation {
  if (discount.type === "percentage") {
    if (discount.value < 0 || discount.value > maxDiscountPercent) {
      return {
        valid: false,
        error: `Discount must be between 0% and ${maxDiscountPercent}%`,
      };
    }
  }

  if (discount.type === "fixed") {
    if (discount.value < 0) {
      return { valid: false, error: "Discount cannot be negative" };
    }
    if (discount.value > subtotal) {
      return {
        valid: false,
        error: "Discount cannot exceed subtotal",
      };
    }
  }

  // Large discounts (>50%) require reason
  const discountAmount =
    discount.type === "percentage"
      ? (subtotal * discount.value) / 100
      : discount.value;

  if (discountAmount > subtotal * 0.5 && !discount.reason) {
    return {
      valid: false,
      error: "Large discounts require a reason",
    };
  }

  return { valid: true };
}

/**
 * Validate payment amounts
 */
export function validatePayment(
  payments: PaymentBreakdown[],
  total: number,
  cashReceived?: number
): PaymentValidation {
  const errors: string[] = [];
  const warnings: string[] = [];

  const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

  if (totalPaid < total - 0.01) {
    errors.push(
      `Insufficient payment: $${(total - totalPaid).toFixed(2)} remaining`
    );
  }

  const cashPayment = payments.find((p) => p.method === "cash");
  if (cashPayment && (!cashReceived || cashReceived < cashPayment.amount)) {
    errors.push("Cash received must cover cash payment amount");
  }

  if (totalPaid > total + 0.01) {
    warnings.push(
      `Overpayment of $${(totalPaid - total).toFixed(2)} will be refunded`
    );
  }

  return {
    valid: errors.length === 0,
    errors,
    warnings,
  };
}

/**
 * Validate adding item to cart
 */
export function validateAddToCart(
  item: Omit<CartItem, "quantity">,
  currentCart: CartItem[],
  productStock: Record<string, number>
): CartValidation {
  // Only appointments cannot be duplicated
  if (item.type === "appointment") {
    const exists = currentCart.find(
      (i) => i.id === item.id && i.type === item.type
    );
    if (exists) {
      return {
        canAdd: false,
        reason: "This appointment is already in the cart",
      };
    }
  }

  // Check stock for products
  if (item.type === "product") {
    const stock = productStock[item.id] || 0;
    const inCart = currentCart
      .filter((i) => i.id === item.id && i.type === "product")
      .reduce((sum, i) => sum + i.quantity, 0);

    if (stock <= 0) {
      return {
        canAdd: false,
        reason: "Out of stock",
      };
    }

    if (stock <= inCart) {
      return {
        canAdd: false,
        reason: "Insufficient stock",
      };
    }

    const warnings = [];
    if (stock - inCart <= 5) {
      warnings.push(`Only ${stock - inCart} left in stock`);
    }

    return { canAdd: true, warnings };
  }

  // Treatments can be added multiple times
  return { canAdd: true };
}

// ============================================================================
// TRANSACTION FUNCTIONS
// ============================================================================

/**
 * Create a transaction (complete a sale)
 */
export async function createTransaction(
  input: CreateTransactionInput
): Promise<Transaction> {
  try {
    const validatedInput = CreateTransactionSchema.parse(input);

    // Calculate totals
    const subtotal = validatedInput.items.reduce(
      (sum, item) => sum + item.price * item.quantity,
      0
    );

    const discountAmount =
      validatedInput.discount.type === "percentage"
        ? (subtotal * validatedInput.discount.value) / 100
        : validatedInput.discount.value;

    const afterDiscount = Math.max(0, subtotal - discountAmount);
    const tax = afterDiscount * 0.15; // 15% tax

    const tipsTotal = Object.values(validatedInput.tips || {}).reduce(
      (sum, tip) => sum + tip,
      0
    );

    const total = afterDiscount + tax + tipsTotal;

    const loyaltyPointsEarned = calculateLoyaltyPoints(total);

    // Determine primary payment method for display
    const primaryPaymentMethod =
      validatedInput.payments.length === 1
        ? validatedInput.payments[0].method
        : "split";

    const transactionData = {
      ...validatedInput,
      subtotal,
      discountAmount,
      tax,
      tipsTotal,
      total,
      loyaltyPointsEarned,
      loyaltyPointsRedeemed: validatedInput.loyaltyPointsRedeemed || 0,
      paymentMethod: primaryPaymentMethod,
      status: "completed" as const,
      createdAt: new Date().toISOString(),
      createdBy: "current-user", // Replace with actual user ID
    };

    return await transactionsApi.create(transactionData as any);
  } catch (error) {
    if (error instanceof z.ZodError) {
      throw new Error(`Validation error: ${error.issues[0]?.message}`);
    }
    console.error("Failed to create transaction:", error);
    throw new Error("Unable to complete transaction. Please try again.");
  }
}

// ============================================================================
// RECEIPT FUNCTIONS
// ============================================================================

/**
 * Send receipt via email or SMS
 */
export async function sendReceipt(
  transactionId: string,
  method: "email" | "sms",
  recipient: string
): Promise<void> {
  try {
    await api.post(`/transactions/${transactionId}/receipt`, {
      method,
      recipient,
    });
  } catch (error) {
    console.error("Failed to send receipt:", error);
    throw new Error(`Unable to send receipt via ${method}. Please try again.`);
  }
}

/**
 * Print receipt (trigger browser print or send to printer)
 */
export async function printReceipt(transactionId: string): Promise<void> {
  try {
    const { data } = await api.get(`/transactions/${transactionId}/receipt`, {
      responseType: "blob",
    });

    // Create blob URL and trigger print
    const blob = new Blob([data], { type: "application/pdf" });
    const url = window.URL.createObjectURL(blob);
    const printWindow = window.open(url, "_blank");
    if (printWindow) {
      printWindow.onload = () => {
        printWindow.print();
      };
    }
  } catch (error) {
    console.error("Failed to print receipt:", error);
    throw new Error("Unable to print receipt. Please try again.");
  }
}

// ============================================================================
// DRAFT MANAGEMENT FUNCTIONS
// ============================================================================

/**
 * Save draft sale to localStorage
 */
export function saveDraft(draft: DraftSale): void {
  try {
    const validatedDraft = DraftSaleSchema.parse(draft);
    localStorage.setItem("pos_draft", JSON.stringify(validatedDraft));
  } catch (error) {
    console.error("Failed to save draft:", error);
  }
}

/**
 * Load draft sale from localStorage
 */
export function loadDraft(): DraftSale | null {
  try {
    const draft = localStorage.getItem("pos_draft");
    if (!draft) return null;

    const parsed = JSON.parse(draft);

    // Check if draft has expired
    if (new Date(parsed.expiresAt) < new Date()) {
      localStorage.removeItem("pos_draft");
      return null;
    }

    return DraftSaleSchema.parse(parsed);
  } catch (error) {
    console.error("Failed to load draft:", error);
    return null;
  }
}

/**
 * Clear draft sale from localStorage
 */
export function clearDraft(): void {
  try {
    localStorage.removeItem("pos_draft");
  } catch (error) {
    console.error("Failed to clear draft:", error);
  }
}

// ============================================================================
// CONVENIENCE EXPORTS
// ============================================================================

// Re-export resource client methods for convenience
export const {
  list: listAppointments,
  get: getAppointment,
  create: createAppointment,
  update: updateAppointment,
  delete: deleteAppointment,
} = appointmentsApi;

export const {
  list: listClients,
  get: getClient,
  create: createClient,
  update: updateClient,
  delete: deleteClient,
} = clientsApi;

export const {
  list: listProducts,
  get: getProduct,
  create: createProduct,
  update: updateProduct,
  delete: deleteProduct,
} = productsApi;

export const {
  list: listTreatments,
  get: getTreatment,
  create: createTreatment,
  update: updateTreatment,
  delete: deleteTreatment,
} = treatmentsApi;

export const {
  list: listStaff,
  get: getStaff,
  create: createStaff,
  update: updateStaff,
  delete: deleteStaff,
} = staffApi;

export const {
  list: listTransactions,
  get: getTransaction,
  update: updateTransaction,
  delete: deleteTransaction,
} = transactionsApi;

// ============================================================================
// DEFAULT EXPORT
// ============================================================================

export default {
  // Resource clients
  appointmentsApi,
  clientsApi,
  productsApi,
  treatmentsApi,
  staffApi,
  transactionsApi,

  // Appointments
  getTodaysAppointments,
  createAppointment,
  completeAppointment,
  listAppointments,
  getAppointment,
  updateAppointment,
  deleteAppointment,

  // Products
  getRetailProducts,
  checkProductStock,
  updateStockAfterSale,
  listProducts,
  getProduct,
  createProduct,
  updateProduct,
  deleteProduct,

  // Treatments
  getAvailableTreatments,
  listTreatments,
  getTreatment,
  createTreatment,
  updateTreatment,
  deleteTreatment,

  // Staff
  getAvailableStaff,
  checkStaffConflicts,
  detectStaffConflicts,
  listStaff,
  getStaff,
  createStaff,
  updateStaff,
  deleteStaff,

  // Clients
  verifyClient,
  createClient,
  listClients,
  getClient,
  updateClient,
  deleteClient,

  // Calculations
  calculateLoyaltyPoints,
  calculateLoyaltyValue,

  // Validations
  validateDiscount,
  validatePayment,
  validateAddToCart,

  // Transactions
  createTransaction,
  listTransactions,
  getTransaction,
  updateTransaction,
  deleteTransaction,

  // Receipts
  sendReceipt,
  printReceipt,

  // Drafts
  saveDraft,
  loadDraft,
  clearDraft,
};


================================================================================
FILE: ./frontend/src/modules/POS\CheckoutModal.tsx
================================================================================

import React, { useState, useMemo, useCallback } from "react";
import Modal from "../../ui/components/Modal";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import styled from "styled-components";
import { Check, AlertCircle } from "lucide-react";

const Content = styled.div`
  display: grid;
  gap: 1rem;
`;
const TotalDisplay = styled.div`
  background: ${({ theme }) => theme.color.brand50};
  padding: 1rem;
  border-radius: ${({ theme }) => theme.radii.md};
  text-align: center;
  border: 1px solid ${({ theme }) => theme.color.brand200};
`;
const TotalAmount = styled.div`
  font-size: 2rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.brand600};
`;
const PaymentGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
`;
const MethodBtn = styled.button<{ $active?: boolean }>`
  padding: 0.75rem;
  border-radius: ${({ theme }) => theme.radii.md};
  border: 2px solid
    ${({ $active, theme }) =>
      $active ? theme.color.brand600 : theme.color.border};
  background: ${({ $active, theme }) =>
    $active ? theme.color.brand500 : theme.color.panel};
  color: ${({ $active }) => ($active ? "#fff" : "inherit")};
  cursor: pointer;
`;

export default function CheckoutModal({
  isOpen,
  onClose,
  total,
  onComplete,
  processing = false,
}: {
  isOpen: boolean;
  onClose: () => void;
  total: number;
  onComplete: (payments: any[]) => void;
  processing?: boolean;
}) {
  const [method, setMethod] = useState<"card" | "cash" | "split">("card");
  const [cash, setCash] = useState("");

  const change = useMemo(
    () => Math.max(0, (parseFloat(cash || "0") || 0) - total),
    [cash, total]
  );
  const canComplete = useMemo(
    () => (method === "cash" ? (parseFloat(cash || "0") || 0) >= total : true),
    [method, cash, total]
  );
  const insufficient = useMemo(
    () =>
      method === "cash" &&
      (parseFloat(cash || "0") || 0) > 0 &&
      (parseFloat(cash || "0") || 0) < total,
    [method, cash, total]
  );

  const handleComplete = useCallback(() => {
    if (!canComplete || processing) return;
    onComplete([{ method, amount: total }]);
  }, [canComplete, processing, method, total, onComplete]);

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title="Checkout"
      size="md"
      ariaLabel="Checkout"
    >
      <Content>
        <TotalDisplay>
          <div
            style={{
              fontSize: 12,
              color: "var(--muted)",
              textTransform: "uppercase",
              fontWeight: 700,
            }}
          >
            Total
          </div>
          <TotalAmount>${total.toFixed(2)}</TotalAmount>
        </TotalDisplay>

        <div>
          <div style={{ fontWeight: 700, marginBottom: 8 }}>Payment Method</div>
          <PaymentGrid>
            <MethodBtn
              $active={method === "card"}
              onClick={() => setMethod("card")}
            >
              Card
            </MethodBtn>
            <MethodBtn
              $active={method === "cash"}
              onClick={() => setMethod("cash")}
            >
              Cash
            </MethodBtn>
            <MethodBtn
              $active={method === "split"}
              onClick={() => setMethod("split")}
            >
              Split
            </MethodBtn>
          </PaymentGrid>

          {method === "cash" && (
            <div style={{ marginTop: 8 }}>
              <Input
                type="number"
                value={cash}
                onChange={(e) => setCash(e.target.value)}
                placeholder="Cash received"
              />
              {parseFloat(cash || "0") >= total && (
                <div
                  style={{
                    marginTop: 8,
                    padding: 8,
                    background: "rgba(16,185,129,0.06)",
                    border: `1px solid rgba(16,185,129,0.12)`,
                    borderRadius: 6,
                  }}
                >
                  <strong>Change:</strong> ${change.toFixed(2)}
                </div>
              )}
            </div>
          )}
        </div>

        <div style={{ display: "grid", gap: 8 }}>
          <Button
            variation="primary"
            onClick={handleComplete}
            disabled={!canComplete || processing}
          >
            <Check size={18} style={{ marginRight: 8 }} />
            {processing ? "Processing..." : "Complete Payment"}
          </Button>
          {insufficient && (
            <div
              style={{
                display: "flex",
                gap: 8,
                alignItems: "center",
                color: "var(--red500)",
              }}
            >
              <AlertCircle /> Insufficient cash
            </div>
          )}
        </div>
      </Content>
    </Modal>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\ClientSelection.tsx
================================================================================

import React, { useState, useMemo } from "react";
import styled from "styled-components";
import { Calendar, User, UserPlus, Check } from "lucide-react";

import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import Card from "../../ui/components/Card";
import EmptyState from "../../ui/components/EmptyState";

const Container = styled.div`
  display: grid;
  gap: 1.5rem;
  max-width: 1100px;
  margin: 0 auto;
`;
const Row = styled.div`
  display: flex;
  gap: 1rem;
  align-items: center;
`;
const TypeRow = styled.div`
  display: flex;
  gap: 1rem;
`;
const TypeCard = styled(Card)<{ $selected?: boolean }>`
  flex: 1;
  padding: 1rem;
  text-align: center;
  cursor: pointer;
  border: 2px solid
    ${({ $selected, theme }) =>
      $selected ? theme.color.brand500 : theme.color.border};
  background: ${({ $selected, theme }) =>
    $selected ? theme.color.brand50 : theme.color.panel};
`;
const ItemList = styled.div`
  display: grid;
  gap: 0.5rem;
  max-height: 420px;
  overflow: auto;
`;

export default function ClientSelection({
  clients,
  appointments,
  onSelectClient,
  onCreateNew,
}: {
  clients: Array<any>;
  appointments: Array<any>;
  onSelectClient: (
    clientId: string,
    clientType: "booked" | "walk-in",
    appointmentId?: string
  ) => void;
  onCreateNew: () => void;
}) {
  const [mode, setMode] = useState<"booked" | "walk-in">("booked");
  const [q, setQ] = useState("");
  const [selectedAppointmentId, setSelectedAppointmentId] = useState<
    string | null
  >(null);
  const [selectedClientId, setSelectedClientId] = useState<string | null>(null);

  const filteredAppointments = useMemo(() => {
    if (!q.trim()) return appointments;
    const s = q.toLowerCase();
    return appointments.filter(
      (a) =>
        (a.clientName || "").toLowerCase().includes(s) ||
        (a.treatmentName || "").toLowerCase().includes(s)
    );
  }, [appointments, q]);

  const filteredClients = useMemo(() => {
    if (!q.trim()) return clients;
    const s = q.toLowerCase();
    return clients.filter(
      (c) =>
        (c.name || "").toLowerCase().includes(s) ||
        (c.email || "").toLowerCase().includes(s) ||
        (c.phone || "").includes(s)
    );
  }, [clients, q]);

  return (
    <Container>
      <div>
        <h2 style={{ margin: 0 }}>Select client</h2>
        <p style={{ margin: 0, color: "var(--muted)" }}>
          Choose a booked appointment or a walk-in client
        </p>
      </div>

      <TypeRow>
        <TypeCard
          $selected={mode === "booked"}
          onClick={() => {
            setMode("booked");
            setSelectedAppointmentId(null);
            setSelectedClientId(null);
          }}
        >
          <div style={{ display: "grid", placeItems: "center", gap: 8 }}>
            <Calendar size={34} />
            <div style={{ fontWeight: 700 }}>Booked</div>
            <div style={{ fontSize: 12, color: "var(--muted)" }}>
              Select today's appointment
            </div>
          </div>
        </TypeCard>

        <TypeCard
          $selected={mode === "walk-in"}
          onClick={() => {
            setMode("walk-in");
            setSelectedAppointmentId(null);
            setSelectedClientId(null);
          }}
        >
          <div style={{ display: "grid", placeItems: "center", gap: 8 }}>
            <User size={34} />
            <div style={{ fontWeight: 700 }}>Walk-in</div>
            <div style={{ fontSize: 12, color: "var(--muted)" }}>
              Search or create a client
            </div>
          </div>
        </TypeCard>
      </TypeRow>

      <Input
        value={q}
        onChange={(e) => setQ(e.target.value)}
        placeholder="Search clients, appointments or treatments..."
      />

      {mode === "booked" ? (
        <div>
          <ItemList>
            {filteredAppointments.length === 0 ? (
              <EmptyState
                title={q ? "No appointments found" : "No appointments today"}
              />
            ) : (
              filteredAppointments.map((apt) => (
                <button
                  key={apt.id}
                  onClick={() => {
                    setSelectedAppointmentId(apt.id);
                    setSelectedClientId(apt.clientId);
                  }}
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    padding: 12,
                    borderRadius: 8,
                    border: `1px solid ${
                      selectedAppointmentId === apt.id
                        ? "var(--brand500)"
                        : "var(--border)"
                    }`,
                    background:
                      selectedAppointmentId === apt.id
                        ? "var(--brand50)"
                        : "var(--panel)",
                    cursor: "pointer",
                  }}
                >
                  <div>
                    <div style={{ fontWeight: 700 }}>{apt.clientName}</div>
                    <div style={{ fontSize: 12, color: "var(--muted)" }}>
                      {apt.treatmentName} â€¢ {apt.time}
                    </div>
                  </div>
                  <div style={{ display: "grid", placeItems: "center" }}>
                    <div style={{ fontWeight: 700 }}>
                      ${(apt.price ?? 0).toFixed(2)}
                    </div>
                    {selectedAppointmentId === apt.id && (
                      <div style={{ fontSize: 12, color: "var(--brand700)" }}>
                        Selected
                      </div>
                    )}
                  </div>
                </button>
              ))
            )}
          </ItemList>

          <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
            <Button
              variation="primary"
              onClick={() =>
                selectedAppointmentId &&
                onSelectClient(
                  selectedClientId!,
                  "booked",
                  selectedAppointmentId
                )
              }
            >
              Check in & continue
            </Button>
          </div>
        </div>
      ) : (
        <div>
          <ItemList>
            {filteredClients.length === 0 ? (
              <EmptyState
                title={q ? "No clients found" : "No clients yet"}
                actionText="Create client"
                onAction={onCreateNew}
              />
            ) : (
              filteredClients.map((c) => (
                <button
                  key={c.id}
                  onClick={() => {
                    setSelectedClientId(c.id);
                  }}
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    padding: 12,
                    borderRadius: 8,
                    border: `1px solid ${
                      selectedClientId === c.id
                        ? "var(--brand500)"
                        : "var(--border)"
                    }`,
                    background:
                      selectedClientId === c.id
                        ? "var(--brand50)"
                        : "var(--panel)",
                    cursor: "pointer",
                  }}
                >
                  <div>
                    <div style={{ fontWeight: 700 }}>{c.name}</div>
                    <div style={{ fontSize: 12, color: "var(--muted)" }}>
                      {c.email ?? c.phone ?? "â€”"}
                    </div>
                  </div>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontWeight: 700 }}>
                      {c.loyaltyPoints ?? 0} pts
                    </div>
                    {selectedClientId === c.id && (
                      <div style={{ fontSize: 12, color: "var(--brand700)" }}>
                        Selected
                      </div>
                    )}
                  </div>
                </button>
              ))
            )}
          </ItemList>

          <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
            <Button
              variation="secondary"
              onClick={onCreateNew}
              icon={<UserPlus />}
            >
              Create New
            </Button>
            <Button
              variation="primary"
              onClick={() =>
                selectedClientId && onSelectClient(selectedClientId, "walk-in")
              }
            >
              Verify & continue
            </Button>
          </div>
        </div>
      )}
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\CreateClientModal.tsx
================================================================================

import React, { useState, useCallback } from "react";
import Modal from "../../ui/components/Modal";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import styled from "styled-components";
import { UserPlus, AlertCircle } from "lucide-react";

const Content = styled.div`
  display: grid;
  gap: 1rem;
`;
const Info = styled.div`
  font-size: 0.9rem;
  color: ${({ theme }) => theme.color.mutedText};
  background: ${({ theme }) => theme.color.brand50};
  padding: 0.75rem;
  border-radius: ${({ theme }) => theme.radii.md};
`;

export default function CreateClientModal({
  isOpen,
  onClose,
  onSubmit,
  submitting = false,
}: {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (payload: { name: string; phone?: string; email?: string }) => void;
  submitting?: boolean;
}) {
  const [form, setForm] = useState({ name: "", phone: "", email: "" });
  const [errors, setErrors] = useState<Record<string, string>>({});

  const validate = useCallback(() => {
    const e: Record<string, string> = {};
    if (!form.name.trim()) e.name = "Name required";
    if (form.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.email))
      e.email = "Invalid email";
    if (form.phone && !/^[\d+\-\s()]+$/.test(form.phone))
      e.phone = "Invalid phone";
    setErrors(e);
    return Object.keys(e).length === 0;
  }, [form]);

  const submit = useCallback(() => {
    if (!validate()) return;
    onSubmit(form);
  }, [validate, onSubmit, form]);

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Create Client" size="md">
      <Content>
        <Info>
          Create a client profile to track appointments, purchases and loyalty.
        </Info>

        <div>
          <label style={{ fontWeight: 700 }}>Full name</label>
          <Input
            value={form.name}
            onChange={(e) => setForm((f) => ({ ...f, name: e.target.value }))}
            autoFocus
          />
          {errors.name && (
            <div
              style={{
                color: "var(--red500)",
                display: "flex",
                gap: 6,
                alignItems: "center",
              }}
            >
              <AlertCircle />
              {errors.name}
            </div>
          )}
        </div>

        <div>
          <label style={{ fontWeight: 700 }}>Phone</label>
          <Input
            value={form.phone}
            onChange={(e) => setForm((f) => ({ ...f, phone: e.target.value }))}
          />
          {errors.phone && (
            <div
              style={{
                color: "var(--red500)",
                display: "flex",
                gap: 6,
                alignItems: "center",
              }}
            >
              <AlertCircle />
              {errors.phone}
            </div>
          )}
        </div>

        <div>
          <label style={{ fontWeight: 700 }}>Email</label>
          <Input
            value={form.email}
            onChange={(e) => setForm((f) => ({ ...f, email: e.target.value }))}
          />
          {errors.email && (
            <div
              style={{
                color: "var(--red500)",
                display: "flex",
                gap: 6,
                alignItems: "center",
              }}
            >
              <AlertCircle />
              {errors.email}
            </div>
          )}
        </div>

        <div style={{ display: "flex", gap: 8 }}>
          <Button variation="secondary" onClick={onClose}>
            Cancel
          </Button>
          <Button
            variation="primary"
            onClick={submit}
            disabled={submitting || !form.name.trim()}
          >
            <UserPlus size={18} style={{ marginRight: 8 }} />
            {submitting ? "Creating..." : "Create client"}
          </Button>
        </div>
      </Content>
    </Modal>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\ItemSelection.tsx
================================================================================

import React, { useState, useMemo } from "react";
import styled from "styled-components";
import { Plus, Minus, Trash2, Package, Clock } from "lucide-react";

import Card from "../../ui/components/Card";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import EmptyState from "../../ui/components/EmptyState";

const Container = styled.div`
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 1.5rem;
  max-width: 1200px;
  margin: 0 auto;
  @media (max-width: 1024px) {
    grid-template-columns: 1fr;
  }
`;

const Left = styled.div`
  display: grid;
  gap: 1rem;
`;
const Right = styled.div`
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  padding: 1rem;
  border-radius: ${({ theme }) => theme.radii.lg};
  position: sticky;
  top: 1rem;
  height: fit-content;
`;

const Tabs = styled.div`
  display: flex;
  gap: 0.5rem;
`;
const Tab = styled.button<{ $active?: boolean }>`
  flex: 1;
  padding: 0.75rem;
  border: none;
  background: transparent;
  border-bottom: 2px solid
    ${({ $active, theme }) => ($active ? theme.color.brand500 : "transparent")};
  cursor: pointer;
`;
const Grid = styled.div`
  display: grid;
  gap: 0.75rem;
  grid-template-columns: repeat(2, 1fr);
`;

const ItemButton = styled.button<{ $disabled?: boolean; $inCart?: boolean }>`
  padding: 1rem;
  border-radius: ${({ theme }) => theme.radii.md};
  text-align: left;
  border: 1px solid
    ${({ theme, $inCart }) =>
      $inCart ? theme.color.green500 : theme.color.border};
  background: ${({ theme, $inCart }) =>
    $inCart ? theme.color.green500 + "12" : theme.color.panel};
  cursor: pointer;
  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
`;

export default function ItemSelection({
  clientType,
  clientName,
  appointments,
  treatments,
  stockItems,
  cart,
  productStock,
  onAddToCart,
  onUpdateQuantity,
  onRemoveFromCart,
  onUpdateNotes,
  onNext,
  onBack,
}: {
  clientType: "booked" | "walk-in";
  clientName?: string;
  appointments: any[];
  treatments: any[];
  stockItems: any[]; // <-- replaced 'products' with 'stockItems'
  cart: any[];
  productStock: Record<string, number>;
  onAddToCart: (item: any) => void;
  onUpdateQuantity: (id: string, type: string, delta: number) => void;
  onRemoveFromCart: (id: string, type: string) => void;
  onUpdateNotes: (id: string, type: string, notes: string) => void;
  onNext: () => void;
  onBack: () => void;
}) {
  const [active, setActive] = useState<
    "appointments" | "treatments" | "products"
  >(clientType === "booked" ? "appointments" : "treatments");
  const [q, setQ] = useState("");

  const filteredAppointments = useMemo(
    () =>
      appointments.filter(
        (a) =>
          (a.clientName || "").toLowerCase().includes(q.toLowerCase()) ||
          (a.treatmentName || "").toLowerCase().includes(q.toLowerCase())
      ),
    [appointments, q]
  );
  const filteredTreatments = useMemo(
    () =>
      treatments.filter(
        (t) =>
          (t.name || "").toLowerCase().includes(q.toLowerCase()) ||
          (t.category || "" || "").toLowerCase().includes(q.toLowerCase())
      ),
    [treatments, q]
  );
  const filteredStock = useMemo(
    () =>
      stockItems.filter(
        (p) =>
          (p.name || "").toLowerCase().includes(q.toLowerCase()) ||
          (p.category || "" || "").toLowerCase().includes(q.toLowerCase())
      ),
    [stockItems, q]
  );

  const isInCart = (id: string, type: string) =>
    cart.some((i) => i.id === id && i.type === type);

  const productStatus = (id: string) => {
    const stock = productStock[id] ?? 0;
    const inCartQty = cart
      .filter((i) => (i.productId ?? i.id) === id && i.type === "product")
      .reduce((s, i) => s + i.quantity, 0);
    const available = Math.max(0, stock - inCartQty);
    return {
      available,
      status: available <= 0 ? "out" : available <= 5 ? "low" : "ok",
    };
  };

  return (
    <Container>
      <Left>
        <div
          style={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
          }}
        >
          <div>
            <h2 style={{ margin: 0 }}>Add items to cart</h2>
            {clientName && (
              <div style={{ fontSize: 12, color: "var(--muted)" }}>
                Client: {clientName}
              </div>
            )}
          </div>
        </div>

        <Input
          value={q}
          onChange={(e) => setQ(e.target.value)}
          placeholder="Search items..."
        />

        <Tabs>
          {clientType === "booked" && (
            <Tab
              $active={active === "appointments"}
              onClick={() => setActive("appointments")}
            >
              Appointments
            </Tab>
          )}
          <Tab
            $active={active === "treatments"}
            onClick={() => setActive("treatments")}
          >
            Treatments
          </Tab>
          <Tab
            $active={active === "products"}
            onClick={() => setActive("products")}
          >
            Products
          </Tab>
        </Tabs>

        <div style={{ maxHeight: 520, overflow: "auto" }}>
          {active === "appointments" && (
            <Grid>
              {filteredAppointments.map((apt) => (
                <ItemButton
                  key={apt.id}
                  $inCart={isInCart(apt.id, "appointment")}
                  disabled={isInCart(apt.id, "appointment")}
                  onClick={() =>
                    onAddToCart({
                      ...apt,
                      type: "appointment",
                      name: apt.treatmentName,
                      price: apt.price,
                      quantity: 1,
                    })
                  }
                >
                  <div style={{ fontWeight: 700 }}>{apt.treatmentName}</div>
                  <div style={{ fontSize: 12, color: "var(--muted)" }}>
                    {apt.clientName} â€¢ {apt.time}
                  </div>
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      marginTop: 8,
                    }}
                  >
                    <div>${(apt.price || 0).toFixed(2)}</div>
                    {isInCart(apt.id, "appointment") ? (
                      <div style={{ color: "var(--green500)" }}>In cart</div>
                    ) : (
                      <Plus />
                    )}
                  </div>
                </ItemButton>
              ))}
            </Grid>
          )}

          {active === "treatments" && (
            <Grid>
              {filteredTreatments.map((t) => (
                <ItemButton
                  key={t.id}
                  onClick={() =>
                    onAddToCart({
                      ...t,
                      type: "treatment",
                      name: t.name,
                      price: t.price,
                      quantity: 1,
                    })
                  }
                >
                  <div style={{ fontWeight: 700 }}>{t.name}</div>
                  <div style={{ fontSize: 12, color: "var(--muted)" }}>
                    {t.durationMinutes ?? t.duration} min â€¢ {t.category}
                  </div>
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      marginTop: 8,
                    }}
                  >
                    <div>${(t.price || 0).toFixed(2)}</div>
                    <Plus />
                  </div>
                </ItemButton>
              ))}
            </Grid>
          )}

          {active === "products" && (
            <Grid>
              {filteredStock.map((p) => {
                const key = p.productId ?? p.id;
                const status = productStatus(key);
                const canAdd = status.available > 0;
                return (
                  <ItemButton
                    key={p.id}
                    $disabled={!canAdd}
                    disabled={!canAdd}
                    onClick={() =>
                      canAdd &&
                      onAddToCart({
                        ...p,
                        type: "product",
                        name: p.name,
                        price: p.price,
                        productId: key,
                        stockId: p.id,
                        quantity: 1,
                      })
                    }
                  >
                    <div style={{ fontWeight: 700 }}>{p.name}</div>
                    <div style={{ fontSize: 12, color: "var(--muted)" }}>
                      {p.category}
                    </div>
                    <div
                      style={{
                        display: "flex",
                        justifyContent: "space-between",
                        marginTop: 8,
                      }}
                    >
                      <div>${(p.price || 0).toFixed(2)}</div>
                      {!canAdd ? (
                        <div style={{ color: "var(--red500)" }}>Out</div>
                      ) : (
                        <div>{status.available} in stock</div>
                      )}
                    </div>
                  </ItemButton>
                );
              })}
            </Grid>
          )}
        </div>
      </Left>

      <Right>
        <div
          style={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
          }}
        >
          <h3 style={{ margin: 0 }}>Cart</h3>
          <div style={{ fontWeight: 700 }}>{cart.length} items</div>
        </div>

        <div style={{ marginTop: 12 }}>
          {cart.length === 0 ? (
            <EmptyState title="Cart is empty" />
          ) : (
            <div style={{ display: "grid", gap: 8 }}>
              {cart.map((item: any, idx: number) => (
                <Card
                  key={`${item.id}-${item.type}-${idx}`}
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    padding: 12,
                  }}
                >
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 700 }}>{item.name}</div>
                    <div style={{ fontSize: 12, color: "var(--muted)" }}>
                      {item.staffName ?? item.clientName ?? ""}
                    </div>
                  </div>

                  <div
                    style={{ display: "flex", gap: 8, alignItems: "center" }}
                  >
                    {item.type === "product" ? (
                      <div
                        style={{
                          display: "flex",
                          alignItems: "center",
                          gap: 8,
                        }}
                      >
                        <button
                          onClick={() =>
                            onUpdateQuantity(item.id, item.type, -1)
                          }
                        >
                          <Minus size={14} />
                        </button>
                        <div
                          style={{
                            minWidth: 32,
                            textAlign: "center",
                            fontWeight: 700,
                          }}
                        >
                          {item.quantity}
                        </div>
                        <button
                          onClick={() =>
                            onUpdateQuantity(item.id, item.type, 1)
                          }
                        >
                          <Plus size={14} />
                        </button>
                      </div>
                    ) : (
                      <div style={{ fontSize: 13 }}>Qty: {item.quantity}</div>
                    )}

                    <div style={{ fontWeight: 800 }}>
                      ${((item.price ?? 0) * (item.quantity ?? 1)).toFixed(2)}
                    </div>
                    <button
                      onClick={() => onRemoveFromCart(item.id, item.type)}
                      style={{
                        background: "none",
                        border: "none",
                        color: "var(--red500)",
                        cursor: "pointer",
                      }}
                    >
                      <Trash2 />
                    </button>
                  </div>
                </Card>
              ))}
            </div>
          )}
        </div>

        <div style={{ display: "flex", gap: 8, marginTop: 12 }}>
          <Button variation="secondary" onClick={onBack}>
            Back
          </Button>
          <Button
            variation="primary"
            onClick={onNext}
            disabled={cart.length === 0}
          >
            Next
          </Button>
        </div>
      </Right>
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\Payment.tsx
================================================================================

import React, { useMemo, useState } from "react";
import styled from "styled-components";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import { Check, ArrowLeft, Edit2 } from "lucide-react";

const Container = styled.div`
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 2rem;
  max-width: 1200px;
  margin: 0 auto;
  @media (max-width: 1200px) {
    grid-template-columns: 1fr;
  }
`;
const Right = styled.div`
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  padding: 1.25rem;
  border-radius: ${({ theme }) => theme.radii.lg};
  position: sticky;
  top: 1rem;
  height: fit-content;
`;
const Card = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.grey100};
  border-radius: ${({ theme }) => theme.radii.md};
  border: 1px solid ${({ theme }) => theme.color.border};
`;

export default function Payment({
  cart,
  clientName,
  clientLoyaltyPoints = 0,
  discount,
  tips,
  loyaltyPointsToRedeem,
  onUpdateDiscount,
  onUpdateTips,
  onUpdateLoyaltyRedemption,
  onComplete,
  onBack,
  onEditCart,
  processing = false,
}: any) {
  const subtotal = useMemo(
    () => cart.reduce((s: any, i: any) => s + i.price * i.quantity, 0),
    [cart]
  );
  const discountAmount =
    discount?.type === "percentage"
      ? (subtotal * (discount.value || 0)) / 100
      : discount.value || 0;
  const loyaltyValue = (loyaltyPointsToRedeem || 0) * 0.01; // example conversion
  const afterDiscount = Math.max(
    0,
    subtotal - (discountAmount || 0) - loyaltyValue
  );
  const tax = afterDiscount * 0.15;
  const tipsTotal = Object.values(tips || {}).reduce(
    (s: any, v: any) => s + v,
    0
  );
  const total = afterDiscount + tax + tipsTotal;

  const [paymentMethod, setPaymentMethod] = useState<"card" | "cash" | "split">(
    "card"
  );
  const [cashAmount, setCashAmount] = useState("");

  const change = useMemo(
    () => Math.max(0, (parseFloat(cashAmount || "0") || 0) - total),
    [cashAmount, total]
  );
  const canComplete =
    paymentMethod === "cash"
      ? (parseFloat(cashAmount || "0") || 0) >= total
      : true;

  return (
    <Container>
      <div>
        <h2 style={{ margin: 0 }}>Payment</h2>
        <p style={{ color: "var(--muted)" }}>
          Client: {clientName ?? "Walk-in"}
        </p>

        <div style={{ marginTop: 12 }}>
          <h3 style={{ marginBottom: 8 }}>Order</h3>
          <Card>
            {cart.map((it: any) => (
              <div
                key={`${it.id}-${it.type}`}
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  padding: "0.5rem 0",
                  borderBottom: "1px dashed var(--border)",
                }}
              >
                <div>
                  <div style={{ fontWeight: 700 }}>{it.name}</div>
                  {it.staffName && (
                    <div style={{ fontSize: 12, color: "var(--muted)" }}>
                      {it.staffName}
                    </div>
                  )}
                </div>
                <div style={{ textAlign: "right" }}>
                  <div style={{ fontWeight: 800 }}>
                    ${(it.price * it.quantity).toFixed(2)}
                  </div>
                  <div style={{ fontSize: 12, color: "var(--muted)" }}>
                    Qty: {it.quantity}
                  </div>
                </div>
              </div>
            ))}
          </Card>
        </div>
      </div>

      <Right>
        <div style={{ display: "grid", gap: 12 }}>
          <div style={{ textAlign: "center" }}>
            <div
              style={{
                fontSize: 12,
                textTransform: "uppercase",
                fontWeight: 700,
                color: "var(--muted)",
              }}
            >
              Total
            </div>
            <div
              style={{
                fontSize: 28,
                fontWeight: 800,
                color: "var(--brand600)",
              }}
            >
              ${total.toFixed(2)}
            </div>
          </div>

          <div>
            <div style={{ fontWeight: 700, marginBottom: 8 }}>
              Payment Method
            </div>
            <div
              style={{
                display: "grid",
                gridTemplateColumns: "repeat(3,1fr)",
                gap: 8,
              }}
            >
              {(["card", "cash", "split"] as any).map((m: any) => (
                <button
                  key={m}
                  onClick={() => setPaymentMethod(m)}
                  style={{
                    padding: 10,
                    borderRadius: 6,
                    border:
                      paymentMethod === m
                        ? "2px solid var(--brand600)"
                        : "1px solid var(--border)",
                    background:
                      paymentMethod === m ? "var(--brand500)" : "var(--panel)",
                    color: paymentMethod === m ? "#fff" : "inherit",
                  }}
                >
                  {m}
                </button>
              ))}
            </div>

            {paymentMethod === "cash" && (
              <>
                <Input
                  type="number"
                  value={cashAmount}
                  onChange={(e) => setCashAmount(e.target.value)}
                  placeholder="Cash received"
                  style={{ marginTop: 8 }}
                />
                {parseFloat(cashAmount || "0") >= total && (
                  <div
                    style={{
                      marginTop: 8,
                      padding: 8,
                      background: "rgba(16,185,129,0.06)",
                      borderRadius: 6,
                    }}
                  >
                    <strong>Change:</strong> ${change.toFixed(2)}
                  </div>
                )}
              </>
            )}
          </div>

          <div style={{ display: "grid", gap: 8 }}>
            <Button
              variation="primary"
              onClick={() =>
                onComplete([{ method: paymentMethod, amount: total }])
              }
              disabled={!canComplete || processing}
            >
              <Check size={18} style={{ marginRight: 8 }} />
              {processing ? "Processing..." : "Complete Payment"}
            </Button>
            <div style={{ display: "flex", gap: 8 }}>
              <Button variation="secondary" onClick={onBack}>
                <ArrowLeft size={18} style={{ marginRight: 8 }} />
                Back
              </Button>
              <Button variation="secondary" onClick={onEditCart}>
                <Edit2 size={18} style={{ marginRight: 8 }} />
                Edit Cart
              </Button>
            </div>
          </div>
        </div>
      </Right>
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\POS.tsx
================================================================================

import React, { useState, useCallback, useMemo } from "react";
import toast from "react-hot-toast";
import { useQueryClient } from "@tanstack/react-query";

import POSStepWrapper from "./POSStepWrapper";
import ClientSelection from "./ClientSelection";
import ItemSelection from "./ItemSelection";
import Payment from "./Payment";
import CheckoutModal from "./CheckoutModal";
import ReceiptAndNextAppointment from "./ReceiptAndNextAppointment";
import CreateClientModal from "../clients/CreateClientModal";

import { useClients } from "../clients/useClient";
import { useAppointments } from "../appointments/useAppointments";
import { useTreatments } from "../treatments/useTreatments";
import { useStaff } from "../staff/useStaff";
import { useStock } from "../stock/useStock";
import { usePos } from "./usePOS";

export default function PointOfSale() {
  const qc = useQueryClient();

  // UI state
  const [step, setStep] = useState<number>(1);
  const [clientType, setClientType] = useState<"booked" | "walk-in">("booked");
  const [selectedClient, setSelectedClient] = useState<any | null>(null);
  const [selectedAppointmentId, setSelectedAppointmentId] = useState<
    string | null
  >(null);
  const [cart, setCart] = useState<any[]>([]);
  const [showCreateClient, setShowCreateClient] = useState(false);
  const [showCheckout, setShowCheckout] = useState(false);
  const [completedTransaction, setCompletedTransaction] = useState<any | null>(
    null
  );

  // hooks (resource hooks)
  const { listQuery: clientsQuery, createMutation: createClientMutation } =
    useClients();
  const { listQuery: appointmentsQuery } = useAppointments();
  const { listQuery: treatmentsQuery } = useTreatments();
  const { listQuery: staffQuery } = useStaff();
  const { listQuery: stockQuery, updateMutation: stockUpdateMutation } =
    useStock();
  const { createMutation: createTransactionMutation } = usePos();

  const clients = clientsQuery.data ?? [];
  const appointments = appointmentsQuery.data ?? [];
  const treatments = treatmentsQuery.data ?? [];
  const staff = staffQuery.data ?? [];
  const stockItems = stockQuery.data ?? [];

  // build simple stock map { productId -> qty } using the canonical stock item fields
  const productStock = useMemo(() => {
    const map: Record<string, number> = {};
    for (const s of stockItems) {
      // common shapes: { id, productId, quantity } or { id, sku, quantity }
      // prefer productId if present, otherwise use id
      const key = s.id ?? s.id;
      map[key] = s.quantity ?? 0;
    }
    return map;
  }, [stockItems]);

  // CART helpers
  const addToCart = useCallback((item: any) => {
    setCart((prev) => {
      // appointment: allow only one occurrence of same appointment
      if (item.type === "appointment") {
        if (prev.some((p) => p.type === "appointment" && p.id === item.id))
          return prev;
      }

      // stock/product: merge by productId (or id)
      if (item.type === "product" || item.type === "stock") {
        const key = item.productId ?? item.id;
        const idx = prev.findIndex(
          (p) => (p.productId ?? p.id) === key && p.type === "product"
        );
        if (idx >= 0) {
          const next = [...prev];
          next[idx] = {
            ...next[idx],
            quantity: (next[idx].quantity ?? 1) + (item.quantity ?? 1),
          };
          return next;
        }
        // normalize type to "product" for cart items
        return [
          ...prev,
          {
            ...item,
            type: "product",
            productId: key,
            quantity: item.quantity ?? 1,
          },
        ];
      }

      return [...prev, { ...item, quantity: item.quantity ?? 1 }];
    });
  }, []);

  const updateQuantity = useCallback(
    (id: string, type: string, delta: number) => {
      setCart((prev) =>
        prev.map((it) =>
          it.id === id && it.type === type
            ? { ...it, quantity: Math.max(1, (it.quantity ?? 1) + delta) }
            : it
        )
      );
    },
    []
  );

  const removeFromCart = useCallback((id: string, type: string) => {
    setCart((prev) => prev.filter((it) => !(it.id === id && it.type === type)));
  }, []);

  const updateNotes = useCallback((id: string, type: string, notes: string) => {
    setCart((prev) =>
      prev.map((it) =>
        it.id === id && it.type === type ? { ...it, notes } : it
      )
    );
  }, []);

  // create client - uses clients hook
  const handleCreateClient = useCallback(
    async (payload: any) => {
      try {
        const newClient = await createClientMutation.mutateAsync(payload);
        toast.success("Client created");
        setSelectedClient(newClient);
        setShowCreateClient(false);
        // optionally advance to next step:
        // setStep(2);
      } catch (err: any) {
        toast.error(err?.message ?? "Failed to create client");
      }
    },
    [createClientMutation]
  );

  // select client from Child (ClientSelection)
  const handleSelectClient = useCallback(
    (clientId: string, type: "booked" | "walk-in", appointmentId?: string) => {
      setClientType(type);
      setSelectedClient(clients.find((c) => c.id === clientId) ?? null);
      setSelectedAppointmentId(appointmentId ?? null);
      setStep(2);
    },
    [clients]
  );

  // complete transaction -> create + update stock
  const completePayment = useCallback(
    async (payments: any[]) => {
      if (cart.length === 0) {
        toast.error("Cart is empty");
        return;
      }

      try {
        const payload = {
          clientId: selectedClient?.id ?? null,
          appointmentId: selectedAppointmentId ?? null,
          items: cart.map((it) => ({
            type: it.type,
            referenceId: it.type === "product" ? it.productId : it.id,
            name: it.name,
            price: it.price,
            quantity: it.quantity,
            notes: it.notes,
          })),
          payments,
        };

        const tx = await createTransactionMutation.mutateAsync(payload);

        // update stock for products (best-effort; run in parallel)
        const productItems = cart.filter((i) => i.type === "product");
        await Promise.allSettled(
          productItems.map((p) => {
            const stockKey = p.productId ?? p.id;
            // find corresponding stock item id (stock item may contain productId or id)
            const stockItem = stockItems.find(
              (s) => (s.id ?? s.id) === stockKey
            );
            const stockId = stockItem?.id ?? stockKey;
            return stockUpdateMutation.mutateAsync({
              id: stockId,
              updates: {
                quantity: Math.max(
                  0,
                  (productStock[stockKey] ?? 0) - (p.quantity ?? 1)
                ),
              },
            });
          })
        );

        setCompletedTransaction(tx);
        setCart([]);
        setShowCheckout(false);
        toast.success("Sale completed");
        qc.invalidateQueries({ queryKey: ["stock"] });
        qc.invalidateQueries({ queryKey: ["transactions"] });
      } catch (err: any) {
        console.error(err);
        toast.error(err?.message ?? "Failed to complete payment");
      }
    },
    [
      cart,
      createTransactionMutation,
      productStock,
      qc,
      selectedAppointmentId,
      selectedClient,
      stockItems,
      stockUpdateMutation,
    ]
  );

  const goBack = useCallback(() => setStep((s) => Math.max(1, s - 1)), []);
  const goNext = useCallback(() => setStep((s) => Math.min(3, s + 1)), []);

  return (
    <>
      <POSStepWrapper currentStep={step} steps={[]}>
        {step === 1 && (
          <ClientSelection
            clients={clients}
            appointments={appointments}
            onSelectClient={handleSelectClient}
            onCreateNew={() => setShowCreateClient(true)}
          />
        )}

        {step === 2 && (
          <ItemSelection
            clientType={clientType}
            clientName={selectedClient?.name}
            appointments={appointments}
            treatments={treatments}
            stockItems={stockItems} // <-- pass stock list here (replaces products)
            cart={cart}
            productStock={productStock}
            onAddToCart={addToCart}
            onUpdateQuantity={updateQuantity}
            onRemoveFromCart={removeFromCart}
            onUpdateNotes={updateNotes}
            onNext={() => setStep(3)}
            onBack={() => setStep(1)}
          />
        )}

        {step === 3 && (
          <Payment
            cart={cart}
            clientName={selectedClient?.name}
            clientLoyaltyPoints={selectedClient?.loyaltyPoints ?? 0}
            discount={{ type: "percentage", value: 0 }}
            tips={{}}
            loyaltyPointsToRedeem={0}
            onUpdateDiscount={() => {}}
            onUpdateTips={() => {}}
            onUpdateLoyaltyRedemption={() => {}}
            onComplete={() => setShowCheckout(true)}
            onBack={() => setStep(2)}
            onEditCart={() => setStep(2)}
            processing={createTransactionMutation.isPending}
          />
        )}
      </POSStepWrapper>

      <CreateClientModal
        isOpen={showCreateClient}
        onClose={() => setShowCreateClient(false)}
        onCreate={handleCreateClient}
        creating={createClientMutation.isPending}
      />

      <CheckoutModal
        isOpen={showCheckout}
        onClose={() => setShowCheckout(false)}
        total={cart.reduce((s, i) => s + (i.price ?? 0) * (i.quantity ?? 1), 0)}
        onComplete={completePayment}
        processing={createTransactionMutation.isPending}
      />

      {completedTransaction && selectedClient && (
        <ReceiptAndNextAppointment
          transaction={completedTransaction}
          client={selectedClient}
          treatments={treatments.map((t) => ({
            id: t.id,
            name: t.name,
            durationMinutes: t.durationMinutes,
            price: t.price,
            category: t.category ?? undefined,
            isActive: t.isActive,
          }))}
          staff={staff.map((s) => ({
            id: s.id,
            name: `${s.firstName} ${s.lastName}`,
            role: s.role,
            specialties: s.specializations,
            available: s.status === "active",
          }))}
          onBookAppointment={async (appointmentData) => {
            try {
              // TODO: Implement appointment booking logic
              // await createAppointmentMutation.mutateAsync(appointmentData);
              toast.success("Appointment booked successfully!");
              setCompletedTransaction(null);
              setStep(1);
              setSelectedClient(null);
              setSelectedAppointmentId(null);
            } catch (err: any) {
              toast.error(err?.message ?? "Failed to book appointment");
            }
          }}
          onNewSale={() => {
            setCompletedTransaction(null);
            setStep(1);
            setSelectedClient(null);
            setSelectedAppointmentId(null);
            setCart([]);
          }}
          bookingAppointment={false}
          onClose={() => setCompletedTransaction(null)}
        />
      )}
    </>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\POSSchema.ts
================================================================================

import { z } from "zod";

// ============================================================================
// SCHEMAS
// ============================================================================

// Cart Item Schema
export const CartItemSchema = z.object({
  id: z.string(),
  type: z.enum(["treatment", "product", "appointment"]),
  name: z.string(),
  price: z.number(),
  originalPrice: z.number(),
  quantity: z.number(),
  maxQuantity: z.number().optional(),
  appointmentId: z.string().optional(),
  clientName: z.string().optional(),
  treatmentId: z.string().optional(),
  productId: z.string().optional(),
  staffId: z.string().optional(),
  staffName: z.string().optional(),
  duration: z.number().optional(),
  notes: z.string().optional(),
  isAppointmentCheckin: z.boolean().optional(),
  locked: z.boolean().optional(),
});

// Discount Schema
export const DiscountSchema = z.object({
  type: z.enum(["percentage", "fixed", "loyalty"]),
  value: z.number(),
  reason: z.string().optional(),
  requiresApproval: z.boolean().optional(),
});

// Payment Breakdown Schema
export const PaymentBreakdownSchema = z.object({
  method: z.enum(["cash", "card", "loyalty", "gift-card"]),
  amount: z.number(),
  reference: z.string().optional(),
});

// Tips Schema
export const TipsSchema = z.record(z.string(), z.number());

// Transaction Schema
export const TransactionSchema = z.object({
  id: z.string(),
  clientId: z.string().optional(),
  clientName: z.string().optional(),
  items: z.array(CartItemSchema),
  subtotal: z.number(),
  discount: DiscountSchema,
  discountAmount: z.number(),
  tax: z.number(),
  tips: TipsSchema,
  tipsTotal: z.number(),
  total: z.number(),
  payments: z.array(PaymentBreakdownSchema),
  paymentMethod: z.string().optional(), // Primary payment method for display
  loyaltyPointsEarned: z.number(),
  loyaltyPointsRedeemed: z.number(),
  status: z.enum(["pending", "completed", "cancelled", "refunded"]),
  createdAt: z.string(),
  completedAt: z.string().optional(),
  createdBy: z.string(),
});

// Create Transaction Schema
export const CreateTransactionSchema = z.object({
  clientId: z.string().optional(),
  items: z.array(CartItemSchema),
  discount: DiscountSchema,
  payments: z.array(PaymentBreakdownSchema),
  tips: TipsSchema.optional(),
  loyaltyPointsRedeemed: z.number().optional(),
});

// Client Schema
export const ClientSchema = z.object({
  id: z.string(),
  name: z.string(),
  email: z.string().email().optional(),
  phone: z.string().optional(),
  loyaltyPoints: z.number().default(0),
});

// Create Client Schema
export const CreateClientSchema = z.object({
  name: z.string().min(1, "Name is required"),
  phone: z.string().optional(),
  email: z.string().email().optional().or(z.literal("")),
  loyaltyPoints: z.number().default(0),
});

// Appointment Schema
export const AppointmentSchema = z.object({
  id: z.string(),
  clientId: z.string(),
  clientName: z.string().optional(),
  treatmentId: z.string(),
  treatmentName: z.string().optional(),
  datetimeISO: z.string().datetime(),
  status: z.enum(["confirmed", "pending", "cancelled", "completed"]).optional(),
  staffId: z.string().optional(),
  staffName: z.string().optional(),
  notes: z.string().optional(),
  duration: z.number().optional(),
  price: z.number().optional(),
});

// Create Appointment Schema
export const CreateAppointmentSchema = z.object({
  clientId: z.string().min(1, "Client is required"),
  treatmentId: z.string().min(1, "Treatment is required"),
  datetimeISO: z.string().datetime(),
  status: z
    .enum(["confirmed", "pending", "cancelled", "completed"])
    .default("confirmed"),
  staffId: z.string().optional(),
  notes: z.string().optional(),
});

// Treatment Schema
export const TreatmentSchema = z.object({
  id: z.string(),
  name: z.string(),
  durationMinutes: z.number(),
  price: z.number().optional(),
  category: z.string().optional(),
  isActive: z.boolean().optional(),
});

// Product Schema
export const ProductSchema = z.object({
  id: z.string(),
  name: z.string(),
  price: z.number(),
  stock: z.number(),
  category: z.string().optional(),
  sku: z.string().optional(),
  retail: z.boolean().optional(),
});

// Staff Schema
export const StaffSchema = z.object({
  id: z.string(),
  name: z.string(),
  role: z.string().optional(),
  specialties: z.array(z.string()).optional(),
  available: z.boolean().optional(),
});

// Draft Sale Schema
export const DraftSaleSchema = z.object({
  id: z.string(),
  timestamp: z.string(),
  clientId: z.string().optional(),
  clientData: z.any().optional(),
  cart: z.array(CartItemSchema),
  discount: DiscountSchema,
  tips: TipsSchema.optional(),
  currentStep: z.number(),
  expiresAt: z.string(),
});

// ============================================================================
// TYPES
// ============================================================================

export type CartItem = z.infer<typeof CartItemSchema>;
export type Discount = z.infer<typeof DiscountSchema>;
export type PaymentBreakdown = z.infer<typeof PaymentBreakdownSchema>;
export type Tips = z.infer<typeof TipsSchema>;
export type Transaction = z.infer<typeof TransactionSchema>;
export type CreateTransactionInput = z.infer<typeof CreateTransactionSchema>;
export type Client = z.infer<typeof ClientSchema>;
export type CreateClientInput = z.infer<typeof CreateClientSchema>;
export type Appointment = z.infer<typeof AppointmentSchema>;
export type CreateAppointmentInput = z.infer<typeof CreateAppointmentSchema>;
export type Treatment = z.infer<typeof TreatmentSchema>;
export type Product = z.infer<typeof ProductSchema>;
export type Staff = z.infer<typeof StaffSchema>;
export type DraftSale = z.infer<typeof DraftSaleSchema>;

// Validation Types
export interface CartValidation {
  canAdd: boolean;
  reason?: string;
  warnings?: string[];
}

export interface StaffConflict {
  staffId: string;
  staffName: string;
  conflictingItems: string[];
  overlappingTime: boolean;
}

export interface DiscountValidation {
  valid: boolean;
  error?: string;
}

export interface PaymentValidation {
  valid: boolean;
  errors: string[];
  warnings: string[];
}


================================================================================
FILE: ./frontend/src/modules/POS\POSStepWrapper.tsx
================================================================================

import React from "react";
import styled from "styled-components";
import { Check } from "lucide-react";

interface Step {
  number: number;
  label: string;
  completed: boolean;
}

interface POSStepWrapperProps {
  currentStep: number;
  steps: Step[];
  children: React.ReactNode;
}

const Wrapper = styled.div`
  padding: 2rem;
  max-width: 1400px;
  margin: 0 auto;
`;

const StepsHeader = styled.div`
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: ${({ theme }) => theme.shadowMd};
`;

const StepsContainer = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  max-width: 800px;
  margin: 0 auto;
`;

const StepItem = styled.div<{ $active: boolean; $completed: boolean }>`
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
  position: relative;
  z-index: 2;
`;

const StepCircle = styled.div<{ $active: boolean; $completed: boolean }>`
  width: 3.5rem;
  height: 3.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 1.125rem;
  background: ${({ $active, $completed, theme }) =>
    $completed
      ? theme.color.green500
      : $active
      ? theme.color.brand500
      : theme.color.grey200};
  color: ${({ $active, $completed }) =>
    $completed || $active ? "#ffffff" : "#6b7280"};
  border: 3px solid
    ${({ $active, $completed, theme }) =>
      $completed
        ? theme.color.green500
        : $active
        ? theme.color.brand600
        : theme.color.grey300};
  transition: all 0.3s ease;
  box-shadow: ${({ theme }) => theme.shadowMd};
`;

const StepLabel = styled.div<{ $active: boolean }>`
  font-size: 0.875rem;
  font-weight: ${({ $active }) => ($active ? 700 : 500)};
  color: ${({ $active, theme }) =>
    $active ? theme.color.text : theme.color.mutedText};
  text-align: center;
  max-width: 100px;
`;

const StepConnector = styled.div<{ $completed: boolean }>`
  position: absolute;
  top: 1.75rem;
  left: 0;
  right: 0;
  height: 3px;
  background: ${({ $completed, theme }) =>
    $completed ? theme.color.green500 : theme.color.grey300};
  z-index: 1;
  transition: background 0.3s ease;
`;

const Content = styled.div`
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  padding: 2rem;
  box-shadow: ${({ theme }) => theme.shadowMd};
  min-height: 600px;
`;

export default function POSStepWrapper({
  currentStep,
  steps,
  children,
}: POSStepWrapperProps) {
  return (
    <Wrapper>
      <StepsHeader>
        <StepsContainer>
          <StepConnector
            $completed={currentStep > 1}
            style={{
              width: `${((currentStep - 1) / (steps.length - 1)) * 100}%`,
            }}
          />
          {steps.map((step) => (
            <StepItem
              key={step.number}
              $active={currentStep === step.number}
              $completed={step.completed}
            >
              <StepCircle
                $active={currentStep === step.number}
                $completed={step.completed}
              >
                {step.completed ? <Check size={24} /> : step.number}
              </StepCircle>
              <StepLabel $active={currentStep === step.number}>
                {step.label}
              </StepLabel>
            </StepItem>
          ))}
        </StepsContainer>
      </StepsHeader>

      <Content>{children}</Content>
    </Wrapper>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\ReceiptAndNextAppointment.tsx
================================================================================

import React, { useState, useMemo, useCallback } from "react";
import styled from "styled-components";
import {
  Calendar,
  Check,
  X,
  Mail,
  Printer,
  MessageSquare,
  Gift,
  CheckCircle,
} from "lucide-react";
import Button from "../../ui/components/Button";
import Modal from "../../ui/components/Modal";
import Input from "../../ui/components/Input";
import toast from "react-hot-toast";
import type { Client, Treatment, Staff } from "./POSSchema";

interface Transaction {
  id: string;
  total: number;
  subtotal: number;
  tax: number;
  discountAmount: number;
  tipsTotal: number;
  loyaltyPointsEarned: number;
  items: Array<{
    name: string;
    price: number;
    quantity: number;
  }>;
  paymentMethod: string;
}

interface ReceiptAndNextAppointmentProps {
  transaction: Transaction;
  client: Client;
  treatments: Treatment[];
  staff: Staff[];
  onBookAppointment: (appointmentData: {
    clientId: string;
    treatmentId: string;
    datetimeISO: string;
    staffId?: string;
    notes?: string;
  }) => void;
  onNewSale: () => void;
  bookingAppointment?: boolean;
  onClose: () => void;
}

// Styled Components
const Container = styled.div`
  display: grid;
  gap: 2rem;
  max-width: 900px;
  margin: 0 auto;
`;

const SuccessHeader = styled.div`
  text-align: center;
  padding: 2rem 1rem;
`;

const SuccessIcon = styled.div`
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: ${({ theme }) => theme.color.green500};
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
  animation: scaleIn 0.4s ease-out;

  @keyframes scaleIn {
    from {
      transform: scale(0);
    }
    to {
      transform: scale(1);
    }
  }
`;

const SuccessTitle = styled.h2`
  font-size: 2rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.5rem 0;
`;

const SuccessSubtitle = styled.p`
  font-size: 1.125rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0 0 1rem 0;
`;

const TransactionId = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
  font-family: "Courier New", monospace;
`;

const SectionGrid = styled.div`
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
`;

const Card = styled.div`
  padding: 1.5rem;
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  box-shadow: ${({ theme }) => theme.shadowSm};
`;

const CardTitle = styled.h3`
  font-size: 1rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 1rem 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const ReceiptList = styled.div`
  display: grid;
  gap: 0.75rem;
`;

const ReceiptRow = styled.div<{ $isTotal?: boolean }>`
  display: flex;
  justify-content: space-between;
  font-size: 0.9375rem;
  color: ${({ theme }) => theme.color.text};

  ${({ $isTotal, theme }) =>
    $isTotal &&
    `
    font-weight: 700;
    font-size: 1.125rem;
    padding-top: 0.75rem;
    border-top: 2px solid ${theme.color.border};
    color: ${theme.color.brand600};
  `}
`;

const LoyaltyCard = styled.div`
  padding: 1.25rem;
  background: linear-gradient(
    135deg,
    ${({ theme }) => theme.color.brand500}20,
    ${({ theme }) => theme.color.brand600}20
  );
  border: 2px solid ${({ theme }) => theme.color.brand500};
  border-radius: ${({ theme }) => theme.radii.lg};
  text-align: center;
`;

const LoyaltyAmount = styled.div`
  font-size: 2.5rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.brand600};
  margin-bottom: 0.5rem;
`;

const LoyaltyLabel = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
`;

const ReceiptActions = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
  margin-top: 1rem;
`;

const ReceiptButton = styled.button`
  padding: 0.75rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
  color: ${({ theme }) => theme.color.text};
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s;

  &:hover {
    background: ${({ theme }) => theme.color.brand50};
    border-color: ${({ theme }) => theme.color.brand500};
  }

  &:active {
    transform: scale(0.98);
  }

  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
`;

const AppointmentPrompt = styled.div`
  padding: 2rem;
  background: ${({ theme }) => theme.color.brand50};
  border: 2px solid ${({ theme }) => theme.color.brand500};
  border-radius: ${({ theme }) => theme.radii.lg};
  text-align: center;
`;

const PromptTitle = styled.h3`
  font-size: 1.5rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.75rem 0;
`;

const PromptSubtitle = styled.p`
  font-size: 1rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0 0 1.5rem 0;
`;

const PromptActions = styled.div`
  display: flex;
  gap: 1rem;
  justify-content: center;

  @media (max-width: 640px) {
    flex-direction: column;
  }
`;

const FormContainer = styled.div`
  display: grid;
  gap: 1.25rem;
`;

const FormField = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
`;

const Label = styled.label`
  font-weight: 600;
  font-size: 0.9375rem;
  color: ${({ theme }) => theme.color.text};
`;

const Select = styled.select`
  width: 100%;
  min-height: 46px;
  padding: 0.8rem 1.2rem;
  border-radius: ${({ theme }) => theme.radii.sm};
  border: 1px solid ${({ theme }) => theme.color.border};
  background-color: ${({ theme }) => theme.color.panel};
  color: ${({ theme }) => theme.color.text};
  box-shadow: ${({ theme }) => theme.shadowSm};
  font-size: 1rem;
  font-family: inherit;
  line-height: 1.5;
  outline: none;
  cursor: pointer;
  transition: box-shadow 0.12s ease, border-color 0.12s ease;
  box-sizing: border-box;

  &:focus {
    box-shadow: 0 0 0 4px ${({ theme }) => theme.color.brand100};
    border-color: ${({ theme }) => theme.color.brand600};
  }

  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: ${({ theme }) => theme.color.grey100};
  }
`;

const DateTimeGrid = styled.div`
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;

  @media (max-width: 640px) {
    grid-template-columns: 1fr;
  }
`;

const InfoBox = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.brand50};
  border: 1px solid ${({ theme }) => theme.color.brand200};
  border-radius: ${({ theme }) => theme.radii.md};
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 1.5rem;
`;

const ModalActions = styled.div`
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
`;

// Helper function to generate time slots
function generateTimeSlots(): string[] {
  const slots: string[] = [];
  for (let h = 9; h <= 17; h++) {
    for (let m = 0; m < 60; m += 15) {
      if (h === 17 && m > 0) break;
      const hour = h.toString().padStart(2, "0");
      const minute = m.toString().padStart(2, "0");
      slots.push(`${hour}:${minute}`);
    }
  }
  return slots;
}

export default function ReceiptAndNextAppointment({
  transaction,
  client,
  treatments,
  staff,
  onBookAppointment,
  onNewSale,
  bookingAppointment = false,
  onClose,
}: ReceiptAndNextAppointmentProps) {
  const [showAppointmentModal, setShowAppointmentModal] = useState(false);
  const [appointmentData, setAppointmentData] = useState({
    date: "",
    time: "",
    treatment: "",
    staff: "",
    notes: "",
  });

  const timeSlots = useMemo(() => generateTimeSlots(), []);

  // Filter treatments that were actually treatments (not products)
  const availableTreatments = useMemo(() => {
    return treatments.filter((t) =>
      transaction.items.some(
        (item) => item.name.toLowerCase() === t.name.toLowerCase()
      )
    );
  }, [treatments, transaction.items]);

  const handleSendReceipt = useCallback(
    async (method: "email" | "print" | "sms") => {
      try {
        // In real app, call API to send receipt
        // await sendReceipt(transaction.id, method, client.email or client.phone);

        toast.success(
          `Receipt ${method === "print" ? "printed" : `sent via ${method}`}!`,
          {
            duration: 3000,
            position: "top-right",
          }
        );
      } catch (error) {
        toast.error(`Failed to send receipt via ${method}`, {
          duration: 4000,
          position: "top-right",
        });
      }
    },
    [transaction.id, client]
  );

  const handleOpenAppointmentModal = useCallback(() => {
    // Pre-fill with first treatment if available
    if (availableTreatments.length > 0) {
      setAppointmentData((prev) => ({
        ...prev,
        treatment: availableTreatments[0].id,
      }));
    }
    setShowAppointmentModal(true);
  }, [availableTreatments]);

  const handleCloseAppointmentModal = useCallback(() => {
    setShowAppointmentModal(false);
    setAppointmentData({
      date: "",
      time: "",
      treatment: "",
      staff: "",
      notes: "",
    });
  }, []);

  const handleAppointmentSubmit = useCallback(() => {
    // Validate required fields
    if (
      !appointmentData.date ||
      !appointmentData.time ||
      !appointmentData.treatment
    ) {
      toast.error("Please fill in all required fields", {
        duration: 4000,
        position: "top-right",
      });
      return;
    }

    // Build ISO datetime string
    const datetimeISO = `${appointmentData.date}T${appointmentData.time}:00`;

    onBookAppointment({
      clientId: client.id,
      treatmentId: appointmentData.treatment,
      datetimeISO,
      staffId: appointmentData.staff || undefined,
      notes: appointmentData.notes || undefined,
    });

    handleCloseAppointmentModal();
  }, [
    appointmentData,
    client.id,
    onBookAppointment,
    handleCloseAppointmentModal,
  ]);

  const minDate = new Date().toISOString().split("T")[0];

  return (
    <Container>
      {/* Success Header */}
      <SuccessHeader>
        <SuccessIcon>
          <Check size={48} strokeWidth={3} />
        </SuccessIcon>
        <SuccessTitle>Payment Successful!</SuccessTitle>
        <SuccessSubtitle>Thank you for your payment</SuccessSubtitle>
        <TransactionId>Transaction ID: {transaction.id}</TransactionId>
      </SuccessHeader>

      {/* Receipt & Loyalty Cards */}
      <SectionGrid>
        <Card>
          <CardTitle>
            <CheckCircle size={18} />
            Receipt Summary
          </CardTitle>
          <ReceiptList>
            {transaction.items.map((item, idx) => (
              <ReceiptRow key={idx}>
                <span>
                  {item.name} Ã— {item.quantity}
                </span>
                <span>${(item.price * item.quantity).toFixed(2)}</span>
              </ReceiptRow>
            ))}
            <ReceiptRow
              style={{
                marginTop: "0.5rem",
                paddingTop: "0.5rem",
                borderTop: "1px solid",
                borderColor: "inherit",
              }}
            >
              <span>Subtotal:</span>
              <span>${transaction.subtotal.toFixed(2)}</span>
            </ReceiptRow>
            {transaction.discountAmount > 0 && (
              <ReceiptRow>
                <span>Discount:</span>
                <span style={{ color: "#22c55e" }}>
                  -${transaction.discountAmount.toFixed(2)}
                </span>
              </ReceiptRow>
            )}
            <ReceiptRow>
              <span>Tax (15%):</span>
              <span>${transaction.tax.toFixed(2)}</span>
            </ReceiptRow>
            {transaction.tipsTotal > 0 && (
              <ReceiptRow>
                <span>Tips:</span>
                <span>${transaction.tipsTotal.toFixed(2)}</span>
              </ReceiptRow>
            )}
            <ReceiptRow $isTotal>
              <span>Total Paid:</span>
              <span>${transaction.total.toFixed(2)}</span>
            </ReceiptRow>
          </ReceiptList>

          <ReceiptActions>
            <ReceiptButton onClick={() => handleSendReceipt("email")}>
              <Mail size={20} />
              Email
            </ReceiptButton>
            <ReceiptButton onClick={() => handleSendReceipt("print")}>
              <Printer size={20} />
              Print
            </ReceiptButton>
            <ReceiptButton onClick={() => handleSendReceipt("sms")}>
              <MessageSquare size={20} />
              SMS
            </ReceiptButton>
          </ReceiptActions>
        </Card>

        <Card>
          <CardTitle>
            <Gift size={18} />
            Loyalty Points
          </CardTitle>
          <LoyaltyCard>
            <LoyaltyAmount>+{transaction.loyaltyPointsEarned}</LoyaltyAmount>
            <LoyaltyLabel>Points Earned</LoyaltyLabel>
          </LoyaltyCard>
          <div
            style={{
              marginTop: "1rem",
              textAlign: "center",
              fontSize: "0.875rem",
              color: "#6b7280",
            }}
          >
            New balance:{" "}
            <strong>
              {client.loyaltyPoints + transaction.loyaltyPointsEarned} points
            </strong>
          </div>
        </Card>
      </SectionGrid>

      {/* Book Next Appointment Prompt */}
      <AppointmentPrompt>
        <PromptTitle>Book Your Next Appointment?</PromptTitle>
        <PromptSubtitle>
          Schedule your next visit with {client.name} now
        </PromptSubtitle>
        <PromptActions>
          <Button
            variation="secondary"
            size="medium"
            onClick={onNewSale}
            style={{
              flex: 1,
              justifyContent: "center",
              minWidth: "160px",
            }}
          >
            <X size={20} />
            No Thanks
          </Button>
          <Button
            variation="primary"
            size="medium"
            onClick={handleOpenAppointmentModal}
            style={{
              flex: 1,
              justifyContent: "center",
              minWidth: "160px",
            }}
          >
            <Calendar size={20} />
            Book Appointment
          </Button>
        </PromptActions>
      </AppointmentPrompt>

      {/* Appointment Booking Modal */}
      <Modal
        isOpen={showAppointmentModal}
        onClose={handleCloseAppointmentModal}
        title="Book Next Appointment"
        size="md"
        ariaLabel="Book next appointment"
      >
        <InfoBox>
          <strong>Booking for:</strong> {client.name}
          <br />
          {client.email && (
            <>
              <strong>Email:</strong> {client.email}
              <br />
            </>
          )}
          {client.phone && (
            <>
              <strong>Phone:</strong> {client.phone}
            </>
          )}
        </InfoBox>

        <FormContainer>
          <FormField>
            <Label htmlFor="appointment-treatment">
              Treatment <span style={{ color: "#ef4444" }}>*</span>
            </Label>
            <Select
              id="appointment-treatment"
              value={appointmentData.treatment}
              onChange={(e) =>
                setAppointmentData((prev) => ({
                  ...prev,
                  treatment: e.target.value,
                }))
              }
            >
              <option value="">Select a treatment</option>
              {availableTreatments.map((treatment) => (
                <option key={treatment.id} value={treatment.id}>
                  {treatment.name} ({treatment.durationMinutes} min - $
                  {treatment.price})
                </option>
              ))}
            </Select>
          </FormField>

          <DateTimeGrid>
            <FormField>
              <Label htmlFor="appointment-date">
                Date <span style={{ color: "#ef4444" }}>*</span>
              </Label>
              <Input
                type="date"
                id="appointment-date"
                value={appointmentData.date}
                onChange={(e) =>
                  setAppointmentData((prev) => ({
                    ...prev,
                    date: e.target.value,
                  }))
                }
                min={minDate}
              />
            </FormField>

            <FormField>
              <Label htmlFor="appointment-time">
                Time <span style={{ color: "#ef4444" }}>*</span>
              </Label>
              <Select
                id="appointment-time"
                value={appointmentData.time}
                onChange={(e) =>
                  setAppointmentData((prev) => ({
                    ...prev,
                    time: e.target.value,
                  }))
                }
              >
                <option value="">Select time</option>
                {timeSlots.map((slot) => (
                  <option key={slot} value={slot}>
                    {slot}
                  </option>
                ))}
              </Select>
            </FormField>
          </DateTimeGrid>

          <FormField>
            <Label htmlFor="appointment-staff">Staff (Optional)</Label>
            <Select
              id="appointment-staff"
              value={appointmentData.staff}
              onChange={(e) =>
                setAppointmentData((prev) => ({
                  ...prev,
                  staff: e.target.value,
                }))
              }
            >
              <option value="">Any available staff</option>
              {staff.map((s) => (
                <option key={s.id} value={s.id}>
                  {s.name} - {s.role}
                </option>
              ))}
            </Select>
          </FormField>

          <FormField>
            <Label htmlFor="appointment-notes">Notes (Optional)</Label>
            <Input
              type="text"
              id="appointment-notes"
              value={appointmentData.notes}
              onChange={(e) =>
                setAppointmentData((prev) => ({
                  ...prev,
                  notes: e.target.value,
                }))
              }
              placeholder="Any special requests or preferences..."
            />
          </FormField>

          <ModalActions>
            <Button
              variation="secondary"
              onClick={handleCloseAppointmentModal}
              style={{ flex: 1, justifyContent: "center" }}
            >
              Cancel
            </Button>
            <Button
              variation="primary"
              onClick={handleAppointmentSubmit}
              disabled={bookingAppointment}
              style={{ flex: 1, justifyContent: "center" }}
            >
              <Calendar size={18} />
              {bookingAppointment ? "Booking..." : "Book Appointment"}
            </Button>
          </ModalActions>
        </FormContainer>
      </Modal>
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\StaffAssignment.tsx
================================================================================

import React, { useState, useMemo } from "react";
import styled from "styled-components";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import {
  User,
  Search,
  Check,
  AlertCircle,
  ArrowRight,
  ArrowLeft,
} from "lucide-react";
import type { CartItem } from "./api";

interface Staff {
  id: string;
  name: string;
  role: string;
  specialties?: string[];
  available: boolean;
}

interface Step3StaffAssignmentProps {
  cart: CartItem[];
  staff: Staff[];
  onAssignStaff: (
    itemId: string,
    itemType: string,
    staffId: string,
    staffName: string
  ) => void;
  onNext: () => void;
  onBack: () => void;
}

const Container = styled.div`
  display: grid;
  gap: 2rem;
  max-width: 1000px;
  margin: 0 auto;
`;

const Title = styled.h2`
  font-size: 1.75rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.5rem 0;
`;

const Subtitle = styled.p`
  font-size: 1rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0;
`;

const TreatmentsList = styled.div`
  display: grid;
  gap: 1.5rem;
`;

const TreatmentCard = styled.div<{ $assigned: boolean }>`
  padding: 1.5rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 2px solid
    ${({ $assigned, theme }) =>
      $assigned ? theme.color.green500 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  transition: all 0.2s;
`;

const TreatmentHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
`;

const TreatmentInfo = styled.div`
  flex: 1;
`;

const TreatmentName = styled.div`
  font-weight: 700;
  font-size: 1.125rem;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 0.375rem;
`;

const TreatmentMeta = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const StatusBadge = styled.div<{ $assigned: boolean }>`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: ${({ $assigned, theme }) =>
    $assigned ? theme.color.green500 + "30" : theme.color.red500 + "30"};
  color: ${({ $assigned, theme }) =>
    $assigned ? theme.color.green500 : theme.color.red500};
  border-radius: ${({ theme }) => theme.radii.round};
  font-size: 0.875rem;
  font-weight: 700;
`;

const AssignedStaff = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.brand50};
  border: 1px solid ${({ theme }) => theme.color.brand200};
  border-radius: ${({ theme }) => theme.radii.md};
  margin-bottom: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
`;

const StaffInfo = styled.div``;

const StaffLabel = styled.div`
  font-size: 0.75rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin-bottom: 0.25rem;
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.05em;
`;

const StaffName = styled.div`
  font-size: 1rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
`;

const SearchBar = styled.div`
  position: relative;
  margin-bottom: 1rem;
`;

const SearchIcon = styled.div`
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: ${({ theme }) => theme.color.mutedText};
  pointer-events: none;
`;

const StaffGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  max-height: 300px;
  overflow-y: auto;

  @media (max-width: 768px) {
    grid-template-columns: repeat(2, 1fr);
  }
`;

const StaffCard = styled.button<{ $selected: boolean; $disabled: boolean }>`
  padding: 1.25rem;
  background: ${({ $selected, theme }) =>
    $selected ? theme.color.brand500 : theme.color.panel};
  color: ${({ $selected, theme }) =>
    $selected ? "#ffffff" : theme.color.text};
  border: 2px solid
    ${({ $selected, theme }) =>
      $selected ? theme.color.brand600 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
  cursor: ${({ $disabled }) => ($disabled ? "not-allowed" : "pointer")};
  opacity: ${({ $disabled }) => ($disabled ? 0.5 : 1)};
  transition: all 0.2s;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;

  &:hover:not(:disabled) {
    transform: ${({ $selected }) => ($selected ? "none" : "translateY(-2px)")};
    border-color: ${({ theme }) => theme.color.brand500};
    background: ${({ $selected, theme }) =>
      $selected ? theme.color.brand600 : theme.color.brand50};
  }
`;

const StaffCardName = styled.div`
  font-weight: 700;
  font-size: 0.9375rem;
`;

const StaffCardRole = styled.div`
  font-size: 0.8125rem;
  opacity: 0.85;
`;

const AvailabilityBadge = styled.div<{ $available: boolean }>`
  padding: 0.25rem 0.625rem;
  background: ${({ $available }) => ($available ? "#34d39930" : "#6b728030")};
  color: ${({ $available }) => ($available ? "#34d399" : "#6b7280")};
  border-radius: 999px;
  font-size: 0.6875rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-top: 0.25rem;
`;

const EmptyState = styled.div`
  text-align: center;
  padding: 3rem 1rem;
  color: ${({ theme }) => theme.color.mutedText};
  grid-column: 1 / -1;
`;

const Actions = styled.div`
  display: flex;
  gap: 1rem;
  padding-top: 1rem;
`;

export default function Step3StaffAssignment({
  cart,
  staff,
  onAssignStaff,
  onNext,
  onBack,
}: Step3StaffAssignmentProps) {
  const [expandedTreatment, setExpandedTreatment] = useState<string | null>(
    null
  );
  const [searchQuery, setSearchQuery] = useState("");

  // Filter treatments only (not products)
  const treatments = useMemo(
    () =>
      cart.filter(
        (item) => item.type === "treatment" || item.type === "appointment"
      ),
    [cart]
  );

  // Check if all treatments have staff
  const allAssigned = useMemo(
    () => treatments.every((item) => item.staffId),
    [treatments]
  );

  // Filter staff
  const filteredStaff = useMemo(() => {
    if (!searchQuery.trim()) return staff;
    const query = searchQuery.toLowerCase();
    return staff.filter(
      (s) =>
        s.name.toLowerCase().includes(query) ||
        s.role.toLowerCase().includes(query) ||
        s.specialties?.some((spec) => spec.toLowerCase().includes(query))
    );
  }, [staff, searchQuery]);

  const handleSelectStaff = (item: CartItem, staffMember: Staff) => {
    onAssignStaff(item.id, item.type, staffMember.id, staffMember.name);
    setExpandedTreatment(null);
    setSearchQuery("");
  };

  return (
    <Container>
      <div>
        <Title>Assign Staff Members</Title>
        <Subtitle>
          Assign a therapist to each treatment before proceeding to checkout
        </Subtitle>
      </div>

      <TreatmentsList>
        {treatments.map((item) => {
          const key = `${item.id}-${item.type}`;
          const isExpanded = expandedTreatment === key;
          const isAssigned = !!item.staffId;

          return (
            <TreatmentCard key={key} $assigned={isAssigned}>
              <TreatmentHeader>
                <TreatmentInfo>
                  <TreatmentName>{item.name}</TreatmentName>
                  <TreatmentMeta>
                    {item.clientName && `Client: ${item.clientName}`}
                    {item.duration && ` â€¢ ${item.duration} min`}
                  </TreatmentMeta>
                </TreatmentInfo>
                <StatusBadge $assigned={isAssigned}>
                  {isAssigned ? (
                    <>
                      <Check size={16} />
                      Assigned
                    </>
                  ) : (
                    <>
                      <AlertCircle size={16} />
                      Not Assigned
                    </>
                  )}
                </StatusBadge>
              </TreatmentHeader>

              {/* Show assigned staff */}
              {isAssigned && !isExpanded && (
                <AssignedStaff>
                  <StaffInfo>
                    <StaffLabel>Assigned Therapist</StaffLabel>
                    <StaffName>{item.staffName}</StaffName>
                  </StaffInfo>
                  <Button
                    variation="secondary"
                    size="small"
                    onClick={() => setExpandedTreatment(key)}
                  >
                    Change
                  </Button>
                </AssignedStaff>
              )}

              {/* Assign/Change button */}
              {!isExpanded && !isAssigned && (
                <Button
                  variation="primary"
                  onClick={() => setExpandedTreatment(key)}
                  style={{ width: "100%", justifyContent: "center" }}
                >
                  Assign Therapist
                </Button>
              )}

              {/* Staff selection */}
              {isExpanded && (
                <>
                  <SearchBar>
                    <SearchIcon>
                      <Search size={18} />
                    </SearchIcon>
                    <Input
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="Search staff..."
                      style={{ paddingLeft: "2.75rem" }}
                      autoFocus
                    />
                  </SearchBar>

                  <StaffGrid>
                    {filteredStaff.length === 0 ? (
                      <EmptyState>
                        <User
                          size={40}
                          style={{ margin: "0 auto 0.5rem", opacity: 0.3 }}
                        />
                        <p style={{ margin: 0, fontSize: "0.875rem" }}>
                          No staff found
                        </p>
                      </EmptyState>
                    ) : (
                      filteredStaff.map((staffMember) => (
                        <StaffCard
                          key={staffMember.id}
                          type="button"
                          $selected={item.staffId === staffMember.id}
                          $disabled={!staffMember.available}
                          disabled={!staffMember.available}
                          onClick={() => handleSelectStaff(item, staffMember)}
                        >
                          <StaffCardName>{staffMember.name}</StaffCardName>
                          <StaffCardRole>{staffMember.role}</StaffCardRole>
                          <AvailabilityBadge $available={staffMember.available}>
                            {staffMember.available
                              ? "Available"
                              : "Unavailable"}
                          </AvailabilityBadge>
                        </StaffCard>
                      ))
                    )}
                  </StaffGrid>

                  <Button
                    variation="secondary"
                    onClick={() => {
                      setExpandedTreatment(null);
                      setSearchQuery("");
                    }}
                    size="small"
                    style={{
                      width: "100%",
                      justifyContent: "center",
                      marginTop: "0.5rem",
                    }}
                  >
                    Cancel
                  </Button>
                </>
              )}
            </TreatmentCard>
          );
        })}
      </TreatmentsList>

      <Actions>
        <Button
          variation="secondary"
          icon={<ArrowLeft size={18} />}
          onClick={onBack}
          style={{ flex: 1, justifyContent: "center", padding: "1rem" }}
        >
          Back
        </Button>
        <Button
          variation="primary"
          icon={<ArrowRight size={18} />}
          onClick={onNext}
          disabled={!allAssigned}
          style={{ flex: 1, justifyContent: "center", padding: "1rem" }}
        >
          {allAssigned ? "Continue to Payment" : "Assign All Staff First"}
        </Button>
      </Actions>
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\StaffAssignmentModal.tsx
================================================================================

import React, { useState, useMemo } from "react";
import Modal from "../../ui/components/Modal";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import styled from "styled-components";
import { User, Search, Check, AlertCircle } from "lucide-react";
import type { CartItem } from "./api";

interface Staff {
  id: string;
  name: string;
  role: string;
  specialties?: string[];
  available: boolean;
}

interface StaffAssignmentModalProps {
  isOpen: boolean;
  onClose: () => void;
  cartItems: CartItem[];
  staff: Staff[];
  onAssignStaff: (
    itemId: string,
    itemType: string,
    staffId: string,
    staffName: string
  ) => void;
}

const Content = styled.div`
  display: grid;
  gap: 1.5rem;
`;

const TreatmentsList = styled.div`
  display: grid;
  gap: 1rem;
`;

const TreatmentCard = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
`;

const TreatmentHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
`;

const TreatmentInfo = styled.div`
  flex: 1;
`;

const TreatmentName = styled.div`
  font-weight: 700;
  font-size: 0.9375rem;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 0.25rem;
`;

const TreatmentClient = styled.div`
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const StaffStatus = styled.div<{ $assigned: boolean }>`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.375rem 0.75rem;
  background: ${({ $assigned, theme }) =>
    $assigned ? theme.color.green500 + "30" : theme.color.red500 + "30"};
  color: ${({ $assigned, theme }) =>
    $assigned ? theme.color.green500 : theme.color.red500};
  border-radius: ${({ theme }) => theme.radii.round};
  font-size: 0.75rem;
  font-weight: 700;
`;

const SearchBar = styled.div`
  position: relative;
  margin-top: 0.75rem;
`;

const SearchIcon = styled.div`
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: ${({ theme }) => theme.color.mutedText};
  pointer-events: none;
`;

const StaffList = styled.div`
  max-height: 300px;
  overflow-y: auto;
  display: grid;
  gap: 0.5rem;
  margin-top: 0.75rem;
`;

const StaffCard = styled.button<{ $selected: boolean; $disabled: boolean }>`
  padding: 0.875rem;
  background: ${({ $selected, theme }) =>
    $selected ? theme.color.brand500 : theme.color.panel};
  color: ${({ $selected, theme }) =>
    $selected ? "#ffffff" : theme.color.text};
  border: 1px solid
    ${({ $selected, theme }) =>
      $selected ? theme.color.brand600 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
  cursor: ${({ $disabled }) => ($disabled ? "not-allowed" : "pointer")};
  opacity: ${({ $disabled }) => ($disabled ? 0.5 : 1)};
  transition: all 0.2s;
  text-align: left;
  display: flex;
  justify-content: space-between;
  align-items: center;

  &:hover:not(:disabled) {
    border-color: ${({ theme }) => theme.color.brand500};
    background: ${({ $selected, theme }) =>
      $selected ? theme.color.brand600 : theme.color.brand50};
  }
`;

const StaffInfo = styled.div``;

const StaffName = styled.div`
  font-weight: 700;
  font-size: 0.875rem;
  margin-bottom: 0.125rem;
`;

const StaffRole = styled.div`
  font-size: 0.75rem;
  opacity: 0.8;
`;

const AvailabilityBadge = styled.div<{ $available: boolean }>`
  padding: 0.25rem 0.625rem;
  background: ${({ $available, theme }) =>
    $available ? theme.color.green500 + "30" : theme.color.grey300};
  color: ${({ $available, theme }) =>
    $available ? theme.color.green500 : theme.color.mutedText};
  border-radius: ${({ theme }) => theme.radii.round};
  font-size: 0.6875rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
`;

const EmptyState = styled.div`
  text-align: center;
  padding: 2rem 1rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const Warning = styled.div`
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 1rem;
  background: ${({ theme }) => theme.color.yellow100};
  border: 1px solid ${({ theme }) => theme.color.yellow700};
  border-radius: ${({ theme }) => theme.radii.md};
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.grey900};
`;

const Actions = styled.div`
  display: flex;
  gap: 0.75rem;
  padding-top: 0.5rem;
`;

export default function StaffAssignmentModal({
  isOpen,
  onClose,
  cartItems,
  staff,
  onAssignStaff,
}: StaffAssignmentModalProps) {
  const [expandedItem, setExpandedItem] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState("");
  const [tempAssignments, setTempAssignments] = useState<
    Record<string, { staffId: string; staffName: string }>
  >({});

  // Get treatments from cart (not products)
  const treatments = useMemo(
    () =>
      cartItems.filter(
        (item) => item.type === "treatment" || item.type === "appointment"
      ),
    [cartItems]
  );

  // Check if all treatments have staff assigned
  const allAssigned = useMemo(() => {
    return treatments.every((item) => {
      const key = `${item.id}-${item.type}`;
      return item.staffId || tempAssignments[key];
    });
  }, [treatments, tempAssignments]);

  // Filter staff
  const filteredStaff = useMemo(() => {
    if (!searchQuery.trim()) return staff;
    const query = searchQuery.toLowerCase();
    return staff.filter(
      (s) =>
        s.name.toLowerCase().includes(query) ||
        s.role.toLowerCase().includes(query) ||
        s.specialties?.some((spec) => spec.toLowerCase().includes(query))
    );
  }, [staff, searchQuery]);

  const handleSelectStaff = (
    itemId: string,
    itemType: string,
    staffId: string,
    staffName: string
  ) => {
    const key = `${itemId}-${itemType}`;
    setTempAssignments((prev) => ({
      ...prev,
      [key]: { staffId, staffName },
    }));
    setExpandedItem(null);
    setSearchQuery("");
  };

  const handleSaveAndContinue = () => {
    // Apply all temp assignments
    Object.entries(tempAssignments).forEach(([key, assignment]) => {
      const [itemId, itemType] = key.split("-");
      onAssignStaff(itemId, itemType, assignment.staffId, assignment.staffName);
    });
    onClose();
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title="Assign Staff Members"
      size="lg"
      ariaLabel="Assign staff to treatments"
    >
      <Content>
        {/* Warning if no treatments */}
        {treatments.length === 0 && (
          <Warning>
            <AlertCircle size={20} />
            <div>
              <strong>No treatments in cart</strong>
              <br />
              Staff assignment is only required for treatments and appointments,
              not retail products.
            </div>
          </Warning>
        )}

        {/* Treatment List */}
        <TreatmentsList>
          {treatments.map((item) => {
            const key = `${item.id}-${item.type}`;
            const assignedStaff = item.staffId || tempAssignments[key]?.staffId;
            const staffName = item.staffName || tempAssignments[key]?.staffName;
            const isExpanded = expandedItem === key;

            return (
              <TreatmentCard key={key}>
                <TreatmentHeader>
                  <TreatmentInfo>
                    <TreatmentName>{item.name}</TreatmentName>
                    {item.clientName && (
                      <TreatmentClient>{item.clientName}</TreatmentClient>
                    )}
                    {staffName && (
                      <div
                        style={{
                          marginTop: "0.5rem",
                          fontSize: "0.8125rem",
                          fontWeight: 600,
                        }}
                      >
                        Therapist: {staffName}
                      </div>
                    )}
                  </TreatmentInfo>
                  <StaffStatus $assigned={!!assignedStaff}>
                    {assignedStaff ? (
                      <>
                        <Check size={14} />
                        Assigned
                      </>
                    ) : (
                      <>
                        <AlertCircle size={14} />
                        Not Assigned
                      </>
                    )}
                  </StaffStatus>
                </TreatmentHeader>

                {/* Staff Selection */}
                {!isExpanded && (
                  <Button
                    variation="secondary"
                    onClick={() => setExpandedItem(key)}
                    size="small"
                    style={{ width: "100%", justifyContent: "center" }}
                  >
                    {assignedStaff ? "Change Therapist" : "Assign Therapist"}
                  </Button>
                )}

                {isExpanded && (
                  <>
                    <SearchBar>
                      <SearchIcon>
                        <Search size={18} />
                      </SearchIcon>
                      <Input
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Search staff..."
                        style={{ paddingLeft: "2.5rem", fontSize: "0.875rem" }}
                        autoFocus
                      />
                    </SearchBar>

                    <StaffList>
                      {filteredStaff.length === 0 ? (
                        <EmptyState>
                          <User
                            size={40}
                            style={{ margin: "0 auto 0.5rem", opacity: 0.3 }}
                          />
                          <p style={{ margin: 0, fontSize: "0.8125rem" }}>
                            No staff members found
                          </p>
                        </EmptyState>
                      ) : (
                        filteredStaff.map((staffMember) => (
                          <StaffCard
                            key={staffMember.id}
                            type="button"
                            $selected={assignedStaff === staffMember.id}
                            $disabled={!staffMember.available}
                            disabled={!staffMember.available}
                            onClick={() =>
                              handleSelectStaff(
                                item.id,
                                item.type,
                                staffMember.id,
                                staffMember.name
                              )
                            }
                          >
                            <StaffInfo>
                              <StaffName>{staffMember.name}</StaffName>
                              <StaffRole>{staffMember.role}</StaffRole>
                            </StaffInfo>
                            <AvailabilityBadge
                              $available={staffMember.available}
                            >
                              {staffMember.available
                                ? "Available"
                                : "Unavailable"}
                            </AvailabilityBadge>
                          </StaffCard>
                        ))
                      )}
                    </StaffList>

                    <Button
                      variation="secondary"
                      onClick={() => {
                        setExpandedItem(null);
                        setSearchQuery("");
                      }}
                      size="small"
                      style={{
                        width: "100%",
                        justifyContent: "center",
                        marginTop: "0.5rem",
                      }}
                    >
                      Cancel
                    </Button>
                  </>
                )}
              </TreatmentCard>
            );
          })}
        </TreatmentsList>

        {/* Actions */}
        {treatments.length > 0 && (
          <Actions>
            <Button
              variation="secondary"
              onClick={onClose}
              style={{ flex: 1, justifyContent: "center" }}
            >
              Cancel
            </Button>
            <Button
              variation="primary"
              onClick={handleSaveAndContinue}
              disabled={!allAssigned}
              style={{ flex: 1, justifyContent: "center" }}
            >
              {allAssigned ? "Continue to Checkout" : "Assign All First"}
            </Button>
          </Actions>
        )}
      </Content>
    </Modal>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\usePOS.ts
================================================================================

import { useResource } from "../../hooks/useResource";
import { posClient } from "../../services/posClient";
import type { Transaction, CreateTransactionInput } from "./POSSchema";

export function usePos() {
  return useResource<Transaction, CreateTransactionInput>({
    resourceKey: "pos",
    client: posClient,
    toastMessages: {
      create: "Transaction completed",
      update: "Transaction updated",
      delete: "Transaction removed",
    },
  });
}