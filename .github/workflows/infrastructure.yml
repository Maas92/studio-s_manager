# .github/workflows/infrastructure.yml
name: Deploy Infrastructure

on:
  push:
    branches:
      - main
      - staging
      - dev
    paths:
      - 'infrastructure/**'
  pull_request:
    paths:
      - 'infrastructure/**'

jobs:
  pulumi:
    name: Pulumi Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Install Pulumi CLI
        uses: pulumi/actions@v4
        
      - name: Install Dependencies
        working-directory: infrastructure
        run: npm ci
        
      - name: Select Pulumi Stack
        working-directory: infrastructure
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            pulumi stack select production --create
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            pulumi stack select staging --create
          else
            pulumi stack select dev --create
          fi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          
      - name: Pulumi Preview
        if: github.event_name == 'pull_request'
        working-directory: infrastructure
        run: pulumi preview
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          
      - name: Pulumi Up
        if: github.event_name == 'push'
        working-directory: infrastructure
        run: pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          
      - name: Export Outputs
        if: github.event_name == 'push'
        working-directory: infrastructure
        run: |
          pulumi stack output kubeconfig --show-secrets > kubeconfig.yaml
          pulumi stack output --json > outputs.json
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          
      - name: Upload Kubeconfig
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v3
        with:
          name: kubeconfig
          path: infrastructure/kubeconfig.yaml
          retention-days: 1

---
# .github/workflows/build-and-deploy.yml
name: Build and Deploy Application

on:
  push:
    branches:
      - main
      - staging
      - dev
    paths-ignore:
      - 'infrastructure/**'
      - '**.md'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/studio-s

jobs:
  # Build and push Docker images
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    strategy:
      matrix:
        service: [auth, backend, gateway, frontend]
        
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
  # Update Kubernetes manifests
  update-manifests:
    name: Update K8s Manifests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "tag=v${{ github.run_number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "tag=staging-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "tag=dev-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Update image tags
        run: |
          cd k8s/overlays/${{ steps.env.outputs.environment }}
          
          # Update kustomization.yaml with new image tags
          sed -i 's|newTag: .*|newTag: ${{ steps.env.outputs.tag }}|g' kustomization.yaml
          
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add k8s/overlays/${{ steps.env.outputs.environment }}/kustomization.yaml
          git commit -m "Update ${{ steps.env.outputs.environment }} images to ${{ steps.env.outputs.tag }}"
          git push
          
  # Notify ArgoCD (optional - ArgoCD will auto-detect changes)
  sync-argocd:
    name: Sync ArgoCD
    runs-on: ubuntu-latest
    needs: update-manifests
    if: github.event_name == 'push'
    
    steps:
      - name: Sync ArgoCD Application
        run: |
          # Install ArgoCD CLI
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          
          # Login to ArgoCD
          ./argocd login ${{ secrets.ARGOCD_SERVER }} \
            --username admin \
            --password ${{ secrets.ARGOCD_PASSWORD }} \
            --insecure
          
          # Sync application
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ./argocd app sync studio-s-production --force
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            ./argocd app sync studio-s-staging --force
          else
            ./argocd app sync studio-s-dev --force
          fi
          
          # Wait for sync to complete
          ./argocd app wait studio-s-${{ steps.env.outputs.environment }} --health

---
# .github/workflows/pr-preview.yml
name: PR Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - staging

jobs:
  deploy-preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Create preview namespace
        run: |
          kubectl create namespace pr-${{ github.event.pull_request.number }} --dry-run=client -o yaml | kubectl apply -f -
          
      - name: Deploy to preview
        run: |
          cd k8s/overlays/dev
          kustomize edit set namespace pr-${{ github.event.pull_request.number }}
          kustomize edit set namesuffix -pr-${{ github.event.pull_request.number }}
          kustomize build . | kubectl apply -f -
          
      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Preview environment deployed!\n\nURL: https://pr-${{ github.event.pull_request.number }}.yourdomain.com`
            })

---
# .github/workflows/security-scan.yml
name: Security Scanning

on:
  push:
    branches: [main, staging, dev]
  pull_request:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [auth, backend, gateway, frontend]
        
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './${{ matrix.service }}'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'
          
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
          
  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --severity-threshold=high