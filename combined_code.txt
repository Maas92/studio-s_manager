================================================================================
FILE: ./frontend/src/modules/POS\CheckoutModal.tsx
================================================================================

import React, { useState, useMemo, useCallback } from "react";
import Modal from "../../ui/components/Modal";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import styled from "styled-components";
import { CreditCard, Check, AlertCircle, X } from "lucide-react";
import type { CartItem } from "./api";

type PaymentMethod = "cash" | "card" | "split";

interface CheckoutModalProps {
  isOpen: boolean;
  onClose: () => void;
  total: number;
  onComplete: (paymentMethod: PaymentMethod, cashReceived?: number) => void;
  processing?: boolean;
}

const Content = styled.div`
  display: grid;
  gap: 1.5rem;
`;

const TotalDisplay = styled.div`
  background: ${({ theme }) => theme.color.brand50};
  border-radius: ${({ theme }) => theme.radii.md};
  padding: 1.5rem;
  text-align: center;
  border: 1px solid ${({ theme }) => theme.color.brand200};
`;

const TotalLabel = styled.div`
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
`;

const TotalAmount = styled.div`
  font-size: 3rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.brand600};
  line-height: 1;
`;

const Section = styled.div`
  display: grid;
  gap: 0.75rem;
`;

const Label = styled.label`
  display: block;
  font-size: 0.875rem;
  font-weight: 600;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 0.5rem;
`;

const PaymentMethodGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
`;

const PaymentMethodButton = styled.button<{ $active: boolean }>`
  padding: 1rem;
  background: ${({ $active, theme }) =>
    $active ? theme.color.brand500 : theme.color.grey100};
  color: ${({ $active, theme }) => ($active ? "#ffffff" : theme.color.text)};
  border: 2px solid
    ${({ $active, theme }) =>
      $active ? theme.color.brand600 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
  font-size: 0.875rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: capitalize;

  &:hover {
    border-color: ${({ theme }) => theme.color.brand500};
  }
`;

const QuickAmountGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.5rem;
`;

const QuickAmountButton = styled.button`
  padding: 0.75rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  color: ${({ theme }) => theme.color.text};
  transition: all 0.2s;

  &:hover {
    background: ${({ theme }) => theme.color.grey200};
    border-color: ${({ theme }) => theme.color.brand500};
  }
`;

const ChangeDisplay = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.green500}20;
  border-radius: ${({ theme }) => theme.radii.md};
  border: 1px solid ${({ theme }) => theme.color.green500}40;
`;

const ChangeLabel = styled.div`
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin-bottom: 0.25rem;
`;

const ChangeAmount = styled.div`
  font-size: 1.75rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.green500};
`;

const ErrorMessage = styled.div`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.red500};
  margin-top: 0.75rem;
`;

const SUGGESTED_AMOUNTS = [50, 80, 100, 110, 150];

export default function CheckoutModal({
  isOpen,
  onClose,
  total,
  onComplete,
  processing = false,
}: CheckoutModalProps) {
  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>("card");
  const [cashAmount, setCashAmount] = useState("");

  const change = useMemo(() => {
    const cash = parseFloat(cashAmount) || 0;
    return Math.max(0, cash - total);
  }, [cashAmount, total]);

  const isInsufficientCash = useMemo(() => {
    if (paymentMethod !== "cash") return false;
    const cash = parseFloat(cashAmount) || 0;
    return cash > 0 && cash < total;
  }, [paymentMethod, cashAmount, total]);

  const canComplete = useMemo(() => {
    if (paymentMethod === "cash") {
      const cash = parseFloat(cashAmount) || 0;
      return cash >= total;
    }
    return true;
  }, [paymentMethod, cashAmount, total]);

  const handleComplete = useCallback(() => {
    if (!canComplete || processing) return;

    const cashReceived =
      paymentMethod === "cash" ? parseFloat(cashAmount) : undefined;
    onComplete(paymentMethod, cashReceived);
  }, [canComplete, processing, paymentMethod, cashAmount, total, onComplete]);

  const handleQuickAmount = useCallback((amount: number) => {
    setCashAmount(amount.toString());
  }, []);

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title="Checkout"
      size="md"
      ariaLabel="Checkout payment"
    >
      <Content>
        {/* Total Display */}
        <TotalDisplay>
          <TotalLabel>Total Amount</TotalLabel>
          <TotalAmount>${total.toFixed(2)}</TotalAmount>
        </TotalDisplay>

        {/* Payment Method Selection */}
        <Section>
          <Label>Payment Method</Label>
          <PaymentMethodGrid>
            <PaymentMethodButton
              type="button"
              $active={paymentMethod === "card"}
              onClick={() => setPaymentMethod("card")}
            >
              Card
            </PaymentMethodButton>
            <PaymentMethodButton
              type="button"
              $active={paymentMethod === "cash"}
              onClick={() => setPaymentMethod("cash")}
            >
              Cash
            </PaymentMethodButton>
            <PaymentMethodButton
              type="button"
              $active={paymentMethod === "split"}
              onClick={() => setPaymentMethod("split")}
            >
              Split
            </PaymentMethodButton>
          </PaymentMethodGrid>
        </Section>

        {/* Cash Payment Fields */}
        {paymentMethod === "cash" && (
          <Section>
            <Label htmlFor="cash-received">Cash Received</Label>
            <Input
              id="cash-received"
              type="number"
              step="0.01"
              min="0"
              value={cashAmount}
              onChange={(e) => setCashAmount(e.target.value)}
              placeholder="0.00"
              style={{ fontSize: "1.125rem" }}
              autoFocus
            />

            {/* Quick Amount Buttons */}
            <QuickAmountGrid>
              {SUGGESTED_AMOUNTS.map((amount) => (
                <QuickAmountButton
                  key={amount}
                  type="button"
                  onClick={() => handleQuickAmount(amount)}
                >
                  ${amount}
                </QuickAmountButton>
              ))}
            </QuickAmountGrid>

            {/* Change Display */}
            {cashAmount && parseFloat(cashAmount) >= total && (
              <ChangeDisplay>
                <ChangeLabel>Change Due</ChangeLabel>
                <ChangeAmount>${change.toFixed(2)}</ChangeAmount>
              </ChangeDisplay>
            )}
          </Section>
        )}

        {/* Complete Payment Button */}
        <Button
          type="button"
          onClick={handleComplete}
          disabled={!canComplete || processing}
          variation="primary"
          style={{
            width: "100%",
            padding: "1rem",
            fontSize: "1rem",
            justifyContent: "center",
            display: "flex",
            alignItems: "center",
            gap: "0.5rem",
          }}
        >
          {processing ? (
            "Processing..."
          ) : (
            <>
              <Check size={20} />
              Complete Payment
            </>
          )}
        </Button>

        {/* Error Message */}
        {isInsufficientCash && (
          <ErrorMessage>
            <AlertCircle size={16} />
            Insufficient cash amount
          </ErrorMessage>
        )}
      </Content>
    </Modal>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\ClientSelection.tsx
================================================================================

import React, { useState, useMemo } from "react";
import styled from "styled-components";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import {
  User,
  Calendar,
  Search,
  UserPlus,
  ArrowRight,
  Check,
  AlertCircle,
  Phone,
  Mail,
} from "lucide-react";

interface Client {
  id: string;
  name: string;
  email?: string;
  phone?: string;
  loyaltyPoints: number;
}

interface Appointment {
  id: string;
  clientId: string;
  clientName: string;
  treatmentName: string;
  time: string;
  staffName: string;
}

interface ClientSelectionProps {
  clients: Client[];
  appointments: Appointment[];
  onSelectClient: (
    clientId: string,
    clientType: "booked" | "walk-in",
    appointmentId?: string,
    verified?: boolean
  ) => void;
  onCreateNew: () => void;
}

const Container = styled.div`
  display: grid;
  gap: 2rem;
  max-width: 900px;
  margin: 0 auto;
`;

const Title = styled.h2`
  font-size: 1.75rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.5rem 0;
`;

const Subtitle = styled.p`
  font-size: 1rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0 0 2rem 0;
`;

const TypeSelection = styled.div`
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
`;

const TypeCard = styled.button<{ $selected: boolean }>`
  padding: 2.5rem 2rem;
  background: ${({ $selected, theme }) =>
    $selected ? theme.color.brand50 : theme.color.grey100};
  border: 2px solid
    ${({ $selected, theme }) =>
      $selected ? theme.color.brand500 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  text-align: center;

  &:hover {
    border-color: ${({ theme }) => theme.color.brand500};
    transform: translateY(-4px);
    box-shadow: ${({ theme }) => theme.shadowLg};
  }
`;

const IconWrapper = styled.div<{ $selected: boolean }>`
  width: 80px;
  height: 80px;
  border-radius: ${({ theme }) => theme.radii.round};
  background: ${({ $selected, theme }) =>
    $selected ? theme.color.brand500 : theme.color.grey200};
  color: ${({ $selected }) => ($selected ? "#ffffff" : "#6b7280")};
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
`;

const TypeTitle = styled.div`
  font-size: 1.25rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
`;

const TypeDescription = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const Divider = styled.div`
  height: 1px;
  background: ${({ theme }) => theme.color.border};
  margin: 1rem 0;
`;

const SearchSection = styled.div`
  display: grid;
  gap: 1.5rem;
`;

const SectionTitle = styled.h3`
  font-size: 1.125rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.5rem 0;
`;

const SectionSubtitle = styled.p`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0;
`;

const SearchBar = styled.div`
  position: relative;
`;

const SearchIcon = styled.div`
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: ${({ theme }) => theme.color.mutedText};
  pointer-events: none;
`;

const ItemGrid = styled.div`
  display: grid;
  gap: 1rem;
  max-height: 400px;
  overflow-y: auto;
`;

const ItemCard = styled.button<{ $highlighted?: boolean }>`
  padding: 1.25rem;
  background: ${({ $highlighted, theme }) =>
    $highlighted ? theme.color.brand50 : theme.color.grey100};
  border: 1px solid
    ${({ $highlighted, theme }) =>
      $highlighted ? theme.color.brand500 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
  display: flex;
  justify-content: space-between;
  align-items: center;

  &:hover {
    border-color: ${({ theme }) => theme.color.brand500};
    background: ${({ theme }) => theme.color.brand50};
    transform: translateX(4px);
  }
`;

const ItemInfo = styled.div`
  flex: 1;
`;

const ItemName = styled.div`
  font-weight: 700;
  font-size: 1rem;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 0.25rem;
`;

const ItemDetails = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
  display: flex;
  flex-direction: column;
  gap: 0.125rem;
`;

const ItemMeta = styled.div`
  display: flex;
  align-items: center;
  gap: 0.375rem;
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const Badge = styled.div<{ $variant?: "success" | "primary" }>`
  padding: 0.5rem 1rem;
  background: ${({ $variant, theme }) =>
    $variant === "success"
      ? theme.color.green500 + "30"
      : theme.color.brand500 + "30"};
  color: ${({ $variant, theme }) =>
    $variant === "success" ? theme.color.green500 : theme.color.brand600};
  border-radius: ${({ theme }) => theme.radii.round};
  font-size: 0.875rem;
  font-weight: 700;
  white-space: nowrap;
`;

const EmptyState = styled.div`
  text-align: center;
  padding: 4rem 2rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const VerificationBox = styled.div`
  padding: 1.25rem;
  background: ${({ theme }) => theme.color.yellow100};
  border: 1px solid ${({ theme }) => theme.color.yellow700};
  border-radius: ${({ theme }) => theme.radii.md};
  display: flex;
  align-items: start;
  gap: 0.75rem;
`;

const Actions = styled.div`
  display: flex;
  gap: 1rem;
  padding-top: 1rem;
`;

export default function ClientSelection({
  clients,
  appointments,
  onSelectClient,
  onCreateNew,
}: ClientSelectionProps) {
  const [clientType, setClientType] = useState<"booked" | "walk-in" | null>(
    null
  );
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedClientId, setSelectedClientId] = useState<string | null>(null);
  const [selectedAppointmentId, setSelectedAppointmentId] = useState<
    string | null
  >(null);
  const [requiresVerification, setRequiresVerification] = useState(false);

  const filteredAppointments = useMemo(() => {
    if (!searchQuery.trim()) return appointments;
    const query = searchQuery.toLowerCase();
    return appointments.filter(
      (apt) =>
        apt.clientName.toLowerCase().includes(query) ||
        apt.treatmentName.toLowerCase().includes(query)
    );
  }, [appointments, searchQuery]);

  const filteredClients = useMemo(() => {
    if (!searchQuery.trim()) return clients;
    const query = searchQuery.toLowerCase();
    return clients.filter(
      (client) =>
        client.name.toLowerCase().includes(query) ||
        client.email?.toLowerCase().includes(query) ||
        client.phone?.includes(query)
    );
  }, [clients, searchQuery]);

  const selectedClient = useMemo(() => {
    if (!selectedClientId) return null;
    return clients.find((c) => c.id === selectedClientId);
  }, [selectedClientId, clients]);

  const handleSelectAppointment = (apt: Appointment) => {
    setSelectedClientId(apt.clientId);
    setSelectedAppointmentId(apt.id);
    setRequiresVerification(false);
  };

  const handleSelectWalkInClient = (client: Client) => {
    setSelectedClientId(client.id);
    setRequiresVerification(true);
  };

  const handleConfirmVerification = () => {
    if (selectedClientId) {
      onSelectClient(
        selectedClientId,
        clientType!,
        selectedAppointmentId || undefined,
        true
      );
    }
  };

  const handleContinueBooked = () => {
    if (selectedClientId && selectedAppointmentId) {
      onSelectClient(selectedClientId, "booked", selectedAppointmentId, true);
    }
  };

  return (
    <Container>
      <div>
        <Title>Select Client Type</Title>
        <Subtitle>
          Choose whether this is a booked appointment or a walk-in customer
        </Subtitle>
      </div>

      <TypeSelection>
        <TypeCard
          type="button"
          $selected={clientType === "booked"}
          onClick={() => {
            setClientType("booked");
            setSelectedClientId(null);
            setSelectedAppointmentId(null);
            setSearchQuery("");
          }}
        >
          <IconWrapper $selected={clientType === "booked"}>
            <Calendar size={40} />
          </IconWrapper>
          <div>
            <TypeTitle>Booked Client</TypeTitle>
            <TypeDescription>Client with an appointment</TypeDescription>
          </div>
        </TypeCard>

        <TypeCard
          type="button"
          $selected={clientType === "walk-in"}
          onClick={() => {
            setClientType("walk-in");
            setSelectedClientId(null);
            setSelectedAppointmentId(null);
            setSearchQuery("");
          }}
        >
          <IconWrapper $selected={clientType === "walk-in"}>
            <User size={40} />
          </IconWrapper>
          <div>
            <TypeTitle>Walk-in Client</TypeTitle>
            <TypeDescription>Client without appointment</TypeDescription>
          </div>
        </TypeCard>
      </TypeSelection>

      {/* Booked Appointments */}
      {clientType === "booked" && (
        <>
          <Divider />
          <SearchSection>
            <div>
              <SectionTitle>Select Today's Appointment</SectionTitle>
              <SectionSubtitle>
                Choose the appointment to check in and process
              </SectionSubtitle>
            </div>

            <SearchBar>
              <SearchIcon>
                <Search size={20} />
              </SearchIcon>
              <Input
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search by client name or treatment..."
                style={{ paddingLeft: "3rem" }}
              />
            </SearchBar>

            <ItemGrid>
              {!filteredAppointments || filteredAppointments.length === 0 ? (
                <EmptyState>
                  <Calendar
                    size={48}
                    style={{ margin: "0 auto 1rem", opacity: 0.3 }}
                  />
                  <p style={{ margin: 0, fontSize: "0.875rem" }}>
                    {searchQuery
                      ? "No appointments found"
                      : "No appointments today"}
                  </p>
                </EmptyState>
              ) : (
                filteredAppointments.map((apt) => (
                  <ItemCard
                    key={apt.id}
                    type="button"
                    $highlighted={selectedAppointmentId === apt.id}
                    onClick={() => handleSelectAppointment(apt)}
                  >
                    <ItemInfo>
                      <ItemName>{apt.clientName}</ItemName>
                      <ItemDetails>
                        <div>{apt.treatmentName}</div>
                        <ItemMeta>
                          <Calendar size={14} />
                          {apt.time}
                        </ItemMeta>
                        <ItemMeta>
                          <User size={14} />
                          {apt.staffName}
                        </ItemMeta>
                      </ItemDetails>
                    </ItemInfo>
                    {selectedAppointmentId === apt.id && (
                      <Badge $variant="success">
                        <Check size={16} style={{ marginRight: "0.25rem" }} />
                        Selected
                      </Badge>
                    )}
                  </ItemCard>
                ))
              )}
            </ItemGrid>

            {selectedAppointmentId && (
              <Actions>
                <Button
                  variation="primary"
                  icon={<ArrowRight size={20} />}
                  onClick={handleContinueBooked}
                  style={{
                    flex: 1,
                    justifyContent: "center",
                    padding: "1rem",
                    fontSize: "1rem",
                  }}
                >
                  Check In & Continue
                </Button>
              </Actions>
            )}
          </SearchSection>
        </>
      )}

      {/* Walk-in Clients */}
      {clientType === "walk-in" && (
        <>
          <Divider />
          <SearchSection>
            <div>
              <SectionTitle>Select Existing Client</SectionTitle>
              <SectionSubtitle>
                Search for an existing client or create a new one
              </SectionSubtitle>
            </div>

            <SearchBar>
              <SearchIcon>
                <Search size={20} />
              </SearchIcon>
              <Input
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search by name, email, or phone..."
                style={{ paddingLeft: "3rem" }}
              />
            </SearchBar>

            <ItemGrid>
              {filteredClients.length === 0 ? (
                <EmptyState>
                  <User
                    size={48}
                    style={{ margin: "0 auto 1rem", opacity: 0.3 }}
                  />
                  <p style={{ margin: 0, fontSize: "0.875rem" }}>
                    {searchQuery ? "No clients found" : "No clients available"}
                  </p>
                </EmptyState>
              ) : (
                filteredClients.map((client) => (
                  <ItemCard
                    key={client.id}
                    type="button"
                    $highlighted={selectedClientId === client.id}
                    onClick={() => handleSelectWalkInClient(client)}
                  >
                    <ItemInfo>
                      <ItemName>{client.name}</ItemName>
                      <ItemDetails>
                        {client.email && (
                          <ItemMeta>
                            <Mail size={14} />
                            {client.email}
                          </ItemMeta>
                        )}
                        {client.phone && (
                          <ItemMeta>
                            <Phone size={14} />
                            {client.phone}
                          </ItemMeta>
                        )}
                      </ItemDetails>
                    </ItemInfo>
                    <div
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        gap: "0.5rem",
                        alignItems: "flex-end",
                      }}
                    >
                      {selectedClientId === client.id && (
                        <Badge $variant="success">
                          <Check size={16} style={{ marginRight: "0.25rem" }} />
                          Selected
                        </Badge>
                      )}
                      <Badge $variant="primary">
                        {client.loyaltyPoints} pts
                      </Badge>
                    </div>
                  </ItemCard>
                ))
              )}
            </ItemGrid>

            {requiresVerification && selectedClient && (
              <VerificationBox>
                <AlertCircle size={20} color="#a16207" />
                <div style={{ flex: 1 }}>
                  <div
                    style={{
                      fontWeight: 700,
                      marginBottom: "0.25rem",
                      color: "#1f2937",
                    }}
                  >
                    Verify Client Identity
                  </div>
                  <div style={{ fontSize: "0.875rem", color: "#4b5563" }}>
                    Please verify this is <strong>{selectedClient.name}</strong>{" "}
                    before continuing.
                  </div>
                </div>
              </VerificationBox>
            )}

            <Actions>
              <Button
                variation="secondary"
                icon={<UserPlus size={20} />}
                onClick={onCreateNew}
                style={{ flex: 1, justifyContent: "center", padding: "1rem" }}
              >
                Create New Client
              </Button>
              {requiresVerification && selectedClient && (
                <Button
                  variation="primary"
                  icon={<Check size={20} />}
                  onClick={handleConfirmVerification}
                  style={{ flex: 1, justifyContent: "center", padding: "1rem" }}
                >
                  Verify & Continue
                </Button>
              )}
            </Actions>
          </SearchSection>
        </>
      )}
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\CreateClientModal.tsx
================================================================================

import React, { useState, useCallback } from "react";
import Modal from "../../ui/components/Modal";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import styled from "styled-components";
import { UserPlus, AlertCircle } from "lucide-react";
import type { CreateClientInput } from "./api";

interface CreateClientModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (client: CreateClientInput) => void;
  submitting?: boolean;
}

const Content = styled.div`
  display: grid;
  gap: 1.25rem;
`;

const FormField = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
`;

const Label = styled.label`
  display: block;
  font-weight: 600;
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.text};
`;

const Required = styled.span`
  color: ${({ theme }) => theme.color.red500};
  margin-left: 0.25rem;
`;

const ErrorMessage = styled.div`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.red500};
  margin-top: 0.25rem;
`;

const Actions = styled.div`
  display: flex;
  gap: 0.75rem;
  padding-top: 0.5rem;
`;

const InfoText = styled.div`
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.mutedText};
  padding: 1rem;
  background: ${({ theme }) => theme.color.brand50};
  border-radius: ${({ theme }) => theme.radii.md};
  border: 1px solid ${({ theme }) => theme.color.brand200};
`;

export default function CreateClientModal({
  isOpen,
  onClose,
  onSubmit,
  submitting = false,
}: CreateClientModalProps) {
  const [formData, setFormData] = useState<CreateClientInput>({
    name: "",
    phone: "",
    email: "",
    loyaltyPoints: 0,
  });
  const [errors, setErrors] = useState<Record<string, string>>({});

  const validateForm = useCallback((): boolean => {
    const newErrors: Record<string, string> = {};

    if (!formData.name.trim()) {
      newErrors.name = "Name is required";
    }

    if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      newErrors.email = "Please enter a valid email address";
    }

    if (formData.phone && !/^[\d\s\-\+\(\)]+$/.test(formData.phone)) {
      newErrors.phone = "Please enter a valid phone number";
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [formData]);

  const handleSubmit = useCallback(() => {
    if (!validateForm()) return;
    onSubmit(formData);
  }, [formData, validateForm, onSubmit]);

  const handleClose = useCallback(() => {
    setFormData({
      name: "",
      phone: "",
      email: "",
      loyaltyPoints: 0,
    });
    setErrors({});
    onClose();
  }, [onClose]);

  return (
    <Modal
      isOpen={isOpen}
      onClose={handleClose}
      title="Create New Client"
      size="md"
      ariaLabel="Create new client"
    >
      <Content>
        <InfoText>
          Create a new client profile to track their appointments, purchases,
          and loyalty points.
        </InfoText>

        {/* Name */}
        <FormField>
          <Label htmlFor="client-name">
            Full Name
            <Required>*</Required>
          </Label>
          <Input
            id="client-name"
            value={formData.name}
            onChange={(e) => {
              setFormData((prev) => ({ ...prev, name: e.target.value }));
              if (errors.name) setErrors((prev) => ({ ...prev, name: "" }));
            }}
            placeholder="e.g., Sarah Johnson"
            autoFocus
          />
          {errors.name && (
            <ErrorMessage>
              <AlertCircle size={14} />
              {errors.name}
            </ErrorMessage>
          )}
        </FormField>

        {/* Phone */}
        <FormField>
          <Label htmlFor="client-phone">Phone Number</Label>
          <Input
            id="client-phone"
            type="tel"
            value={formData.phone}
            onChange={(e) => {
              setFormData((prev) => ({ ...prev, phone: e.target.value }));
              if (errors.phone) setErrors((prev) => ({ ...prev, phone: "" }));
            }}
            placeholder="e.g., 555-0101"
          />
          {errors.phone && (
            <ErrorMessage>
              <AlertCircle size={14} />
              {errors.phone}
            </ErrorMessage>
          )}
        </FormField>

        {/* Email */}
        <FormField>
          <Label htmlFor="client-email">Email Address</Label>
          <Input
            id="client-email"
            type="email"
            value={formData.email}
            onChange={(e) => {
              setFormData((prev) => ({ ...prev, email: e.target.value }));
              if (errors.email) setErrors((prev) => ({ ...prev, email: "" }));
            }}
            placeholder="e.g., sarah@email.com"
          />
          {errors.email && (
            <ErrorMessage>
              <AlertCircle size={14} />
              {errors.email}
            </ErrorMessage>
          )}
        </FormField>

        {/* Actions */}
        <Actions>
          <Button
            variation="secondary"
            onClick={handleClose}
            disabled={submitting}
            style={{ flex: 1, justifyContent: "center" }}
          >
            Cancel
          </Button>
          <Button
            variation="primary"
            onClick={handleSubmit}
            disabled={submitting || !formData.name.trim()}
            icon={<UserPlus size={18} />}
            style={{ flex: 1, justifyContent: "center" }}
          >
            {submitting ? "Creating..." : "Create Client"}
          </Button>
        </Actions>
      </Content>
    </Modal>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\ItemSelection.tsx
================================================================================

import React, { useState, useMemo } from "react";
import styled from "styled-components";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import {
  Calendar,
  Clock,
  Package,
  Plus,
  Minus,
  Trash2,
  Search,
  ShoppingCart,
  ArrowRight,
  ArrowLeft,
  AlertCircle,
  CheckCircle,
  MessageSquare,
} from "lucide-react";
import type { CartItem, CartValidation } from "./api";
import { validateAddToCart } from "./api";

interface ItemSelectionProps {
  clientType: "booked" | "walk-in";
  clientName?: string;
  appointments: any[];
  treatments: any[];
  products: any[];
  cart: CartItem[];
  productStock: Record<string, number>;
  onAddToCart: (
    item: Omit<CartItem, "quantity">,
    validation: CartValidation
  ) => void;
  onUpdateQuantity: (id: string, type: string, delta: number) => void;
  onRemoveFromCart: (id: string, type: string) => void;
  onUpdateNotes: (id: string, type: string, notes: string) => void;
  onNext: () => void;
  onBack: () => void;
}

const Container = styled.div`
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 2rem;
  height: 100%;

  @media (max-width: 1024px) {
    grid-template-columns: 1fr;
  }
`;

const LeftPanel = styled.div`
  display: grid;
  gap: 1.5rem;
`;

const Title = styled.h2`
  font-size: 1.75rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.text};
  margin: 0;
`;

const ClientBanner = styled.div`
  padding: 1rem 1.25rem;
  background: ${({ theme }) => theme.color.brand50};
  border: 1px solid ${({ theme }) => theme.color.brand200};
  border-radius: ${({ theme }) => theme.radii.md};
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.text};
  display: flex;
  align-items: center;
  justify-content: space-between;
`;

const SearchBar = styled.div`
  position: relative;
`;

const SearchIcon = styled.div`
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: ${({ theme }) => theme.color.mutedText};
  pointer-events: none;
`;

const Tabs = styled.div`
  display: flex;
  gap: 0.5rem;
  border-bottom: 1px solid ${({ theme }) => theme.color.border};
`;

const Tab = styled.button<{ $active: boolean }>`
  flex: 1;
  padding: 0.875rem 1rem;
  background: transparent;
  border: none;
  border-bottom: 2px solid
    ${({ $active, theme }) => ($active ? theme.color.brand500 : "transparent")};
  color: ${({ $active, theme }) =>
    $active ? theme.color.brand500 : theme.color.mutedText};
  font-size: 0.875rem;
  font-weight: ${({ $active }) => ($active ? 700 : 500)};
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;

  &:hover {
    color: ${({ theme }) => theme.color.brand500};
  }
`;

const Badge = styled.span<{
  $variant?: "primary" | "success" | "warning" | "danger";
}>`
  display: inline-flex;
  align-items: center;
  padding: 0.125rem 0.5rem;
  border-radius: ${({ theme }) => theme.radii.round};
  font-size: 0.75rem;
  font-weight: 600;
  background: ${({ $variant, theme }) => {
    switch ($variant) {
      case "success":
        return theme.color.green500 + "30";
      case "warning":
        return theme.color.yellow100;
      case "danger":
        return theme.color.red500 + "30";
      default:
        return theme.color.brand500 + "30";
    }
  }};
  color: ${({ $variant, theme }) => {
    switch ($variant) {
      case "success":
        return theme.color.green500;
      case "warning":
        return theme.color.yellow700;
      case "danger":
        return theme.color.red500;
      default:
        return theme.color.brand500;
    }
  }};
`;

const ContentArea = styled.div`
  max-height: 500px;
  overflow-y: auto;
`;

const ItemGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
`;

const ItemCard = styled.button<{ $disabled?: boolean; $inCart?: boolean }>`
  padding: 1.25rem;
  background: ${({ $inCart, theme }) =>
    $inCart ? theme.color.green500 + "10" : theme.color.grey100};
  border: 1px solid
    ${({ $inCart, theme }) =>
      $inCart ? theme.color.green500 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
  cursor: ${({ $disabled }) => ($disabled ? "not-allowed" : "pointer")};
  opacity: ${({ $disabled }) => ($disabled ? 0.5 : 1)};
  transition: all 0.2s;
  text-align: left;

  &:hover:not(:disabled) {
    border-color: ${({ theme }) => theme.color.brand500};
    background: ${({ $inCart, theme }) =>
      $inCart ? theme.color.green500 + "20" : theme.color.brand50};
    transform: translateY(-2px);
  }
`;

const ItemName = styled.div`
  font-weight: 700;
  font-size: 0.9375rem;
  margin-bottom: 0.5rem;
  color: ${({ theme }) => theme.color.text};
`;

const ItemMeta = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const ItemFooter = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
`;

const ItemPrice = styled.div`
  font-size: 1.25rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.brand500};
`;

const ItemStatus = styled.div<{ $type: "inCart" | "lowStock" | "outOfStock" }>`
  display: flex;
  align-items: center;
  gap: 0.375rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: ${({ $type, theme }) => {
    switch ($type) {
      case "inCart":
        return theme.color.green500;
      case "lowStock":
        return theme.color.yellow700;
      case "outOfStock":
        return theme.color.red500;
    }
  }};
`;

const RightPanel = styled.div`
  background: ${({ theme }) => theme.color.grey50};
  border: 2px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  height: fit-content;
  position: sticky;
  top: 0;
`;

const CartTitle = styled.h3`
  font-size: 1.125rem;
  font-weight: 800;
  margin: 0 0 1.25rem 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: ${({ theme }) => theme.color.text};
`;

const CartItems = styled.div`
  flex: 1;
  max-height: 450px;
  overflow-y: auto;
  margin-bottom: 1.25rem;
`;

const EmptyCart = styled.div`
  text-align: center;
  padding: 3rem 1rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const CartItemList = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
`;

const CartItemCard = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
`;

const CartItemHeader = styled.div`
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.75rem;
`;

const CartItemName = styled.div`
  font-weight: 700;
  font-size: 0.9375rem;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 0.25rem;
`;

const CartItemMeta = styled.div`
  font-size: 0.75rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const CartItemFooter = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0.75rem;
`;

const QuantityControls = styled.div`
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const QuantityButton = styled.button`
  width: 1.75rem;
  height: 1.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background: ${({ theme }) => theme.color.grey200};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
  cursor: pointer;
  color: ${({ theme }) => theme.color.text};
  transition: all 0.2s;

  &:hover {
    background: ${({ theme }) => theme.color.grey300};
  }
`;

const CartItemPrice = styled.div`
  font-weight: 800;
  font-size: 1rem;
  color: ${({ theme }) => theme.color.brand500};
`;

const NotesButton = styled.button`
  padding: 0.5rem 0.75rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
  font-size: 0.75rem;
  color: ${({ theme }) => theme.color.text};
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.375rem;
  margin-top: 0.5rem;
  transition: all 0.2s;

  &:hover {
    background: ${({ theme }) => theme.color.grey200};
  }
`;

const NotesInput = styled.textarea`
  width: 100%;
  padding: 0.5rem;
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
  color: ${({ theme }) => theme.color.text};
  font-size: 0.8125rem;
  margin-top: 0.5rem;
  min-height: 60px;
  resize: vertical;
  font-family: inherit;

  &:focus {
    outline: none;
    border-color: ${({ theme }) => theme.color.brand500};
  }
`;

const Actions = styled.div`
  display: flex;
  gap: 0.75rem;
  padding-top: 1rem;
  border-top: 2px solid ${({ theme }) => theme.color.border};
`;

const Warning = styled.div`
  display: flex;
  align-items: start;
  gap: 0.75rem;
  padding: 0.875rem;
  background: ${({ theme }) => theme.color.yellow100};
  border: 1px solid ${({ theme }) => theme.color.yellow700};
  border-radius: ${({ theme }) => theme.radii.sm};
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.grey900};
  margin-bottom: 0.75rem;
`;

type ActiveTab = "appointments" | "treatments" | "products";

export default function ItemSelection({
  clientType,
  clientName,
  appointments,
  treatments,
  products,
  cart,
  productStock,
  onAddToCart,
  onUpdateQuantity,
  onRemoveFromCart,
  onUpdateNotes,
  onNext,
  onBack,
}: ItemSelectionProps) {
  const [activeTab, setActiveTab] = useState<ActiveTab>(
    clientType === "booked" ? "appointments" : "treatments"
  );
  const [searchQuery, setSearchQuery] = useState("");
  const [editingNotes, setEditingNotes] = useState<string | null>(null);

  const filteredAppointments = useMemo(
    () =>
      appointments.filter(
        (apt) =>
          apt.clientName.toLowerCase().includes(searchQuery.toLowerCase()) ||
          apt.treatmentName.toLowerCase().includes(searchQuery.toLowerCase())
      ),
    [appointments, searchQuery]
  );

  const filteredTreatments = useMemo(
    () =>
      treatments.filter(
        (t) =>
          t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          t.category?.toLowerCase().includes(searchQuery.toLowerCase())
      ),
    [treatments, searchQuery]
  );

  const filteredProducts = useMemo(
    () =>
      products.filter(
        (p) =>
          p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          p.category?.toLowerCase().includes(searchQuery.toLowerCase())
      ),
    [products, searchQuery]
  );

  const isItemInCart = (id: string, type: string) => {
    // Only check for appointments (can't duplicate same appointment)
    // Treatments can be added multiple times
    if (type === "appointment") {
      return cart.some((item) => item.id === id && item.type === type);
    }
    return false;
  };

  const handleAddToCart = async (item: Omit<CartItem, "quantity">) => {
    const validation = validateAddToCart(item, cart, productStock);

    if (!validation.canAdd) {
      // Show error toast
      const toast = (await import("react-hot-toast")).default;
      toast.error(validation.reason || "Cannot add item to cart");
      return;
    }

    if (validation.warnings && validation.warnings.length > 0) {
      // Show warning toast
      const toast = (await import("react-hot-toast")).default;
      validation.warnings.forEach((warning) => {
        toast.warning(warning, { duration: 3000 });
      });
    }

    onAddToCart(item, validation);
  };

  const getProductStockStatus = (productId: string) => {
    const stock = productStock[productId] || 0;
    const inCart = cart
      .filter((i) => i.id === productId && i.type === "product")
      .reduce((sum, i) => sum + i.quantity, 0);
    const available = stock - inCart;

    if (available <= 0) return { status: "outOfStock", available: 0 };
    if (available <= 5) return { status: "lowStock", available };
    return { status: "inStock", available };
  };

  return (
    <Container>
      <LeftPanel>
        <div>
          <Title>Add Items to Cart</Title>
          {clientName && (
            <ClientBanner>
              <span>
                <strong>Client:</strong> {clientName}
              </span>
            </ClientBanner>
          )}
        </div>

        <SearchBar>
          <SearchIcon>
            <Search size={20} />
          </SearchIcon>
          <Input
            placeholder="Search items..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            style={{ paddingLeft: "3rem" }}
          />
        </SearchBar>

        <Tabs>
          {clientType === "booked" && (
            <Tab
              $active={activeTab === "appointments"}
              onClick={() => setActiveTab("appointments")}
            >
              <Calendar size={16} />
              Appointments
              <Badge>{appointments.length}</Badge>
            </Tab>
          )}
          <Tab
            $active={activeTab === "treatments"}
            onClick={() => setActiveTab("treatments")}
          >
            <Clock size={16} />
            Treatments
          </Tab>
          <Tab
            $active={activeTab === "products"}
            onClick={() => setActiveTab("products")}
          >
            <Package size={16} />
            Products
          </Tab>
        </Tabs>

        <ContentArea>
          {activeTab === "appointments" && (
            <ItemGrid>
              {filteredAppointments.map((apt) => {
                const inCart = isItemInCart(apt.id, "appointment");
                return (
                  <ItemCard
                    key={apt.id}
                    type="button"
                    $inCart={inCart}
                    $disabled={inCart}
                    disabled={inCart}
                    onClick={() =>
                      !inCart &&
                      handleAddToCart({
                        id: apt.id,
                        type: "appointment",
                        name: apt.treatmentName,
                        price: apt.price,
                        originalPrice: apt.price,
                        appointmentId: apt.id,
                        clientName: apt.clientName,
                        staffId: apt.staffId,
                        staffName: apt.staffName,
                        duration: apt.duration,
                        isAppointmentCheckin: true,
                        locked: true,
                      })
                    }
                  >
                    <ItemName>{apt.treatmentName}</ItemName>
                    <ItemMeta>
                      <span>{apt.clientName}</span>
                      <span>{apt.time}</span>
                    </ItemMeta>
                    <ItemFooter>
                      <ItemPrice>${apt.price}</ItemPrice>
                      {inCart ? (
                        <ItemStatus $type="inCart">
                          <CheckCircle size={14} />
                          In Cart
                        </ItemStatus>
                      ) : (
                        <Plus size={20} />
                      )}
                    </ItemFooter>
                  </ItemCard>
                );
              })}
            </ItemGrid>
          )}

          {activeTab === "treatments" && (
            <ItemGrid>
              {filteredTreatments.map((treatment) => (
                <ItemCard
                  key={treatment.id}
                  type="button"
                  onClick={() =>
                    handleAddToCart({
                      id: treatment.id,
                      type: "treatment",
                      name: treatment.name,
                      price: treatment.price,
                      originalPrice: treatment.price,
                      duration: treatment.duration,
                    })
                  }
                >
                  <ItemName>{treatment.name}</ItemName>
                  <ItemMeta>
                    <span>{treatment.duration} min</span>
                    <span>{treatment.category}</span>
                  </ItemMeta>
                  <ItemFooter>
                    <ItemPrice>${treatment.price}</ItemPrice>
                    <Plus size={20} />
                  </ItemFooter>
                </ItemCard>
              ))}
            </ItemGrid>
          )}

          {activeTab === "products" && (
            <ItemGrid>
              {filteredProducts.map((product) => {
                const stockStatus = getProductStockStatus(product.id);
                const inCart = isItemInCart(product.id, "product");
                const canAdd = stockStatus.available > 0;

                return (
                  <ItemCard
                    key={product.id}
                    type="button"
                    $disabled={!canAdd}
                    disabled={!canAdd}
                    onClick={() =>
                      canAdd &&
                      handleAddToCart({
                        id: product.id,
                        type: "product",
                        name: product.name,
                        price: product.price,
                        originalPrice: product.price,
                        productId: product.id,
                        maxQuantity: stockStatus.available,
                      })
                    }
                  >
                    <ItemName>{product.name}</ItemName>
                    <ItemMeta>
                      <span>{product.category}</span>
                      {stockStatus.status === "outOfStock" ? (
                        <ItemStatus $type="outOfStock">
                          <AlertCircle size={12} />
                          Out of Stock
                        </ItemStatus>
                      ) : stockStatus.status === "lowStock" ? (
                        <ItemStatus $type="lowStock">
                          <AlertCircle size={12} />
                          {stockStatus.available} left
                        </ItemStatus>
                      ) : (
                        <Badge $variant="success">
                          {product.stock} in stock
                        </Badge>
                      )}
                    </ItemMeta>
                    <ItemFooter>
                      <ItemPrice>${product.price}</ItemPrice>
                      {canAdd && <Plus size={20} />}
                    </ItemFooter>
                  </ItemCard>
                );
              })}
            </ItemGrid>
          )}
        </ContentArea>
      </LeftPanel>

      <RightPanel>
        <CartTitle>
          <ShoppingCart size={20} />
          Cart
          {cart.length > 0 && <Badge>{cart.length}</Badge>}
        </CartTitle>

        <CartItems>
          {cart.length === 0 ? (
            <EmptyCart>
              <ShoppingCart
                size={40}
                style={{ margin: "0 auto 0.75rem", opacity: 0.3 }}
              />
              <p style={{ margin: 0, fontSize: "0.875rem" }}>Cart is empty</p>
              <p style={{ margin: "0.5rem 0 0 0", fontSize: "0.75rem" }}>
                Add items to get started
              </p>
            </EmptyCart>
          ) : (
            <CartItemList>
              {cart.map((item, idx) => (
                <CartItemCard key={`${item.id}-${item.type}-${idx}`}>
                  <CartItemHeader>
                    <div style={{ flex: 1 }}>
                      <CartItemName>{item.name}</CartItemName>
                      {item.clientName && (
                        <CartItemMeta>Client: {item.clientName}</CartItemMeta>
                      )}
                      {item.staffName && (
                        <CartItemMeta>Staff: {item.staffName}</CartItemMeta>
                      )}
                    </div>
                    <button
                      onClick={() => onRemoveFromCart(item.id, item.type)}
                      style={{
                        background: "none",
                        border: "none",
                        cursor: "pointer",
                        padding: "0.25rem",
                        display: "flex",
                        color: "#ef4444",
                      }}
                    >
                      <Trash2 size={18} />
                    </button>
                  </CartItemHeader>

                  {item.notes && (
                    <div
                      style={{
                        padding: "0.5rem",
                        background: "#fef3c7",
                        border: "1px solid #fbbf24",
                        borderRadius: "4px",
                        fontSize: "0.75rem",
                        marginBottom: "0.5rem",
                      }}
                    >
                       {item.notes}
                    </div>
                  )}

                  <CartItemFooter>
                    {item.type === "product" ? (
                      <QuantityControls>
                        <QuantityButton
                          onClick={() =>
                            onUpdateQuantity(item.id, item.type, -1)
                          }
                        >
                          <Minus size={14} />
                        </QuantityButton>
                        <span
                          style={{
                            fontWeight: 600,
                            minWidth: "2rem",
                            textAlign: "center",
                          }}
                        >
                          {item.quantity}
                          {item.maxQuantity && `/${item.maxQuantity}`}
                        </span>
                        <QuantityButton
                          onClick={() =>
                            onUpdateQuantity(item.id, item.type, 1)
                          }
                          disabled={
                            item.maxQuantity
                              ? item.quantity >= item.maxQuantity
                              : false
                          }
                        >
                          <Plus size={14} />
                        </QuantityButton>
                      </QuantityControls>
                    ) : (
                      <span style={{ fontSize: "0.8125rem", color: "#6b7280" }}>
                        Qty: {item.quantity}
                      </span>
                    )}
                    <CartItemPrice>
                      ${(item.price * item.quantity).toFixed(2)}
                    </CartItemPrice>
                  </CartItemFooter>

                  {editingNotes === `${item.id}-${item.type}` ? (
                    <NotesInput
                      placeholder="Add notes or special instructions..."
                      defaultValue={item.notes || ""}
                      onBlur={(e) => {
                        onUpdateNotes(item.id, item.type, e.target.value);
                        setEditingNotes(null);
                      }}
                      autoFocus
                    />
                  ) : (
                    <NotesButton
                      onClick={() => setEditingNotes(`${item.id}-${item.type}`)}
                    >
                      <MessageSquare size={12} />
                      {item.notes ? "Edit Notes" : "Add Notes"}
                    </NotesButton>
                  )}
                </CartItemCard>
              ))}
            </CartItemList>
          )}
        </CartItems>

        <Actions>
          <Button
            variation="secondary"
            icon={<ArrowLeft size={18} />}
            onClick={onBack}
            style={{ flex: 1, justifyContent: "center" }}
          >
            Back
          </Button>
          <Button
            variation="primary"
            icon={<ArrowRight size={18} />}
            onClick={onNext}
            disabled={cart.length === 0}
            style={{ flex: 1, justifyContent: "center" }}
          >
            Next
          </Button>
        </Actions>
      </RightPanel>
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\Payment.tsx
================================================================================

import React, { useState, useMemo } from "react";
import styled from "styled-components";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import toast from "react-hot-toast";
import {
  CreditCard,
  DollarSign,
  Check,
  AlertCircle,
  Percent,
  ArrowLeft,
  Gift,
  Edit2,
  Heart,
} from "lucide-react";
import type { CartItem, Discount, Tips, PaymentBreakdown } from "./api";
import {
  validateDiscount,
  calculateLoyaltyPoints,
  calculateLoyaltyValue,
} from "./api";

type PaymentMethod = "cash" | "card" | "split";

interface PaymentProps {
  cart: CartItem[];
  clientName?: string;
  clientLoyaltyPoints?: number;
  discount: Discount;
  tips: Tips;
  loyaltyPointsToRedeem: number;
  onUpdateDiscount: (discount: Discount) => void;
  onUpdateTips: (tips: Tips) => void;
  onUpdateLoyaltyRedemption: (points: number) => void;
  onComplete: (payments: PaymentBreakdown[]) => void;
  onBack: () => void;
  onEditCart: () => void;
  processing?: boolean;
}

const Container = styled.div`
  display: grid;
  grid-template-columns: 1fr 480px;
  gap: 2.5rem;
  max-width: 1400px;
  margin: 0 auto;

  @media (max-width: 1200px) {
    grid-template-columns: 1fr;
    gap: 2rem;
  }
`;

const LeftPanel = styled.div`
  display: grid;
  gap: 2rem;
`;

const Title = styled.h2`
  font-size: 2rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.5rem 0;

  @media (max-width: 768px) {
    font-size: 1.5rem;
  }
`;

const Subtitle = styled.p`
  font-size: 1rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0;

  @media (max-width: 768px) {
    font-size: 0.875rem;
  }
`;

const Section = styled.div`
  display: grid;
  gap: 1rem;
`;

const SectionTitle = styled.h3`
  font-size: 1.25rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
  margin: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;

  @media (max-width: 768px) {
    font-size: 1.125rem;
  }
`;

const OrderSummary = styled.div`
  display: grid;
  gap: 1rem;
  padding: 1.5rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
`;

const OrderItem = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
`;

const ItemRow = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: start;
  gap: 1rem;
`;

const ItemName = styled.div`
  font-weight: 700;
  font-size: 1rem;
  color: ${({ theme }) => theme.color.text};

  @media (max-width: 768px) {
    font-size: 0.9375rem;
  }
`;

const ItemMeta = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin-top: 0.375rem;

  @media (max-width: 768px) {
    font-size: 0.8125rem;
  }
`;

const ItemPrice = styled.div`
  font-weight: 800;
  font-size: 1.125rem;
  color: ${({ theme }) => theme.color.brand500};
  white-space: nowrap;

  @media (max-width: 768px) {
    font-size: 1rem;
  }
`;

const Card = styled.div`
  padding: 1.5rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
`;

const FormGrid = styled.div`
  display: grid;
  gap: 1rem;
`;

const FormRow = styled.div`
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 0.75rem;
  align-items: start;

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
`;

const Label = styled.label`
  font-size: 0.9375rem;
  font-weight: 600;
  color: ${({ theme }) => theme.color.text};
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-width: 140px;

  @media (max-width: 768px) {
    min-width: auto;
    font-size: 0.875rem;
  }
`;

const DiscountSelect = styled.select`
  padding: 0.75rem 1rem;
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
  color: ${({ theme }) => theme.color.text};
  font-size: 0.9375rem;
  cursor: pointer;
  outline: none;
  font-weight: 600;

  @media (max-width: 768px) {
    font-size: 0.875rem;
    padding: 0.625rem 0.875rem;
  }
`;

const RightPanel = styled.div`
  background: ${({ theme }) => theme.color.panel};
  border: 2px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  padding: 2rem;
  display: flex;
  flex-direction: column;
  gap: 2rem;
  position: sticky;
  top: 1rem;
  height: fit-content;

  @media (max-width: 1200px) {
    position: static;
  }

  @media (max-width: 768px) {
    padding: 1.5rem;
    gap: 1.5rem;
  }
`;

const TotalSection = styled.div`
  background: ${({ theme }) => theme.color.brand50};
  border: 2px solid ${({ theme }) => theme.color.brand500};
  border-radius: ${({ theme }) => theme.radii.lg};
  padding: 2rem;
  text-align: center;

  @media (max-width: 768px) {
    padding: 1.5rem;
  }
`;

const TotalLabel = styled.div`
  font-size: 0.9375rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin-bottom: 0.75rem;
  text-transform: uppercase;
  font-weight: 700;
  letter-spacing: 0.05em;

  @media (max-width: 768px) {
    font-size: 0.875rem;
  }
`;

const TotalAmount = styled.div`
  font-size: 3.5rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.brand600};
  line-height: 1;

  @media (max-width: 768px) {
    font-size: 2.5rem;
  }
`;

const Breakdown = styled.div`
  display: grid;
  gap: 0.875rem;
`;

const BreakdownRow = styled.div<{ $emphasis?: boolean }>`
  display: flex;
  justify-content: space-between;
  font-size: ${({ $emphasis }) => ($emphasis ? "1.25rem" : "1rem")};
  font-weight: ${({ $emphasis }) => ($emphasis ? 700 : 600)};
  color: ${({ theme }) => theme.color.text};
  padding-top: ${({ $emphasis }) => ($emphasis ? "1rem" : 0)};
  border-top: ${({ $emphasis, theme }) =>
    $emphasis ? `2px solid ${theme.color.border}` : "none"};

  @media (max-width: 768px) {
    font-size: ${({ $emphasis }) => ($emphasis ? "1.125rem" : "0.9375rem")};
  }
`;

const BreakdownLabel = styled.span<{ $positive?: boolean }>`
  color: ${({ $positive, theme }) =>
    $positive ? theme.color.green500 : theme.color.mutedText};
`;

const PaymentMethodGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
  margin-top: 1rem;
`;

const PaymentMethodButton = styled.button<{ $active: boolean }>`
  padding: 1.25rem 1rem;
  background: ${({ $active, theme }) =>
    $active ? theme.color.brand500 : theme.color.grey100};
  color: ${({ $active, theme }) => ($active ? "#ffffff" : theme.color.text)};
  border: 2px solid
    ${({ $active, theme }) =>
      $active ? theme.color.brand600 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
  font-size: 0.9375rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: capitalize;

  &:hover {
    border-color: ${({ theme }) => theme.color.brand500};
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    padding: 1rem 0.75rem;
    font-size: 0.875rem;
  }
`;

const QuickAmountGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.5rem;
  margin-top: 0.75rem;
`;

const QuickAmountButton = styled.button`
  padding: 0.875rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
  font-size: 0.9375rem;
  font-weight: 700;
  cursor: pointer;
  color: ${({ theme }) => theme.color.text};
  transition: all 0.2s;

  &:hover {
    background: ${({ theme }) => theme.color.grey200};
    border-color: ${({ theme }) => theme.color.brand500};
  }

  @media (max-width: 768px) {
    padding: 0.75rem;
    font-size: 0.875rem;
  }
`;

const ChangeDisplay = styled.div`
  padding: 1.25rem;
  background: ${({ theme }) => theme.color.green500}20;
  border: 2px solid ${({ theme }) => theme.color.green500};
  border-radius: ${({ theme }) => theme.radii.md};
  margin-top: 1rem;
`;

const ChangeLabel = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  font-weight: 700;
  letter-spacing: 0.05em;
`;

const ChangeAmount = styled.div`
  font-size: 2.5rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.green500};

  @media (max-width: 768px) {
    font-size: 2rem;
  }
`;

const Actions = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.875rem;
`;

const ButtonRow = styled.div`
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.875rem;

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
`;

const LoyaltyBadge = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.brand50};
  border: 1px solid ${({ theme }) => theme.color.brand300};
  border-radius: ${({ theme }) => theme.radii.md};
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 0.9375rem;
`;

const StaffTipRow = styled.div`
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 0.75rem;
  align-items: center;
  padding: 0.75rem;
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
`;

const SUGGESTED_AMOUNTS = [50, 100, 150, 200];

export default function Payment({
  cart,
  clientName,
  clientLoyaltyPoints = 0,
  discount,
  tips,
  loyaltyPointsToRedeem,
  onUpdateDiscount,
  onUpdateTips,
  onUpdateLoyaltyRedemption,
  onComplete,
  onBack,
  onEditCart,
  processing = false,
}: PaymentProps) {
  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>("card");
  const [cashAmount, setCashAmount] = useState("");
  const [showDiscountReason, setShowDiscountReason] = useState(false);

  // Get unique staff from cart
  const staffMembers = useMemo(() => {
    const staffMap = new Map<string, string>();
    cart.forEach((item) => {
      if (item.staffId && item.staffName) {
        staffMap.set(item.staffId, item.staffName);
      }
    });
    return Array.from(staffMap.entries()).map(([id, name]) => ({ id, name }));
  }, [cart]);

  // Calculate totals
  const {
    subtotal,
    discountAmount,
    loyaltyRedemptionValue,
    tax,
    tipsTotal,
    total,
    loyaltyEarned,
  } = useMemo(() => {
    const subtotal = cart.reduce(
      (sum, item) => sum + item.price * item.quantity,
      0
    );

    const discountAmount =
      discount.type === "percentage"
        ? (subtotal * discount.value) / 100
        : discount.value;

    const loyaltyRedemptionValue = calculateLoyaltyValue(loyaltyPointsToRedeem);

    const afterDiscounts = Math.max(
      0,
      subtotal - discountAmount - loyaltyRedemptionValue
    );
    const tax = afterDiscounts * 0.15;

    const tipsTotal = tips
      ? Object.values(tips).reduce((sum, tip) => sum + tip, 0)
      : 0;

    const total = afterDiscounts + tax + tipsTotal;
    const loyaltyEarned = calculateLoyaltyPoints(total);

    return {
      subtotal,
      discountAmount,
      loyaltyRedemptionValue,
      tax,
      tipsTotal,
      total,
      loyaltyEarned,
    };
  }, [cart, discount, loyaltyPointsToRedeem, tips]);

  const change = useMemo(() => {
    const cash = parseFloat(cashAmount) || 0;
    return Math.max(0, cash - total);
  }, [cashAmount, total]);

  const canComplete = useMemo(() => {
    if (paymentMethod === "cash") {
      const cash = parseFloat(cashAmount) || 0;
      return cash >= total;
    }
    return true;
  }, [paymentMethod, cashAmount, total]);

  const handleDiscountChange = (
    type: "percentage" | "fixed",
    value: number
  ) => {
    const newDiscount = { ...discount, type, value };
    const validation = validateDiscount(newDiscount, subtotal);

    if (!validation.valid) {
      toast.error(validation.error || "Invalid discount");
      return;
    }

    // Show reason input if discount is large
    const discAmt = type === "percentage" ? (subtotal * value) / 100 : value;
    if (discAmt > subtotal * 0.5) {
      setShowDiscountReason(true);
    }

    onUpdateDiscount(newDiscount);
  };

  const handleComplete = () => {
    if (!canComplete || processing) return;

    // Validate discount reason if required
    if (discountAmount > subtotal * 0.5 && !discount.reason) {
      toast.error("Please provide a reason for large discounts");
      return;
    }

    const payments: PaymentBreakdown[] = [
      {
        method: paymentMethod,
        amount: total,
        reference: paymentMethod === "card" ? "Card Payment" : undefined,
      },
    ];

    if (paymentMethod === "cash") {
      const cash = parseFloat(cashAmount);
      if (cash < total) {
        toast.error("Insufficient cash amount");
        return;
      }
    }

    onComplete(payments);
  };

  const maxLoyaltyRedemption = Math.min(
    clientLoyaltyPoints,
    Math.floor(subtotal * 100) // Can't redeem more than subtotal
  );

  return (
    <Container>
      <LeftPanel>
        <div>
          <Title>Review & Payment</Title>
          <Subtitle>
            Review your order and complete payment
            {clientName && ` for ${clientName}`}
          </Subtitle>
        </div>

        {/* Order Summary */}
        <Section>
          <SectionTitle>
            Order Summary
            <Button
              variation="secondary"
              size="small"
              icon={<Edit2 size={16} />}
              onClick={onEditCart}
            >
              Edit Cart
            </Button>
          </SectionTitle>
          <OrderSummary>
            {cart.map((item, idx) => (
              <OrderItem key={`${item.id}-${item.type}-${idx}`}>
                <ItemRow>
                  <div style={{ flex: 1 }}>
                    <ItemName>{item.name}</ItemName>
                    <ItemMeta>
                      {item.clientName && `${item.clientName}  `}
                      {item.staffName && `${item.staffName}  `}
                      Qty: {item.quantity}
                    </ItemMeta>
                    {item.notes && (
                      <ItemMeta
                        style={{ marginTop: "0.5rem", fontStyle: "italic" }}
                      >
                         {item.notes}
                      </ItemMeta>
                    )}
                  </div>
                  <ItemPrice>
                    ${(item.price * item.quantity).toFixed(2)}
                  </ItemPrice>
                </ItemRow>
              </OrderItem>
            ))}
          </OrderSummary>
        </Section>

        {/* Discount */}
        <Section>
          <SectionTitle>
            <Percent size={20} />
            Apply Discount
          </SectionTitle>
          <Card>
            <FormGrid>
              <FormRow>
                <DiscountSelect
                  value={discount.type}
                  onChange={(e) =>
                    handleDiscountChange(
                      e.target.value as "percentage" | "fixed",
                      discount.value
                    )
                  }
                >
                  <option value="percentage">Percentage (%)</option>
                  <option value="fixed">Fixed Amount ($)</option>
                </DiscountSelect>
                <Input
                  type="number"
                  min="0"
                  max={discount.type === "percentage" ? 100 : subtotal}
                  value={discount.value}
                  onChange={(e) =>
                    handleDiscountChange(discount.type, Number(e.target.value))
                  }
                  placeholder="0"
                />
              </FormRow>
              {showDiscountReason && (
                <Input
                  placeholder="Reason for discount (required for large discounts)"
                  value={discount.reason || ""}
                  onChange={(e) =>
                    onUpdateDiscount({ ...discount, reason: e.target.value })
                  }
                />
              )}
            </FormGrid>
          </Card>
        </Section>

        {/* Loyalty Points */}
        {clientLoyaltyPoints > 0 && (
          <Section>
            <SectionTitle>
              <Gift size={20} />
              Redeem Loyalty Points
            </SectionTitle>
            <Card>
              <LoyaltyBadge>
                <Heart size={20} style={{ color: "#C2A56F" }} />
                <span>
                  <strong>{clientLoyaltyPoints}</strong> points available ($
                  {calculateLoyaltyValue(clientLoyaltyPoints).toFixed(2)} value)
                </span>
              </LoyaltyBadge>
              <FormRow style={{ marginTop: "1rem" }}>
                <Label>Points to use:</Label>
                <Input
                  type="number"
                  min="0"
                  max={maxLoyaltyRedemption}
                  value={loyaltyPointsToRedeem}
                  onChange={(e) => {
                    const points = Math.min(
                      Number(e.target.value),
                      maxLoyaltyRedemption
                    );
                    onUpdateLoyaltyRedemption(points);
                  }}
                  placeholder="0"
                />
              </FormRow>
              {loyaltyPointsToRedeem > 0 && (
                <div
                  style={{
                    marginTop: "0.75rem",
                    fontSize: "0.875rem",
                    color: "#34d399",
                    fontWeight: 600,
                  }}
                >
                  Saving ${loyaltyRedemptionValue.toFixed(2)}
                </div>
              )}
            </Card>
          </Section>
        )}

        {/* Tips */}
        {staffMembers.length > 0 && (
          <Section>
            <SectionTitle>
              <DollarSign size={20} />
              Add Tips
            </SectionTitle>
            <Card>
              <FormGrid>
                {staffMembers.map((staff) => (
                  <StaffTipRow key={staff.id}>
                    <Label>{staff.name}:</Label>
                    <Input
                      type="number"
                      min="0"
                      step="0.50"
                      value={tips[staff.id] || 0}
                      onChange={(e) =>
                        onUpdateTips({
                          ...tips,
                          [staff.id]: Number(e.target.value),
                        })
                      }
                      placeholder="0.00"
                      style={{ maxWidth: "120px" }}
                    />
                  </StaffTipRow>
                ))}
              </FormGrid>
            </Card>
          </Section>
        )}
      </LeftPanel>

      <RightPanel>
        <TotalSection>
          <TotalLabel>Total Amount</TotalLabel>
          <TotalAmount>${total.toFixed(2)}</TotalAmount>
          {loyaltyEarned > 0 && (
            <div
              style={{
                marginTop: "1rem",
                fontSize: "0.9375rem",
                color: "#C2A56F",
                fontWeight: 600,
              }}
            >
              +{loyaltyEarned} loyalty points earned
            </div>
          )}
        </TotalSection>

        <Breakdown>
          <BreakdownRow>
            <span>Subtotal:</span>
            <span>${subtotal.toFixed(2)}</span>
          </BreakdownRow>
          {discountAmount > 0 && (
            <BreakdownRow>
              <BreakdownLabel $positive>Discount:</BreakdownLabel>
              <BreakdownLabel $positive>
                -${discountAmount.toFixed(2)}
              </BreakdownLabel>
            </BreakdownRow>
          )}
          {loyaltyRedemptionValue > 0 && (
            <BreakdownRow>
              <BreakdownLabel $positive>Loyalty:</BreakdownLabel>
              <BreakdownLabel $positive>
                -${loyaltyRedemptionValue.toFixed(2)}
              </BreakdownLabel>
            </BreakdownRow>
          )}
          <BreakdownRow>
            <BreakdownLabel>Tax (15%):</BreakdownLabel>
            <span>${tax.toFixed(2)}</span>
          </BreakdownRow>
          {tipsTotal > 0 && (
            <BreakdownRow>
              <span>Tips:</span>
              <span>${tipsTotal.toFixed(2)}</span>
            </BreakdownRow>
          )}
          <BreakdownRow $emphasis>
            <span>Total:</span>
            <span>${total.toFixed(2)}</span>
          </BreakdownRow>
        </Breakdown>

        <div>
          <SectionTitle style={{ fontSize: "1.125rem", marginBottom: "1rem" }}>
            Payment Method
          </SectionTitle>
          <PaymentMethodGrid>
            {(["card", "cash", "split"] as PaymentMethod[]).map((method) => (
              <PaymentMethodButton
                key={method}
                type="button"
                $active={paymentMethod === method}
                onClick={() => setPaymentMethod(method)}
              >
                {method}
              </PaymentMethodButton>
            ))}
          </PaymentMethodGrid>

          {paymentMethod === "cash" && (
            <>
              <Input
                type="number"
                step="0.01"
                value={cashAmount}
                onChange={(e) => setCashAmount(e.target.value)}
                placeholder="Enter cash received"
                style={{ fontSize: "1.125rem", marginTop: "1rem" }}
                autoFocus
              />
              <QuickAmountGrid>
                {SUGGESTED_AMOUNTS.map((amount) => (
                  <QuickAmountButton
                    key={amount}
                    type="button"
                    onClick={() => setCashAmount(amount.toString())}
                  >
                    ${amount}
                  </QuickAmountButton>
                ))}
              </QuickAmountGrid>
              {cashAmount && parseFloat(cashAmount) >= total && (
                <ChangeDisplay>
                  <ChangeLabel>Change Due</ChangeLabel>
                  <ChangeAmount>${change.toFixed(2)}</ChangeAmount>
                </ChangeDisplay>
              )}
            </>
          )}
        </div>

        <Actions>
          <Button
            variation="primary"
            icon={<Check size={20} />}
            onClick={handleComplete}
            disabled={!canComplete || processing}
            style={{
              width: "100%",
              padding: "1.25rem",
              fontSize: "1.125rem",
              justifyContent: "center",
            }}
          >
            {processing ? "Processing..." : "Complete Payment"}
          </Button>
          <ButtonRow>
            <Button
              variation="secondary"
              icon={<ArrowLeft size={18} />}
              onClick={onBack}
              disabled={processing}
              style={{ justifyContent: "center" }}
            >
              Back
            </Button>
            <Button
              variation="secondary"
              icon={<Edit2 size={18} />}
              onClick={onEditCart}
              disabled={processing}
              style={{ justifyContent: "center" }}
            >
              Edit Cart
            </Button>
          </ButtonRow>
        </Actions>
      </RightPanel>
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\POS.tsx
================================================================================

import { useMutation, useQueryClient } from "@tanstack/react-query";
import toast from "react-hot-toast";
import { useState, useCallback, useMemo, useEffect } from "react";
import POSStepWrapper from "./POSStepWrapper";
import ClientSelection from "./ClientSelection";
import ItemSelection from "./ItemSelection";
import StaffAssignment from "./StaffAssignment";
import Payment from "./Payment";
import CreateClientModal from "./CreateClientModal";
import ReceiptAndNextAppointment from "./ReceiptAndNextAppointment";
import {
  createTransaction,
  createClient,
  createAppointment as createAppointmentAPI,
  completeAppointment,
  updateStockAfterSale,
  saveDraft,
  loadDraft,
  clearDraft,
  type CartItem,
  type CreateTransactionInput,
  type CreateClientInput,
  type CreateAppointmentInput,
  type Discount,
  type Tips,
  type PaymentBreakdown,
  type CartValidation,
  type Transaction,
} from "./api";
import {
  mockClients,
  mockAppointments,
  mockProducts,
  mockTreatments,
  mockStaff,
} from "./mockData";

interface PointOfSaleProps {
  isAdmin?: boolean;
}

export default function PointOfSale({ isAdmin = false }: PointOfSaleProps) {
  const queryClient = useQueryClient();

  // Step management
  const [currentStep, setCurrentStep] = useState(1);
  const [completedSteps, setCompletedSteps] = useState<number[]>([]);

  // Data state
  const [clientType, setClientType] = useState<"booked" | "walk-in">("booked");
  const [selectedClient, setSelectedClient] = useState<string>("");
  const [selectedClientData, setSelectedClientData] = useState<any>(null);
  const [selectedAppointmentId, setSelectedAppointmentId] =
    useState<string>("");
  const [cart, setCart] = useState<CartItem[]>([]);
  const [discount, setDiscount] = useState<Discount>({
    type: "percentage",
    value: 0,
  });
  const [tips, setTips] = useState<Tips>({});
  const [loyaltyPointsToRedeem, setLoyaltyPointsToRedeem] = useState(0);

  // Product stock tracking
  const [productStock, setProductStock] = useState<Record<string, number>>({});

  // Modal state
  const [showCreateClient, setShowCreateClient] = useState(false);
  const [completedTransaction, setCompletedTransaction] =
    useState<Transaction | null>(null);

  // Using mock data
  const clients = mockClients;
  const appointments = mockAppointments || [];
  const products = mockProducts;
  const treatments = mockTreatments;
  const staff = mockStaff;

  // Initialize product stock
  useEffect(() => {
    const stockMap: Record<string, number> = {};
    products.forEach((product) => {
      stockMap[product.id] = product.stock || 0;
    });
    setProductStock(stockMap);
  }, [products]);

  // Auto-save draft
  useEffect(() => {
    if (cart.length === 0 || currentStep === 1 || completedTransaction) return;

    const timer = setTimeout(() => {
      const draft = {
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        clientId: selectedClient,
        clientData: selectedClientData,
        cart,
        discount,
        tips,
        currentStep,
        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
      };
      saveDraft(draft);
    }, 30000);

    return () => clearTimeout(timer);
  }, [
    cart,
    selectedClient,
    selectedClientData,
    discount,
    tips,
    currentStep,
    completedTransaction,
  ]);

  // Mutations
  const createClientMutation = useMutation({
    mutationFn: createClient,
    onSuccess: (newClient) => {
      setSelectedClient(newClient.id);
      setSelectedClientData(newClient);
      queryClient.invalidateQueries({ queryKey: ["clients"] });
      toast.success("Client created successfully!");
      markStepCompleted(1);
      goToStep(2);
    },
    onError: (error) => {
      toast.error(
        error instanceof Error ? error.message : "Failed to create client"
      );
    },
  });

  const createTransactionMutation = useMutation({
    mutationFn: createTransaction,
    onSuccess: async (data) => {
      // Mark appointments as completed
      const appointmentItems = cart.filter(
        (item) => item.type === "appointment"
      );
      for (const item of appointmentItems) {
        if (item.appointmentId) {
          await completeAppointment(item.appointmentId);
        }
      }

      // Update stock
      await updateStockAfterSale(cart);

      queryClient.invalidateQueries({ queryKey: ["appointments"] });
      queryClient.invalidateQueries({ queryKey: ["products"] });
      queryClient.invalidateQueries({ queryKey: ["transactions"] });

      clearDraft();
      setCompletedTransaction(data);
      markStepCompleted(needsStaffAssignment ? 4 : 3);

      toast.success("Transaction completed successfully!", {
        duration: 4000,
        icon: "",
      });
    },
    onError: (error) => {
      toast.error(
        error instanceof Error
          ? error.message
          : "Failed to complete transaction",
        { duration: 5000 }
      );
    },
  });

  const createAppointmentMutation = useMutation({
    mutationFn: createAppointmentAPI,
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ["appointments"] });
      toast.success(`Appointment booked for ${data.clientName || "client"}!`, {
        duration: 4000,
        position: "top-right",
      });
      resetPOS();
    },
    onError: (error) => {
      toast.error(
        error instanceof Error ? error.message : "Failed to book appointment",
        { duration: 5000 }
      );
    },
  });

  // Calculate if treatments need staff
  const needsStaffAssignment = useMemo(
    () =>
      cart.some(
        (item) => item.type === "treatment" || item.type === "appointment"
      ),
    [cart]
  );

  // Define steps
  const steps = useMemo(() => {
    if (completedTransaction) {
      return [
        { number: 1, label: "Select Client", completed: true },
        { number: 2, label: "Add Items", completed: true },
        ...(needsStaffAssignment
          ? [{ number: 3, label: "Assign Staff", completed: true }]
          : []),
        {
          number: needsStaffAssignment ? 4 : 3,
          label: "Payment",
          completed: true,
        },
        {
          number: needsStaffAssignment ? 5 : 4,
          label: "Complete",
          completed: true,
        },
      ];
    }

    const baseSteps = [
      {
        number: 1,
        label: "Select Client",
        completed: completedSteps.includes(1),
      },
      { number: 2, label: "Add Items", completed: completedSteps.includes(2) },
    ];

    if (needsStaffAssignment) {
      baseSteps.push({
        number: 3,
        label: "Assign Staff",
        completed: completedSteps.includes(3),
      });
      baseSteps.push({
        number: 4,
        label: "Payment",
        completed: completedSteps.includes(4),
      });
    } else {
      baseSteps.push({
        number: 3,
        label: "Payment",
        completed: completedSteps.includes(3),
      });
    }

    return baseSteps;
  }, [completedSteps, needsStaffAssignment, completedTransaction]);

  // Navigation
  const goToStep = useCallback((step: number) => {
    setCurrentStep(step);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }, []);

  const markStepCompleted = useCallback((step: number) => {
    setCompletedSteps((prev) => [...new Set([...prev, step])]);
  }, []);

  // Reset POS
  const resetPOS = useCallback(() => {
    setCurrentStep(1);
    setCompletedSteps([]);
    setClientType("booked");
    setSelectedClient("");
    setSelectedClientData(null);
    setSelectedAppointmentId("");
    setCart([]);
    setDiscount({ type: "percentage", value: 0 });
    setTips({});
    setLoyaltyPointsToRedeem(0);
    setCompletedTransaction(null);
    clearDraft();
  }, []);

  // Step 1: Client Selection
  const handleSelectClient = useCallback(
    (
      clientId: string,
      type: "booked" | "walk-in",
      appointmentId?: string,
      verified?: boolean
    ) => {
      setClientType(type);
      if (clientId) {
        setSelectedClient(clientId);
        const client = clients.find((c) => c.id === clientId);
        setSelectedClientData(client || null);
      }
      if (appointmentId) {
        setSelectedAppointmentId(appointmentId);

        const apt = appointments.find((a) => a.id === appointmentId);
        if (apt) {
          setCart([
            {
              id: apt.id,
              type: "appointment",
              name: apt.treatmentName,
              price: apt.price,
              originalPrice: apt.price,
              quantity: 1,
              appointmentId: apt.id,
              clientName: apt.clientName,
              staffId: apt.staffId,
              staffName: apt.staffName,
              duration: apt.duration,
              isAppointmentCheckin: true,
              locked: true,
            },
          ]);
        }
      }
      markStepCompleted(1);
      goToStep(2);
    },
    [clients, appointments, markStepCompleted, goToStep]
  );

  const handleCreateClient = useCallback(
    (clientData: CreateClientInput) => {
      createClientMutation.mutate(clientData);
      setShowCreateClient(false);
    },
    [createClientMutation]
  );

  // Step 2: Item Selection
  const addToCart = useCallback(
    (item: Omit<CartItem, "quantity">, validation: CartValidation) => {
      if (!validation.canAdd) {
        toast.error(validation.reason || "Cannot add item to cart");
        return;
      }

      if (validation.warnings) {
        validation.warnings.forEach((warning) => {
          toast(warning, { icon: "", duration: 3000 });
        });
      }

      setCart((prev) => [...prev, { ...item, quantity: 1 }]);
      toast.success(`${item.name} added to cart`);
    },
    []
  );

  const updateQuantity = useCallback(
    (id: string, type: string, delta: number) => {
      setCart((prev) =>
        prev.map((item) => {
          if (item.id === id && item.type === type) {
            const newQuantity = Math.max(1, item.quantity + delta);
            if (item.maxQuantity && newQuantity > item.maxQuantity) {
              toast.error("Maximum quantity reached");
              return item;
            }
            return { ...item, quantity: newQuantity };
          }
          return item;
        })
      );
    },
    []
  );

  const removeFromCart = useCallback((id: string, type: string) => {
    setCart((prev) =>
      prev.filter((item) => !(item.id === id && item.type === type))
    );
    toast.success("Item removed from cart");
  }, []);

  const updateNotes = useCallback((id: string, type: string, notes: string) => {
    setCart((prev) =>
      prev.map((item) => {
        if (item.id === id && item.type === type) {
          return { ...item, notes };
        }
        return item;
      })
    );
  }, []);

  const handleItemSelectionNext = useCallback(() => {
    if (cart.length === 0) {
      toast.error("Please add at least one item to cart");
      return;
    }
    markStepCompleted(2);
    if (needsStaffAssignment) {
      goToStep(3);
    } else {
      goToStep(3);
    }
  }, [cart.length, markStepCompleted, goToStep, needsStaffAssignment]);

  // Step 3: Staff Assignment
  const assignStaff = useCallback(
    (itemId: string, itemType: string, staffId: string, staffName: string) => {
      setCart((prev) =>
        prev.map((item) => {
          if (item.id === itemId && item.type === itemType) {
            return { ...item, staffId, staffName };
          }
          return item;
        })
      );
      toast.success(`${staffName} assigned`);
    },
    []
  );

  const handleStaffAssignmentNext = useCallback(() => {
    const allAssigned = cart
      .filter(
        (item) => item.type === "treatment" || item.type === "appointment"
      )
      .every((item) => item.staffId);

    if (!allAssigned) {
      toast.error("Please assign staff to all treatments");
      return;
    }

    markStepCompleted(3);
    goToStep(4);
  }, [cart, markStepCompleted, goToStep]);

  // Step 4: Payment
  const handlePaymentComplete = useCallback(
    (payments: PaymentBreakdown[]) => {
      const transactionInput: CreateTransactionInput = {
        clientId: selectedClient || undefined,
        items: cart,
        discount,
        payments,
        tips,
        loyaltyPointsRedeemed: loyaltyPointsToRedeem,
      };

      createTransactionMutation.mutate(transactionInput);
    },
    [
      selectedClient,
      cart,
      discount,
      tips,
      loyaltyPointsToRedeem,
      createTransactionMutation,
    ]
  );

  // Step 5: Book Next Appointment
  const handleBookAppointment = useCallback(
    (appointmentData: CreateAppointmentInput) => {
      createAppointmentMutation.mutate(appointmentData);
    },
    [createAppointmentMutation]
  );

  // Render completed transaction
  if (completedTransaction) {
    return (
      <POSStepWrapper currentStep={steps.length} steps={steps}>
        <ReceiptAndNextAppointment
          transaction={completedTransaction}
          client={selectedClientData}
          treatments={treatments}
          staff={staff}
          onBookAppointment={handleBookAppointment}
          onNewSale={resetPOS}
          bookingAppointment={createAppointmentMutation.isPending}
        />
      </POSStepWrapper>
    );
  }

  return (
    <>
      <POSStepWrapper currentStep={currentStep} steps={steps}>
        {/* Step 1: Client Selection */}
        {currentStep === 1 && (
          <ClientSelection
            clients={clients}
            appointments={appointments}
            onSelectClient={handleSelectClient}
            onCreateNew={() => setShowCreateClient(true)}
          />
        )}

        {/* Step 2: Item Selection */}
        {currentStep === 2 && (
          <ItemSelection
            clientType={clientType}
            clientName={selectedClientData?.name}
            appointments={appointments}
            treatments={treatments}
            products={products}
            cart={cart}
            productStock={productStock}
            onAddToCart={addToCart}
            onUpdateQuantity={updateQuantity}
            onRemoveFromCart={removeFromCart}
            onUpdateNotes={updateNotes}
            onNext={handleItemSelectionNext}
            onBack={() => goToStep(1)}
          />
        )}

        {/* Step 3: Staff Assignment (conditional) */}
        {currentStep === 3 && needsStaffAssignment && (
          <StaffAssignment
            cart={cart}
            staff={staff}
            onAssignStaff={assignStaff}
            onNext={handleStaffAssignmentNext}
            onBack={() => goToStep(2)}
          />
        )}

        {/* Step 3 or 4: Payment */}
        {((currentStep === 3 && !needsStaffAssignment) ||
          (currentStep === 4 && needsStaffAssignment)) && (
          <Payment
            cart={cart}
            clientName={selectedClientData?.name}
            clientLoyaltyPoints={selectedClientData?.loyaltyPoints || 0}
            discount={discount}
            tips={tips}
            loyaltyPointsToRedeem={loyaltyPointsToRedeem}
            onUpdateDiscount={setDiscount}
            onUpdateTips={setTips}
            onUpdateLoyaltyRedemption={setLoyaltyPointsToRedeem}
            onComplete={handlePaymentComplete}
            onBack={() => goToStep(needsStaffAssignment ? 3 : 2)}
            onEditCart={() => goToStep(2)}
            processing={createTransactionMutation.isPending}
          />
        )}
      </POSStepWrapper>

      {/* Create Client Modal */}
      <CreateClientModal
        isOpen={showCreateClient}
        onClose={() => setShowCreateClient(false)}
        onSubmit={handleCreateClient}
        submitting={createClientMutation.isPending}
      />
    </>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\POSStepWrapper.tsx
================================================================================

import React from "react";
import styled from "styled-components";
import { Check } from "lucide-react";

interface Step {
  number: number;
  label: string;
  completed: boolean;
}

interface POSStepWrapperProps {
  currentStep: number;
  steps: Step[];
  children: React.ReactNode;
}

const Wrapper = styled.div`
  padding: 2rem;
  max-width: 1400px;
  margin: 0 auto;
`;

const StepsHeader = styled.div`
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: ${({ theme }) => theme.shadowMd};
`;

const StepsContainer = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  max-width: 800px;
  margin: 0 auto;
`;

const StepItem = styled.div<{ $active: boolean; $completed: boolean }>`
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
  position: relative;
  z-index: 2;
`;

const StepCircle = styled.div<{ $active: boolean; $completed: boolean }>`
  width: 3.5rem;
  height: 3.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 1.125rem;
  background: ${({ $active, $completed, theme }) =>
    $completed
      ? theme.color.green500
      : $active
      ? theme.color.brand500
      : theme.color.grey200};
  color: ${({ $active, $completed }) =>
    $completed || $active ? "#ffffff" : "#6b7280"};
  border: 3px solid
    ${({ $active, $completed, theme }) =>
      $completed
        ? theme.color.green500
        : $active
        ? theme.color.brand600
        : theme.color.grey300};
  transition: all 0.3s ease;
  box-shadow: ${({ theme }) => theme.shadowMd};
`;

const StepLabel = styled.div<{ $active: boolean }>`
  font-size: 0.875rem;
  font-weight: ${({ $active }) => ($active ? 700 : 500)};
  color: ${({ $active, theme }) =>
    $active ? theme.color.text : theme.color.mutedText};
  text-align: center;
  max-width: 100px;
`;

const StepConnector = styled.div<{ $completed: boolean }>`
  position: absolute;
  top: 1.75rem;
  left: 0;
  right: 0;
  height: 3px;
  background: ${({ $completed, theme }) =>
    $completed ? theme.color.green500 : theme.color.grey300};
  z-index: 1;
  transition: background 0.3s ease;
`;

const Content = styled.div`
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  padding: 2rem;
  box-shadow: ${({ theme }) => theme.shadowMd};
  min-height: 600px;
`;

export default function POSStepWrapper({
  currentStep,
  steps,
  children,
}: POSStepWrapperProps) {
  return (
    <Wrapper>
      <StepsHeader>
        <StepsContainer>
          <StepConnector
            $completed={currentStep > 1}
            style={{
              width: `${((currentStep - 1) / (steps.length - 1)) * 100}%`,
            }}
          />
          {steps.map((step) => (
            <StepItem
              key={step.number}
              $active={currentStep === step.number}
              $completed={step.completed}
            >
              <StepCircle
                $active={currentStep === step.number}
                $completed={step.completed}
              >
                {step.completed ? <Check size={24} /> : step.number}
              </StepCircle>
              <StepLabel $active={currentStep === step.number}>
                {step.label}
              </StepLabel>
            </StepItem>
          ))}
        </StepsContainer>
      </StepsHeader>

      <Content>{children}</Content>
    </Wrapper>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\ReceiptAndNextAppointment.tsx
================================================================================

import React, { useState, useMemo, useCallback } from "react";
import styled from "styled-components";
import {
  Calendar,
  Check,
  X,
  Mail,
  Printer,
  MessageSquare,
  Gift,
  CheckCircle,
} from "lucide-react";
import Button from "../../ui/components/Button";
import Modal from "../../ui/components/Modal";
import Input from "../../ui/components/Input";
import toast from "react-hot-toast";
import type { Client, Treatment, Staff } from "./api";

interface Transaction {
  id: string;
  total: number;
  subtotal: number;
  tax: number;
  discountAmount: number;
  tipsTotal: number;
  loyaltyPointsEarned: number;
  items: Array<{
    name: string;
    price: number;
    quantity: number;
  }>;
  paymentMethod: string;
}

interface ReceiptAndNextAppointmentProps {
  transaction: Transaction;
  client: Client;
  treatments: Treatment[];
  staff: Staff[];
  onBookAppointment: (appointmentData: {
    clientId: string;
    treatmentId: string;
    datetimeISO: string;
    staffId?: string;
    notes?: string;
  }) => void;
  onNewSale: () => void;
  bookingAppointment?: boolean;
}

// Styled Components
const Container = styled.div`
  display: grid;
  gap: 2rem;
  max-width: 900px;
  margin: 0 auto;
`;

const SuccessHeader = styled.div`
  text-align: center;
  padding: 2rem 1rem;
`;

const SuccessIcon = styled.div`
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: ${({ theme }) => theme.color.green500};
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
  animation: scaleIn 0.4s ease-out;

  @keyframes scaleIn {
    from {
      transform: scale(0);
    }
    to {
      transform: scale(1);
    }
  }
`;

const SuccessTitle = styled.h2`
  font-size: 2rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.5rem 0;
`;

const SuccessSubtitle = styled.p`
  font-size: 1.125rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0 0 1rem 0;
`;

const TransactionId = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
  font-family: "Courier New", monospace;
`;

const SectionGrid = styled.div`
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
`;

const Card = styled.div`
  padding: 1.5rem;
  background: ${({ theme }) => theme.color.panel};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  box-shadow: ${({ theme }) => theme.shadowSm};
`;

const CardTitle = styled.h3`
  font-size: 1rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 1rem 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const ReceiptList = styled.div`
  display: grid;
  gap: 0.75rem;
`;

const ReceiptRow = styled.div<{ $isTotal?: boolean }>`
  display: flex;
  justify-content: space-between;
  font-size: 0.9375rem;
  color: ${({ theme }) => theme.color.text};

  ${({ $isTotal, theme }) =>
    $isTotal &&
    `
    font-weight: 700;
    font-size: 1.125rem;
    padding-top: 0.75rem;
    border-top: 2px solid ${theme.color.border};
    color: ${theme.color.brand600};
  `}
`;

const LoyaltyCard = styled.div`
  padding: 1.25rem;
  background: linear-gradient(
    135deg,
    ${({ theme }) => theme.color.brand500}20,
    ${({ theme }) => theme.color.brand600}20
  );
  border: 2px solid ${({ theme }) => theme.color.brand500};
  border-radius: ${({ theme }) => theme.radii.lg};
  text-align: center;
`;

const LoyaltyAmount = styled.div`
  font-size: 2.5rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.brand600};
  margin-bottom: 0.5rem;
`;

const LoyaltyLabel = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
`;

const ReceiptActions = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
  margin-top: 1rem;
`;

const ReceiptButton = styled.button`
  padding: 0.75rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
  color: ${({ theme }) => theme.color.text};
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s;

  &:hover {
    background: ${({ theme }) => theme.color.brand50};
    border-color: ${({ theme }) => theme.color.brand500};
  }

  &:active {
    transform: scale(0.98);
  }

  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
`;

const AppointmentPrompt = styled.div`
  padding: 2rem;
  background: ${({ theme }) => theme.color.brand50};
  border: 2px solid ${({ theme }) => theme.color.brand500};
  border-radius: ${({ theme }) => theme.radii.lg};
  text-align: center;
`;

const PromptTitle = styled.h3`
  font-size: 1.5rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.75rem 0;
`;

const PromptSubtitle = styled.p`
  font-size: 1rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0 0 1.5rem 0;
`;

const PromptActions = styled.div`
  display: flex;
  gap: 1rem;
  justify-content: center;

  @media (max-width: 640px) {
    flex-direction: column;
  }
`;

const FormContainer = styled.div`
  display: grid;
  gap: 1.25rem;
`;

const FormField = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
`;

const Label = styled.label`
  font-weight: 600;
  font-size: 0.9375rem;
  color: ${({ theme }) => theme.color.text};
`;

const Select = styled.select`
  width: 100%;
  min-height: 46px;
  padding: 0.8rem 1.2rem;
  border-radius: ${({ theme }) => theme.radii.sm};
  border: 1px solid ${({ theme }) => theme.color.border};
  background-color: ${({ theme }) => theme.color.panel};
  color: ${({ theme }) => theme.color.text};
  box-shadow: ${({ theme }) => theme.shadowSm};
  font-size: 1rem;
  font-family: inherit;
  line-height: 1.5;
  outline: none;
  cursor: pointer;
  transition: box-shadow 0.12s ease, border-color 0.12s ease;
  box-sizing: border-box;

  &:focus {
    box-shadow: 0 0 0 4px ${({ theme }) => theme.color.brand100};
    border-color: ${({ theme }) => theme.color.brand600};
  }

  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: ${({ theme }) => theme.color.grey100};
  }
`;

const DateTimeGrid = styled.div`
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;

  @media (max-width: 640px) {
    grid-template-columns: 1fr;
  }
`;

const InfoBox = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.brand50};
  border: 1px solid ${({ theme }) => theme.color.brand200};
  border-radius: ${({ theme }) => theme.radii.md};
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 1.5rem;
`;

const ModalActions = styled.div`
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
`;

// Helper function to generate time slots
function generateTimeSlots(): string[] {
  const slots: string[] = [];
  for (let h = 9; h <= 17; h++) {
    for (let m = 0; m < 60; m += 15) {
      if (h === 17 && m > 0) break;
      const hour = h.toString().padStart(2, "0");
      const minute = m.toString().padStart(2, "0");
      slots.push(`${hour}:${minute}`);
    }
  }
  return slots;
}

export default function ReceiptAndNextAppointment({
  transaction,
  client,
  treatments,
  staff,
  onBookAppointment,
  onNewSale,
  bookingAppointment = false,
}: ReceiptAndNextAppointmentProps) {
  const [showAppointmentModal, setShowAppointmentModal] = useState(false);
  const [appointmentData, setAppointmentData] = useState({
    date: "",
    time: "",
    treatment: "",
    staff: "",
    notes: "",
  });

  const timeSlots = useMemo(() => generateTimeSlots(), []);

  // Filter treatments that were actually treatments (not products)
  const availableTreatments = useMemo(() => {
    return treatments.filter((t) =>
      transaction.items.some(
        (item) => item.name.toLowerCase() === t.name.toLowerCase()
      )
    );
  }, [treatments, transaction.items]);

  const handleSendReceipt = useCallback(
    async (method: "email" | "print" | "sms") => {
      try {
        // In real app, call API to send receipt
        // await sendReceipt(transaction.id, method, client.email or client.phone);

        toast.success(
          `Receipt ${method === "print" ? "printed" : `sent via ${method}`}!`,
          {
            duration: 3000,
            position: "top-right",
          }
        );
      } catch (error) {
        toast.error(`Failed to send receipt via ${method}`, {
          duration: 4000,
          position: "top-right",
        });
      }
    },
    [transaction.id, client]
  );

  const handleOpenAppointmentModal = useCallback(() => {
    // Pre-fill with first treatment if available
    if (availableTreatments.length > 0) {
      setAppointmentData((prev) => ({
        ...prev,
        treatment: availableTreatments[0].id,
      }));
    }
    setShowAppointmentModal(true);
  }, [availableTreatments]);

  const handleCloseAppointmentModal = useCallback(() => {
    setShowAppointmentModal(false);
    setAppointmentData({
      date: "",
      time: "",
      treatment: "",
      staff: "",
      notes: "",
    });
  }, []);

  const handleAppointmentSubmit = useCallback(() => {
    // Validate required fields
    if (
      !appointmentData.date ||
      !appointmentData.time ||
      !appointmentData.treatment
    ) {
      toast.error("Please fill in all required fields", {
        duration: 4000,
        position: "top-right",
      });
      return;
    }

    // Build ISO datetime string
    const datetimeISO = `${appointmentData.date}T${appointmentData.time}:00`;

    onBookAppointment({
      clientId: client.id,
      treatmentId: appointmentData.treatment,
      datetimeISO,
      staffId: appointmentData.staff || undefined,
      notes: appointmentData.notes || undefined,
    });

    handleCloseAppointmentModal();
  }, [
    appointmentData,
    client.id,
    onBookAppointment,
    handleCloseAppointmentModal,
  ]);

  const minDate = new Date().toISOString().split("T")[0];

  return (
    <Container>
      {/* Success Header */}
      <SuccessHeader>
        <SuccessIcon>
          <Check size={48} strokeWidth={3} />
        </SuccessIcon>
        <SuccessTitle>Payment Successful!</SuccessTitle>
        <SuccessSubtitle>Thank you for your payment</SuccessSubtitle>
        <TransactionId>Transaction ID: {transaction.id}</TransactionId>
      </SuccessHeader>

      {/* Receipt & Loyalty Cards */}
      <SectionGrid>
        <Card>
          <CardTitle>
            <CheckCircle size={18} />
            Receipt Summary
          </CardTitle>
          <ReceiptList>
            {transaction.items.map((item, idx) => (
              <ReceiptRow key={idx}>
                <span>
                  {item.name}  {item.quantity}
                </span>
                <span>${(item.price * item.quantity).toFixed(2)}</span>
              </ReceiptRow>
            ))}
            <ReceiptRow
              style={{
                marginTop: "0.5rem",
                paddingTop: "0.5rem",
                borderTop: "1px solid",
                borderColor: "inherit",
              }}
            >
              <span>Subtotal:</span>
              <span>${transaction.subtotal.toFixed(2)}</span>
            </ReceiptRow>
            {transaction.discountAmount > 0 && (
              <ReceiptRow>
                <span>Discount:</span>
                <span style={{ color: "#22c55e" }}>
                  -${transaction.discountAmount.toFixed(2)}
                </span>
              </ReceiptRow>
            )}
            <ReceiptRow>
              <span>Tax (15%):</span>
              <span>${transaction.tax.toFixed(2)}</span>
            </ReceiptRow>
            {transaction.tipsTotal > 0 && (
              <ReceiptRow>
                <span>Tips:</span>
                <span>${transaction.tipsTotal.toFixed(2)}</span>
              </ReceiptRow>
            )}
            <ReceiptRow $isTotal>
              <span>Total Paid:</span>
              <span>${transaction.total.toFixed(2)}</span>
            </ReceiptRow>
          </ReceiptList>

          <ReceiptActions>
            <ReceiptButton onClick={() => handleSendReceipt("email")}>
              <Mail size={20} />
              Email
            </ReceiptButton>
            <ReceiptButton onClick={() => handleSendReceipt("print")}>
              <Printer size={20} />
              Print
            </ReceiptButton>
            <ReceiptButton onClick={() => handleSendReceipt("sms")}>
              <MessageSquare size={20} />
              SMS
            </ReceiptButton>
          </ReceiptActions>
        </Card>

        <Card>
          <CardTitle>
            <Gift size={18} />
            Loyalty Points
          </CardTitle>
          <LoyaltyCard>
            <LoyaltyAmount>+{transaction.loyaltyPointsEarned}</LoyaltyAmount>
            <LoyaltyLabel>Points Earned</LoyaltyLabel>
          </LoyaltyCard>
          <div
            style={{
              marginTop: "1rem",
              textAlign: "center",
              fontSize: "0.875rem",
              color: "#6b7280",
            }}
          >
            New balance:{" "}
            <strong>
              {client.loyaltyPoints + transaction.loyaltyPointsEarned} points
            </strong>
          </div>
        </Card>
      </SectionGrid>

      {/* Book Next Appointment Prompt */}
      <AppointmentPrompt>
        <PromptTitle>Book Your Next Appointment?</PromptTitle>
        <PromptSubtitle>
          Schedule your next visit with {client.name} now
        </PromptSubtitle>
        <PromptActions>
          <Button
            variation="secondary"
            size="medium"
            onClick={onNewSale}
            style={{
              flex: 1,
              justifyContent: "center",
              minWidth: "160px",
            }}
          >
            <X size={20} />
            No Thanks
          </Button>
          <Button
            variation="primary"
            size="medium"
            onClick={handleOpenAppointmentModal}
            style={{
              flex: 1,
              justifyContent: "center",
              minWidth: "160px",
            }}
          >
            <Calendar size={20} />
            Book Appointment
          </Button>
        </PromptActions>
      </AppointmentPrompt>

      {/* Appointment Booking Modal */}
      <Modal
        isOpen={showAppointmentModal}
        onClose={handleCloseAppointmentModal}
        title="Book Next Appointment"
        size="md"
        ariaLabel="Book next appointment"
      >
        <InfoBox>
          <strong>Booking for:</strong> {client.name}
          <br />
          {client.email && (
            <>
              <strong>Email:</strong> {client.email}
              <br />
            </>
          )}
          {client.phone && (
            <>
              <strong>Phone:</strong> {client.phone}
            </>
          )}
        </InfoBox>

        <FormContainer>
          <FormField>
            <Label htmlFor="appointment-treatment">
              Treatment <span style={{ color: "#ef4444" }}>*</span>
            </Label>
            <Select
              id="appointment-treatment"
              value={appointmentData.treatment}
              onChange={(e) =>
                setAppointmentData((prev) => ({
                  ...prev,
                  treatment: e.target.value,
                }))
              }
            >
              <option value="">Select a treatment</option>
              {availableTreatments.map((treatment) => (
                <option key={treatment.id} value={treatment.id}>
                  {treatment.name} ({treatment.durationMinutes} min - $
                  {treatment.price})
                </option>
              ))}
            </Select>
          </FormField>

          <DateTimeGrid>
            <FormField>
              <Label htmlFor="appointment-date">
                Date <span style={{ color: "#ef4444" }}>*</span>
              </Label>
              <Input
                type="date"
                id="appointment-date"
                value={appointmentData.date}
                onChange={(e) =>
                  setAppointmentData((prev) => ({
                    ...prev,
                    date: e.target.value,
                  }))
                }
                min={minDate}
              />
            </FormField>

            <FormField>
              <Label htmlFor="appointment-time">
                Time <span style={{ color: "#ef4444" }}>*</span>
              </Label>
              <Select
                id="appointment-time"
                value={appointmentData.time}
                onChange={(e) =>
                  setAppointmentData((prev) => ({
                    ...prev,
                    time: e.target.value,
                  }))
                }
              >
                <option value="">Select time</option>
                {timeSlots.map((slot) => (
                  <option key={slot} value={slot}>
                    {slot}
                  </option>
                ))}
              </Select>
            </FormField>
          </DateTimeGrid>

          <FormField>
            <Label htmlFor="appointment-staff">Staff (Optional)</Label>
            <Select
              id="appointment-staff"
              value={appointmentData.staff}
              onChange={(e) =>
                setAppointmentData((prev) => ({
                  ...prev,
                  staff: e.target.value,
                }))
              }
            >
              <option value="">Any available staff</option>
              {staff.map((s) => (
                <option key={s.id} value={s.id}>
                  {s.name} - {s.role}
                </option>
              ))}
            </Select>
          </FormField>

          <FormField>
            <Label htmlFor="appointment-notes">Notes (Optional)</Label>
            <Input
              type="text"
              id="appointment-notes"
              value={appointmentData.notes}
              onChange={(e) =>
                setAppointmentData((prev) => ({
                  ...prev,
                  notes: e.target.value,
                }))
              }
              placeholder="Any special requests or preferences..."
            />
          </FormField>

          <ModalActions>
            <Button
              variation="secondary"
              onClick={handleCloseAppointmentModal}
              style={{ flex: 1, justifyContent: "center" }}
            >
              Cancel
            </Button>
            <Button
              variation="primary"
              onClick={handleAppointmentSubmit}
              disabled={bookingAppointment}
              style={{ flex: 1, justifyContent: "center" }}
            >
              <Calendar size={18} />
              {bookingAppointment ? "Booking..." : "Book Appointment"}
            </Button>
          </ModalActions>
        </FormContainer>
      </Modal>
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\StaffAssignment.tsx
================================================================================

import React, { useState, useMemo } from "react";
import styled from "styled-components";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import {
  User,
  Search,
  Check,
  AlertCircle,
  ArrowRight,
  ArrowLeft,
} from "lucide-react";
import type { CartItem } from "./api";

interface Staff {
  id: string;
  name: string;
  role: string;
  specialties?: string[];
  available: boolean;
}

interface Step3StaffAssignmentProps {
  cart: CartItem[];
  staff: Staff[];
  onAssignStaff: (
    itemId: string,
    itemType: string,
    staffId: string,
    staffName: string
  ) => void;
  onNext: () => void;
  onBack: () => void;
}

const Container = styled.div`
  display: grid;
  gap: 2rem;
  max-width: 1000px;
  margin: 0 auto;
`;

const Title = styled.h2`
  font-size: 1.75rem;
  font-weight: 800;
  color: ${({ theme }) => theme.color.text};
  margin: 0 0 0.5rem 0;
`;

const Subtitle = styled.p`
  font-size: 1rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin: 0;
`;

const TreatmentsList = styled.div`
  display: grid;
  gap: 1.5rem;
`;

const TreatmentCard = styled.div<{ $assigned: boolean }>`
  padding: 1.5rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 2px solid
    ${({ $assigned, theme }) =>
      $assigned ? theme.color.green500 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.lg};
  transition: all 0.2s;
`;

const TreatmentHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
`;

const TreatmentInfo = styled.div`
  flex: 1;
`;

const TreatmentName = styled.div`
  font-weight: 700;
  font-size: 1.125rem;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 0.375rem;
`;

const TreatmentMeta = styled.div`
  font-size: 0.875rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const StatusBadge = styled.div<{ $assigned: boolean }>`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: ${({ $assigned, theme }) =>
    $assigned ? theme.color.green500 + "30" : theme.color.red500 + "30"};
  color: ${({ $assigned, theme }) =>
    $assigned ? theme.color.green500 : theme.color.red500};
  border-radius: ${({ theme }) => theme.radii.round};
  font-size: 0.875rem;
  font-weight: 700;
`;

const AssignedStaff = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.brand50};
  border: 1px solid ${({ theme }) => theme.color.brand200};
  border-radius: ${({ theme }) => theme.radii.md};
  margin-bottom: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
`;

const StaffInfo = styled.div``;

const StaffLabel = styled.div`
  font-size: 0.75rem;
  color: ${({ theme }) => theme.color.mutedText};
  margin-bottom: 0.25rem;
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.05em;
`;

const StaffName = styled.div`
  font-size: 1rem;
  font-weight: 700;
  color: ${({ theme }) => theme.color.text};
`;

const SearchBar = styled.div`
  position: relative;
  margin-bottom: 1rem;
`;

const SearchIcon = styled.div`
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: ${({ theme }) => theme.color.mutedText};
  pointer-events: none;
`;

const StaffGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  max-height: 300px;
  overflow-y: auto;

  @media (max-width: 768px) {
    grid-template-columns: repeat(2, 1fr);
  }
`;

const StaffCard = styled.button<{ $selected: boolean; $disabled: boolean }>`
  padding: 1.25rem;
  background: ${({ $selected, theme }) =>
    $selected ? theme.color.brand500 : theme.color.panel};
  color: ${({ $selected, theme }) =>
    $selected ? "#ffffff" : theme.color.text};
  border: 2px solid
    ${({ $selected, theme }) =>
      $selected ? theme.color.brand600 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
  cursor: ${({ $disabled }) => ($disabled ? "not-allowed" : "pointer")};
  opacity: ${({ $disabled }) => ($disabled ? 0.5 : 1)};
  transition: all 0.2s;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;

  &:hover:not(:disabled) {
    transform: ${({ $selected }) => ($selected ? "none" : "translateY(-2px)")};
    border-color: ${({ theme }) => theme.color.brand500};
    background: ${({ $selected, theme }) =>
      $selected ? theme.color.brand600 : theme.color.brand50};
  }
`;

const StaffCardName = styled.div`
  font-weight: 700;
  font-size: 0.9375rem;
`;

const StaffCardRole = styled.div`
  font-size: 0.8125rem;
  opacity: 0.85;
`;

const AvailabilityBadge = styled.div<{ $available: boolean }>`
  padding: 0.25rem 0.625rem;
  background: ${({ $available }) => ($available ? "#34d39930" : "#6b728030")};
  color: ${({ $available }) => ($available ? "#34d399" : "#6b7280")};
  border-radius: 999px;
  font-size: 0.6875rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-top: 0.25rem;
`;

const EmptyState = styled.div`
  text-align: center;
  padding: 3rem 1rem;
  color: ${({ theme }) => theme.color.mutedText};
  grid-column: 1 / -1;
`;

const Actions = styled.div`
  display: flex;
  gap: 1rem;
  padding-top: 1rem;
`;

export default function Step3StaffAssignment({
  cart,
  staff,
  onAssignStaff,
  onNext,
  onBack,
}: Step3StaffAssignmentProps) {
  const [expandedTreatment, setExpandedTreatment] = useState<string | null>(
    null
  );
  const [searchQuery, setSearchQuery] = useState("");

  // Filter treatments only (not products)
  const treatments = useMemo(
    () =>
      cart.filter(
        (item) => item.type === "treatment" || item.type === "appointment"
      ),
    [cart]
  );

  // Check if all treatments have staff
  const allAssigned = useMemo(
    () => treatments.every((item) => item.staffId),
    [treatments]
  );

  // Filter staff
  const filteredStaff = useMemo(() => {
    if (!searchQuery.trim()) return staff;
    const query = searchQuery.toLowerCase();
    return staff.filter(
      (s) =>
        s.name.toLowerCase().includes(query) ||
        s.role.toLowerCase().includes(query) ||
        s.specialties?.some((spec) => spec.toLowerCase().includes(query))
    );
  }, [staff, searchQuery]);

  const handleSelectStaff = (item: CartItem, staffMember: Staff) => {
    onAssignStaff(item.id, item.type, staffMember.id, staffMember.name);
    setExpandedTreatment(null);
    setSearchQuery("");
  };

  return (
    <Container>
      <div>
        <Title>Assign Staff Members</Title>
        <Subtitle>
          Assign a therapist to each treatment before proceeding to checkout
        </Subtitle>
      </div>

      <TreatmentsList>
        {treatments.map((item) => {
          const key = `${item.id}-${item.type}`;
          const isExpanded = expandedTreatment === key;
          const isAssigned = !!item.staffId;

          return (
            <TreatmentCard key={key} $assigned={isAssigned}>
              <TreatmentHeader>
                <TreatmentInfo>
                  <TreatmentName>{item.name}</TreatmentName>
                  <TreatmentMeta>
                    {item.clientName && `Client: ${item.clientName}`}
                    {item.duration && `  ${item.duration} min`}
                  </TreatmentMeta>
                </TreatmentInfo>
                <StatusBadge $assigned={isAssigned}>
                  {isAssigned ? (
                    <>
                      <Check size={16} />
                      Assigned
                    </>
                  ) : (
                    <>
                      <AlertCircle size={16} />
                      Not Assigned
                    </>
                  )}
                </StatusBadge>
              </TreatmentHeader>

              {/* Show assigned staff */}
              {isAssigned && !isExpanded && (
                <AssignedStaff>
                  <StaffInfo>
                    <StaffLabel>Assigned Therapist</StaffLabel>
                    <StaffName>{item.staffName}</StaffName>
                  </StaffInfo>
                  <Button
                    variation="secondary"
                    size="small"
                    onClick={() => setExpandedTreatment(key)}
                  >
                    Change
                  </Button>
                </AssignedStaff>
              )}

              {/* Assign/Change button */}
              {!isExpanded && !isAssigned && (
                <Button
                  variation="primary"
                  onClick={() => setExpandedTreatment(key)}
                  style={{ width: "100%", justifyContent: "center" }}
                >
                  Assign Therapist
                </Button>
              )}

              {/* Staff selection */}
              {isExpanded && (
                <>
                  <SearchBar>
                    <SearchIcon>
                      <Search size={18} />
                    </SearchIcon>
                    <Input
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="Search staff..."
                      style={{ paddingLeft: "2.75rem" }}
                      autoFocus
                    />
                  </SearchBar>

                  <StaffGrid>
                    {filteredStaff.length === 0 ? (
                      <EmptyState>
                        <User
                          size={40}
                          style={{ margin: "0 auto 0.5rem", opacity: 0.3 }}
                        />
                        <p style={{ margin: 0, fontSize: "0.875rem" }}>
                          No staff found
                        </p>
                      </EmptyState>
                    ) : (
                      filteredStaff.map((staffMember) => (
                        <StaffCard
                          key={staffMember.id}
                          type="button"
                          $selected={item.staffId === staffMember.id}
                          $disabled={!staffMember.available}
                          disabled={!staffMember.available}
                          onClick={() => handleSelectStaff(item, staffMember)}
                        >
                          <StaffCardName>{staffMember.name}</StaffCardName>
                          <StaffCardRole>{staffMember.role}</StaffCardRole>
                          <AvailabilityBadge $available={staffMember.available}>
                            {staffMember.available
                              ? "Available"
                              : "Unavailable"}
                          </AvailabilityBadge>
                        </StaffCard>
                      ))
                    )}
                  </StaffGrid>

                  <Button
                    variation="secondary"
                    onClick={() => {
                      setExpandedTreatment(null);
                      setSearchQuery("");
                    }}
                    size="small"
                    style={{
                      width: "100%",
                      justifyContent: "center",
                      marginTop: "0.5rem",
                    }}
                  >
                    Cancel
                  </Button>
                </>
              )}
            </TreatmentCard>
          );
        })}
      </TreatmentsList>

      <Actions>
        <Button
          variation="secondary"
          icon={<ArrowLeft size={18} />}
          onClick={onBack}
          style={{ flex: 1, justifyContent: "center", padding: "1rem" }}
        >
          Back
        </Button>
        <Button
          variation="primary"
          icon={<ArrowRight size={18} />}
          onClick={onNext}
          disabled={!allAssigned}
          style={{ flex: 1, justifyContent: "center", padding: "1rem" }}
        >
          {allAssigned ? "Continue to Payment" : "Assign All Staff First"}
        </Button>
      </Actions>
    </Container>
  );
}


================================================================================
FILE: ./frontend/src/modules/POS\StaffAssignmentModal.tsx
================================================================================

import React, { useState, useMemo } from "react";
import Modal from "../../ui/components/Modal";
import Button from "../../ui/components/Button";
import Input from "../../ui/components/Input";
import styled from "styled-components";
import { User, Search, Check, AlertCircle } from "lucide-react";
import type { CartItem } from "./api";

interface Staff {
  id: string;
  name: string;
  role: string;
  specialties?: string[];
  available: boolean;
}

interface StaffAssignmentModalProps {
  isOpen: boolean;
  onClose: () => void;
  cartItems: CartItem[];
  staff: Staff[];
  onAssignStaff: (
    itemId: string,
    itemType: string,
    staffId: string,
    staffName: string
  ) => void;
}

const Content = styled.div`
  display: grid;
  gap: 1.5rem;
`;

const TreatmentsList = styled.div`
  display: grid;
  gap: 1rem;
`;

const TreatmentCard = styled.div`
  padding: 1rem;
  background: ${({ theme }) => theme.color.grey100};
  border: 1px solid ${({ theme }) => theme.color.border};
  border-radius: ${({ theme }) => theme.radii.md};
`;

const TreatmentHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
`;

const TreatmentInfo = styled.div`
  flex: 1;
`;

const TreatmentName = styled.div`
  font-weight: 700;
  font-size: 0.9375rem;
  color: ${({ theme }) => theme.color.text};
  margin-bottom: 0.25rem;
`;

const TreatmentClient = styled.div`
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const StaffStatus = styled.div<{ $assigned: boolean }>`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.375rem 0.75rem;
  background: ${({ $assigned, theme }) =>
    $assigned ? theme.color.green500 + "30" : theme.color.red500 + "30"};
  color: ${({ $assigned, theme }) =>
    $assigned ? theme.color.green500 : theme.color.red500};
  border-radius: ${({ theme }) => theme.radii.round};
  font-size: 0.75rem;
  font-weight: 700;
`;

const SearchBar = styled.div`
  position: relative;
  margin-top: 0.75rem;
`;

const SearchIcon = styled.div`
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: ${({ theme }) => theme.color.mutedText};
  pointer-events: none;
`;

const StaffList = styled.div`
  max-height: 300px;
  overflow-y: auto;
  display: grid;
  gap: 0.5rem;
  margin-top: 0.75rem;
`;

const StaffCard = styled.button<{ $selected: boolean; $disabled: boolean }>`
  padding: 0.875rem;
  background: ${({ $selected, theme }) =>
    $selected ? theme.color.brand500 : theme.color.panel};
  color: ${({ $selected, theme }) =>
    $selected ? "#ffffff" : theme.color.text};
  border: 1px solid
    ${({ $selected, theme }) =>
      $selected ? theme.color.brand600 : theme.color.border};
  border-radius: ${({ theme }) => theme.radii.sm};
  cursor: ${({ $disabled }) => ($disabled ? "not-allowed" : "pointer")};
  opacity: ${({ $disabled }) => ($disabled ? 0.5 : 1)};
  transition: all 0.2s;
  text-align: left;
  display: flex;
  justify-content: space-between;
  align-items: center;

  &:hover:not(:disabled) {
    border-color: ${({ theme }) => theme.color.brand500};
    background: ${({ $selected, theme }) =>
      $selected ? theme.color.brand600 : theme.color.brand50};
  }
`;

const StaffInfo = styled.div``;

const StaffName = styled.div`
  font-weight: 700;
  font-size: 0.875rem;
  margin-bottom: 0.125rem;
`;

const StaffRole = styled.div`
  font-size: 0.75rem;
  opacity: 0.8;
`;

const AvailabilityBadge = styled.div<{ $available: boolean }>`
  padding: 0.25rem 0.625rem;
  background: ${({ $available, theme }) =>
    $available ? theme.color.green500 + "30" : theme.color.grey300};
  color: ${({ $available, theme }) =>
    $available ? theme.color.green500 : theme.color.mutedText};
  border-radius: ${({ theme }) => theme.radii.round};
  font-size: 0.6875rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
`;

const EmptyState = styled.div`
  text-align: center;
  padding: 2rem 1rem;
  color: ${({ theme }) => theme.color.mutedText};
`;

const Warning = styled.div`
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 1rem;
  background: ${({ theme }) => theme.color.yellow100};
  border: 1px solid ${({ theme }) => theme.color.yellow700};
  border-radius: ${({ theme }) => theme.radii.md};
  font-size: 0.8125rem;
  color: ${({ theme }) => theme.color.grey900};
`;

const Actions = styled.div`
  display: flex;
  gap: 0.75rem;
  padding-top: 0.5rem;
`;

export default function StaffAssignmentModal({
  isOpen,
  onClose,
  cartItems,
  staff,
  onAssignStaff,
}: StaffAssignmentModalProps) {
  const [expandedItem, setExpandedItem] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState("");
  const [tempAssignments, setTempAssignments] = useState<
    Record<string, { staffId: string; staffName: string }>
  >({});

  // Get treatments from cart (not products)
  const treatments = useMemo(
    () =>
      cartItems.filter(
        (item) => item.type === "treatment" || item.type === "appointment"
      ),
    [cartItems]
  );

  // Check if all treatments have staff assigned
  const allAssigned = useMemo(() => {
    return treatments.every((item) => {
      const key = `${item.id}-${item.type}`;
      return item.staffId || tempAssignments[key];
    });
  }, [treatments, tempAssignments]);

  // Filter staff
  const filteredStaff = useMemo(() => {
    if (!searchQuery.trim()) return staff;
    const query = searchQuery.toLowerCase();
    return staff.filter(
      (s) =>
        s.name.toLowerCase().includes(query) ||
        s.role.toLowerCase().includes(query) ||
        s.specialties?.some((spec) => spec.toLowerCase().includes(query))
    );
  }, [staff, searchQuery]);

  const handleSelectStaff = (
    itemId: string,
    itemType: string,
    staffId: string,
    staffName: string
  ) => {
    const key = `${itemId}-${itemType}`;
    setTempAssignments((prev) => ({
      ...prev,
      [key]: { staffId, staffName },
    }));
    setExpandedItem(null);
    setSearchQuery("");
  };

  const handleSaveAndContinue = () => {
    // Apply all temp assignments
    Object.entries(tempAssignments).forEach(([key, assignment]) => {
      const [itemId, itemType] = key.split("-");
      onAssignStaff(itemId, itemType, assignment.staffId, assignment.staffName);
    });
    onClose();
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title="Assign Staff Members"
      size="lg"
      ariaLabel="Assign staff to treatments"
    >
      <Content>
        {/* Warning if no treatments */}
        {treatments.length === 0 && (
          <Warning>
            <AlertCircle size={20} />
            <div>
              <strong>No treatments in cart</strong>
              <br />
              Staff assignment is only required for treatments and appointments,
              not retail products.
            </div>
          </Warning>
        )}

        {/* Treatment List */}
        <TreatmentsList>
          {treatments.map((item) => {
            const key = `${item.id}-${item.type}`;
            const assignedStaff = item.staffId || tempAssignments[key]?.staffId;
            const staffName = item.staffName || tempAssignments[key]?.staffName;
            const isExpanded = expandedItem === key;

            return (
              <TreatmentCard key={key}>
                <TreatmentHeader>
                  <TreatmentInfo>
                    <TreatmentName>{item.name}</TreatmentName>
                    {item.clientName && (
                      <TreatmentClient>{item.clientName}</TreatmentClient>
                    )}
                    {staffName && (
                      <div
                        style={{
                          marginTop: "0.5rem",
                          fontSize: "0.8125rem",
                          fontWeight: 600,
                        }}
                      >
                        Therapist: {staffName}
                      </div>
                    )}
                  </TreatmentInfo>
                  <StaffStatus $assigned={!!assignedStaff}>
                    {assignedStaff ? (
                      <>
                        <Check size={14} />
                        Assigned
                      </>
                    ) : (
                      <>
                        <AlertCircle size={14} />
                        Not Assigned
                      </>
                    )}
                  </StaffStatus>
                </TreatmentHeader>

                {/* Staff Selection */}
                {!isExpanded && (
                  <Button
                    variation="secondary"
                    onClick={() => setExpandedItem(key)}
                    size="small"
                    style={{ width: "100%", justifyContent: "center" }}
                  >
                    {assignedStaff ? "Change Therapist" : "Assign Therapist"}
                  </Button>
                )}

                {isExpanded && (
                  <>
                    <SearchBar>
                      <SearchIcon>
                        <Search size={18} />
                      </SearchIcon>
                      <Input
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Search staff..."
                        style={{ paddingLeft: "2.5rem", fontSize: "0.875rem" }}
                        autoFocus
                      />
                    </SearchBar>

                    <StaffList>
                      {filteredStaff.length === 0 ? (
                        <EmptyState>
                          <User
                            size={40}
                            style={{ margin: "0 auto 0.5rem", opacity: 0.3 }}
                          />
                          <p style={{ margin: 0, fontSize: "0.8125rem" }}>
                            No staff members found
                          </p>
                        </EmptyState>
                      ) : (
                        filteredStaff.map((staffMember) => (
                          <StaffCard
                            key={staffMember.id}
                            type="button"
                            $selected={assignedStaff === staffMember.id}
                            $disabled={!staffMember.available}
                            disabled={!staffMember.available}
                            onClick={() =>
                              handleSelectStaff(
                                item.id,
                                item.type,
                                staffMember.id,
                                staffMember.name
                              )
                            }
                          >
                            <StaffInfo>
                              <StaffName>{staffMember.name}</StaffName>
                              <StaffRole>{staffMember.role}</StaffRole>
                            </StaffInfo>
                            <AvailabilityBadge
                              $available={staffMember.available}
                            >
                              {staffMember.available
                                ? "Available"
                                : "Unavailable"}
                            </AvailabilityBadge>
                          </StaffCard>
                        ))
                      )}
                    </StaffList>

                    <Button
                      variation="secondary"
                      onClick={() => {
                        setExpandedItem(null);
                        setSearchQuery("");
                      }}
                      size="small"
                      style={{
                        width: "100%",
                        justifyContent: "center",
                        marginTop: "0.5rem",
                      }}
                    >
                      Cancel
                    </Button>
                  </>
                )}
              </TreatmentCard>
            );
          })}
        </TreatmentsList>

        {/* Actions */}
        {treatments.length > 0 && (
          <Actions>
            <Button
              variation="secondary"
              onClick={onClose}
              style={{ flex: 1, justifyContent: "center" }}
            >
              Cancel
            </Button>
            <Button
              variation="primary"
              onClick={handleSaveAndContinue}
              disabled={!allAssigned}
              style={{ flex: 1, justifyContent: "center" }}
            >
              {allAssigned ? "Continue to Checkout" : "Assign All First"}
            </Button>
          </Actions>
        )}
      </Content>
    </Modal>
  );
}
